<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">





  <link rel="alternate" href="/atom.xml" title="吴晓龙" type="application/atom+xml">






<meta name="description" content="耐得住寂寞 守得住繁华">
<meta property="og:type" content="website">
<meta property="og:title" content="吴晓龙">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="吴晓龙">
<meta property="og:description" content="耐得住寂寞 守得住繁华">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="吴晓龙">
<meta name="twitter:description" content="耐得住寂寞 守得住繁华">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/">





  <title>吴晓龙</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">吴晓龙</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">爱吃哈密瓜的程序员</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-search">
          <a href="/search" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            搜索
          </a>
        </li>
      
        
        <li class="menu-item menu-item-schedule">
          <a href="/schedule" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            日程表
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            站点地图
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/commonweal" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            公益404
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/26/双向链表/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="吴晓龙">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://opq81riyh.bkt.clouddn.com/666.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="吴晓龙">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/26/双向链表/" itemprop="url">双向链表</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-26T16:09:01+08:00">
                2018-02-26
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 双向链表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;T&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DoubleLink</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">//表头</span></span><br><span class="line">    <span class="keyword">private</span> DNode&lt;T&gt; mHead;</span><br><span class="line">    <span class="comment">//节点个数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mCount;</span><br><span class="line">    <span class="comment">//双向链表"节点"对应的结构体</span></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">DNode</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> DNode prev;</span><br><span class="line">        <span class="keyword">public</span> DNode next;</span><br><span class="line">        <span class="keyword">public</span> T value;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DNode</span><span class="params">(T value, DNode prev, DNode next)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.value = value;</span><br><span class="line">            <span class="keyword">this</span>.prev = prev;</span><br><span class="line">            <span class="keyword">this</span>.next = next;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DoubleLink</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//创建表头，表头没有存储数据</span></span><br><span class="line">        mHead = <span class="keyword">new</span> DNode&lt;T&gt;(<span class="keyword">null</span>,<span class="keyword">null</span>,<span class="keyword">null</span>);</span><br><span class="line">        mHead.prev = mHead.next = mHead;</span><br><span class="line">        mCount = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//返回节点数目</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mCount;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//返回链表是否为空</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isEmpty</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mCount == <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//获取第index位置的节点</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> DNode&lt;T&gt; <span class="title">getNode</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (index &lt; <span class="number">0</span> || index &gt;= mCount) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IndexOutOfBoundsException();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//正向查找</span></span><br><span class="line">        <span class="keyword">if</span> (index &lt;= mCount / <span class="number">2</span>)&#123;</span><br><span class="line">            DNode&lt;T&gt; node = mHead.next;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; index; i++) &#123;</span><br><span class="line">                node = node.next;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> node;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//反向查找</span></span><br><span class="line">        DNode&lt;T&gt; rnode = mHead.prev;</span><br><span class="line">        <span class="keyword">int</span> rindex = mCount - index - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; rindex; i++) &#123;</span><br><span class="line">            rnode = rnode.prev;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> rnode;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//获取index位置的节点的值</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">get</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getNode(index).value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取第一个节点的值</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">getFirst</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getNode(<span class="number">0</span>).value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//获取最后一个节点的值</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">getLast</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getNode(mCount - <span class="number">1</span>).value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//将节点插入到第index位置之前</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insert</span><span class="params">(<span class="keyword">int</span> index, T t)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (index == <span class="number">0</span>)&#123;</span><br><span class="line">            DNode&lt;T&gt; dNode = <span class="keyword">new</span> DNode&lt;&gt;(t, mHead, mHead.next);</span><br><span class="line">            mHead.next.prev = dNode;</span><br><span class="line">            mHead.next = dNode;</span><br><span class="line">            mCount++;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//先获取到当前位置的节点</span></span><br><span class="line">        DNode&lt;T&gt; inode = getNode(index);</span><br><span class="line">        <span class="comment">//创建这个节点，这个节点之后是当前位置的节点，这个节点之前是当前位置节点之前的节点</span></span><br><span class="line">        DNode&lt;T&gt; tNode = <span class="keyword">new</span> DNode&lt;&gt;(t, inode.prev, inode);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//以下两步是因为是双向链表，所以要两边都指定</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//将当前位置的节点的上一个节点的next指向要插入的节点</span></span><br><span class="line">        inode.prev.next = tNode;</span><br><span class="line">        <span class="comment">//将当前位置的节点的下一个节点指向要插入的节点</span></span><br><span class="line">        inode.next = tNode;</span><br><span class="line">        mCount++;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//将节点插入第一个 节点处</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertFirst</span><span class="params">(T t)</span></span>&#123;</span><br><span class="line">        insert(<span class="number">0</span>,t);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//将节点追加到链表的末尾</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">appendLast</span><span class="params">(T t)</span></span>&#123;</span><br><span class="line">        DNode&lt;T&gt; tNode = <span class="keyword">new</span> DNode&lt;&gt;(t, mHead.prev, mHead);</span><br><span class="line">        mHead.prev.next = tNode;</span><br><span class="line">        mHead.prev = tNode;</span><br><span class="line">        mCount++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//删除index位置的节点</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">del</span><span class="params">(<span class="keyword">int</span> index)</span></span>&#123;</span><br><span class="line">        DNode&lt;T&gt; node = getNode(index);</span><br><span class="line">        node.prev.next = node.next;</span><br><span class="line">        node.next.prev = node.prev;</span><br><span class="line">        node = <span class="keyword">null</span>;</span><br><span class="line">        mCount--;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//删除第一个节点</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteFirst</span><span class="params">()</span></span>&#123;</span><br><span class="line">        del(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteLast</span><span class="params">()</span></span>&#123;</span><br><span class="line">        del(mCount - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/13/自我介绍/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="吴晓龙">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://opq81riyh.bkt.clouddn.com/666.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="吴晓龙">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/13/自我介绍/" itemprop="url">自我介绍</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-13T23:54:24+08:00">
                2018-02-13
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/个人/" itemprop="url" rel="index">
                    <span itemprop="name">个人</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>1.什么样的异性不考虑：</p>
<blockquote>
<ul>
<li>异性朋友多,常跟异性玩的</li>
<li>公主病，嘴比较恶毒的</li>
<li>夜不归宿</li>
<li>无诚信，承诺过的不去兑现</li>
<li>只享受被追的过程，不会付出不给反馈</li>
</ul>
</blockquote>
<p>2.我是什么样的人：</p>
<blockquote>
<ul>
<li>我可以坐十几个小时去跟朋友吃顿饭，然后回来上班，因为我认为值得</li>
<li>在不熟悉的人面前我话少，尤其女生面前我没有话题可说，熟人面前我特别逗比，喜欢开玩笑说段子，基本无拘束</li>
<li>我重视诚信，即使花费代价也要兑现</li>
<li>不喜欢争斗，好静，但也喜欢爬山，和熟人聚会</li>
</ul>
</blockquote>
<p>3.我的生活习惯：</p>
<blockquote>
<ul>
<li>喜欢旅游，港澳台、云南、成都、重庆、浙江、江苏、山东、河南、甘肃、山西、贵州等都去玩过，这方面我比较擅长</li>
<li>喜欢吃，有时候出去旅游就是为了尝尝各地的美食小吃，而且超级喜欢吃水果，特别是哈密瓜，经常去海底捞就是为了吃他们的哈密瓜</li>
<li>以前喜欢看电视剧，都市、古装、韩剧都看，特别喜欢越狱，因为他我喜欢上工程师，所以我现在也是一名工程师了，只是现在工作了，所以很少抽出时间看，放假的时候还会看</li>
<li>我比较挑食，吃饭经常会剩饭，所以不喜欢去别人家做客</li>
</ul>
</blockquote>
<p>4.我的兴趣爱好：</p>
<blockquote>
<ul>
<li>羽毛球、网球、足球、篮球我都在大学学过，但也就是很业余的水平</li>
<li>爬山，爬过泰山、华山，希望以后有机会去爬更多的山</li>
<li>爱看博客，技术类的喜欢上掘金和csdn，也会订阅微信公众号看。</li>
<li>喜欢听粤语歌曲，比如杨千嬅、谢安琪等等</li>
</ul>
</blockquote>
<p>5.理想异性：</p>
<blockquote>
<ul>
<li>有信念，能一起走完下半生</li>
<li>遇上挫折和问题能商量想办法，不会气急败坏</li>
<li>对于别人的付出能有反馈，不是一味接受</li>
<li>生活习惯好，能做到自律</li>
</ul>
</blockquote>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/08/java面试题一/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="吴晓龙">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://opq81riyh.bkt.clouddn.com/666.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="吴晓龙">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/08/java面试题一/" itemprop="url">java面试题一</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-08T22:34:38+08:00">
                2018-02-08
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java面试/" itemprop="url" rel="index">
                    <span itemprop="name">java面试</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="java面试题一"><a href="#java面试题一" class="headerlink" title="java面试题一"></a>java面试题一</h1><hr>
<p>###来看一道面试题，大家看看结果是多少？<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> x = <span class="number">5</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> x ,y;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        x--;</span><br><span class="line">        myMethod();</span><br><span class="line">        System.out.println(x + y++ + x);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">myMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        y = x++ + ++x;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="先不要看答案"><a href="#先不要看答案" class="headerlink" title="先不要看答案"></a>先不要看答案</h3><p>分析过程，static代码块中的是局部变量，所以是下x，y都是0；<br>main方法中x–后，执行mythod，此时x是-1，<br>执行x++后x++仍然是-1，然后此时x是0，再执行++x，那么++x是1，<br>那么y= -1+1=0；<br>于是x是1，y是0；<br>那么system.out.println中是1+0+1=2；<br>最终结果是2.</p>
<p>这道题很常见，却也很容易做错，大家体会考到的知识点。</p>
<p>不同的类加载器分别创建的同一个类的字节码数据属于完全不同的对象，没有任何关联。<br>当运行一个程序的时候，jvm启动，运行bootstrap classloader，该classloader加载java核心api（extclassloader和appclassloader也在此时被加载），然后调用extclassloader加载扩展api，最后appclassloader加载classpath目录下定义的class，这就是一个程序最基本的加载流程。<br>类加载过程使用父类委托模式，这样有三个原因：</p>
<ol>
<li>这样可以避免重复加载。</li>
<li>安全因素，防止加载自定义的classloader</li>
<li>一些重要的方法</li>
</ol>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/07/反思自己身上的毛病/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="吴晓龙">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://opq81riyh.bkt.clouddn.com/666.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="吴晓龙">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/07/反思自己身上的毛病/" itemprop="url">反思自己身上的毛病</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-07T10:40:10+08:00">
                2018-02-07
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/反思/" itemprop="url" rel="index">
                    <span itemprop="name">反思</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="反思自己身上的毛病"><a href="#反思自己身上的毛病" class="headerlink" title="反思自己身上的毛病"></a>反思自己身上的毛病</h1><hr>
<p>数据结构和算法一知半解，一个平常的排序和合并都手写不出来，讲到源码也是停留于皮毛，view的事件分发这种东西，也能讲个人云亦云，究其根源，说不上来。android中有很多framwork层的东西，都没有好好去看，平常工作不努力，机会来了总是抓不住。每天都期盼明天开始努力，却总是明日复明日。<br>jvm被问到就是一头雾水，锁也不知道，多线程不熟悉，新事物出现不去学习，心思总不在工作和学习上，还老爱装逼。。。。<br>  真的，人不反思不知道自己有多可恶，什么都不会还不去学习，静不下心，每天都是悔恨自己不努力，却又不停浪费时间。看了其他人的博客，才知道自己有多懒惰，只接受填鸭式的知识，很少去举一反三，问问为什么这样。</p>
<p>  感觉这几天真的在经历价值观的重建。希望前30年努力，不要在后30年后悔。</p>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/05/Android面试题（美团、猎户星空、作业帮）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="吴晓龙">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://opq81riyh.bkt.clouddn.com/666.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="吴晓龙">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/05/Android面试题（美团、猎户星空、作业帮）/" itemprop="url">Android面试题（美团、猎户星空、作业帮）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-05T11:32:34+08:00">
                2018-02-05
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/面试题/" itemprop="url" rel="index">
                    <span itemprop="name">面试题</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Android面试题（美团、猎户星空、作业帮）"><a href="#Android面试题（美团、猎户星空、作业帮）" class="headerlink" title="Android面试题（美团、猎户星空、作业帮）"></a>Android面试题（美团、猎户星空、作业帮）</h1><hr>
<h3 id="美团"><a href="#美团" class="headerlink" title="美团"></a>美团</h3><blockquote>
<ul>
<li>JsBrige原理</li>
<li>多线程</li>
<li>锁</li>
<li>AsyncTask中Handler</li>
<li>算法</li>
<li>链表反转</li>
<li>两个有序链表合并</li>
<li>单例模式优缺点（懒加载）</li>
<li>工厂模式</li>
<li>mvp，mvc深入了解</li>
<li>项目架构（画图）</li>
<li>Handler机制</li>
<li>RecyclerView的缓存机制（四层），与listview相比有什么优点</li>
<li>内存泄漏如果不是activity，是其他对象怎么查找</li>
<li>性能优化</li>
<li>开源库原理</li>
<li>HashMap和HashSet区别，原理</li>
<li>JVM内存模型</li>
<li>进程和线程的区别</li>
<li>volatile能做什么，不能做什么，怎么实现的？</li>
<li>syncronized中notify在什么时候执行</li>
<li>equals,hashcode方法</li>
<li>leakcanary什么时候回收对象</li>
<li>recylerview布局管理器原理</li>
</ul>
</blockquote>
<p>###猎户星空</p>
<blockquote>
<ul>
<li>类锁与对象锁的区别，请列举各自使用场景</li>
<li>堆区与栈区分别存放什么？除了这两个区还有哪些区？作用是什么？</li>
<li>string是最基本的数据类型吗？可以继承吗？</li>
<li>子线程与主线程通信，除了Handler和AsyncTask，还有什么？</li>
<li>如何生成jar包？jar与aar、module的区别？</li>
<li>http 和https的区别</li>
<li>http轮询与socket长连接的区别？</li>
<li>简述遇到过最难以解决的问题</li>
<li>请用几句话简述插入排序、选择排序、堆排序实现原理</li>
</ul>
</blockquote>
<h3 id="作业帮"><a href="#作业帮" class="headerlink" title="作业帮"></a>作业帮</h3><blockquote>
<ul>
<li>断点续传</li>
<li>http协议（body等）</li>
<li>hashcode  equals</li>
<li>事件分发怎么从phonewindow传递到activity</li>
<li>滑动冲突的变形（下拉刷新怎么在头部消失后交给listview）</li>
<li>值传递与引用传递</li>
<li>binder机制原理（为什么可以跨进程）</li>
<li>动态代理</li>
<li>开源库网络请求原理</li>
<li>hashmap怎么找到链表上的元素</li>
<li>了解的设计模式</li>
<li>framwork层代码</li>
<li>25匹马选出最快的5匹</li>
<li>性能优化</li>
<li>静态内部类和非静态内部类区别</li>
<li>怎么获取另一个apk的资源文件。</li>
</ul>
</blockquote>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/30/HashMap实现原理/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="吴晓龙">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://opq81riyh.bkt.clouddn.com/666.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="吴晓龙">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/30/HashMap实现原理/" itemprop="url">HashMap实现原理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-30T16:32:52+08:00">
                2018-01-30
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java源码解析/" itemprop="url" rel="index">
                    <span itemprop="name">java源码解析</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="HashMap实现原理"><a href="#HashMap实现原理" class="headerlink" title="HashMap实现原理"></a>HashMap实现原理</h1><h2 id="1-HashMap的定义和构造函数"><a href="#1-HashMap的定义和构造函数" class="headerlink" title="1.  HashMap的定义和构造函数"></a>1.  HashMap的定义和构造函数</h2><h3 id="默认初始容量-必须是2的幂"><a href="#默认初始容量-必须是2的幂" class="headerlink" title="默认初始容量-必须是2的幂"></a>默认初始容量-必须是2的幂</h3><h3 id="DEFAULT-INITIAL-CAPACITY-默认的初始容量为16"><a href="#DEFAULT-INITIAL-CAPACITY-默认的初始容量为16" class="headerlink" title="DEFAULT_INITIAL_CAPACITY:默认的初始容量为16"></a>DEFAULT_INITIAL_CAPACITY:默认的初始容量为16</h3><h3 id="这个要注意的是16是eclipse中的jdk，而android-studio中的25版本的java-util包下的厨师容量为4；"><a href="#这个要注意的是16是eclipse中的jdk，而android-studio中的25版本的java-util包下的厨师容量为4；" class="headerlink" title="这个要注意的是16是eclipse中的jdk，而android studio中的25版本的java.util包下的厨师容量为4；"></a>这个要注意的是16是eclipse中的jdk，而android studio中的25版本的java.util包下的厨师容量为4；</h3><p><img src="http://opq81riyh.bkt.clouddn.com/initcability.png" alt=""></p>
<h3 id="如果指定一个更大值"><a href="#如果指定一个更大值" class="headerlink" title="如果指定一个更大值"></a>如果指定一个更大值</h3><h3 id="MAXIMUM-CAPACITY-最大的容量为-2-30"><a href="#MAXIMUM-CAPACITY-最大的容量为-2-30" class="headerlink" title="MAXIMUM_CAPACITY:最大的容量为 2 ^ 30"></a>MAXIMUM_CAPACITY:最大的容量为 2 ^ 30</h3><h3 id="默认的加载因子为-0-75f"><a href="#默认的加载因子为-0-75f" class="headerlink" title="默认的加载因子为 0.75f"></a>默认的加载因子为 0.75f</h3><h3 id="Entry类型的数组，HashMap用这个来维护内部的数据结构，它的长度由容量决定"><a href="#Entry类型的数组，HashMap用这个来维护内部的数据结构，它的长度由容量决定" class="headerlink" title="Entry类型的数组，HashMap用这个来维护内部的数据结构，它的长度由容量决定"></a>Entry类型的数组，HashMap用这个来维护内部的数据结构，它的长度由容量决定</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The default initial capacity - MUST be a power of two.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_INITIAL_CAPACITY = <span class="number">1</span> &lt;&lt; <span class="number">4</span>; <span class="comment">// aka 16</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The maximum capacity, used if a higher value is implicitly specified</span></span><br><span class="line"><span class="comment">     * by either of the constructors with arguments.</span></span><br><span class="line"><span class="comment">     * MUST be a power of two &lt;= 1&lt;&lt;30.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAXIMUM_CAPACITY = <span class="number">1</span> &lt;&lt; <span class="number">30</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The load factor used when none specified in constructor.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">float</span> DEFAULT_LOAD_FACTOR = <span class="number">0.75f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The bin count threshold for using a tree rather than list for a</span></span><br><span class="line"><span class="comment">     * bin.  Bins are converted to trees when adding an element to a</span></span><br><span class="line"><span class="comment">     * bin with at least this many nodes. The value must be greater</span></span><br><span class="line"><span class="comment">     * than 2 and should be at least 8 to mesh with assumptions in</span></span><br><span class="line"><span class="comment">     * tree removal about conversion back to plain bins upon</span></span><br><span class="line"><span class="comment">     * shrinkage.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">     </span><br><span class="line">     </span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The table, initialized on first use, and resized as</span></span><br><span class="line"><span class="comment">     * necessary. When allocated, length is always a power of two.</span></span><br><span class="line"><span class="comment">     * (We also tolerate length zero in some operations to allow</span></span><br><span class="line"><span class="comment">     * bootstrapping mechanics that are currently not needed.)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">transient</span> Node&lt;K,V&gt;[] table;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The number of key-value mappings contained in this map.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">transient</span> <span class="keyword">int</span> size;</span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The next size value at which to resize (capacity * load factor).</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@serial</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// (The javadoc description is true upon serialization.</span></span><br><span class="line">    <span class="comment">// Additionally, if the table array has not been allocated, this</span></span><br><span class="line">    <span class="comment">// field holds the initial array capacity, or zero signifying</span></span><br><span class="line">    <span class="comment">// DEFAULT_INITIAL_CAPACITY.)</span></span><br><span class="line">    <span class="keyword">int</span> threshold;</span><br></pre></td></tr></table></figure>
<h3 id="容量：是哈希表中桶的数量，初始容量只是哈希表在创建时的容量，实际上就是table的容量"><a href="#容量：是哈希表中桶的数量，初始容量只是哈希表在创建时的容量，实际上就是table的容量" class="headerlink" title="容量：是哈希表中桶的数量，初始容量只是哈希表在创建时的容量，实际上就是table的容量"></a>容量：是哈希表中桶的数量，初始容量只是哈希表在创建时的容量，实际上就是table的容量</h3><h3 id="加载因子：是哈希表在其容量自动增加之前可以达到多满的一种尺度。它衡量的是一个散列表的空间的使用程度，负载因子越大表示散列表的装填程度越高，反之越小。对于使用链表法的散列表来说，查找一个元素的平均时间是O（1-a），因此如果负载因子越大，对空间的利用更充分，然后后果是查找效率的降低；如果负载因子太小，那么散列表的数据将过于稀疏，对空间造成严重浪费。系统默认负载因子为0-75，一半情况下我们是无需修改的。"><a href="#加载因子：是哈希表在其容量自动增加之前可以达到多满的一种尺度。它衡量的是一个散列表的空间的使用程度，负载因子越大表示散列表的装填程度越高，反之越小。对于使用链表法的散列表来说，查找一个元素的平均时间是O（1-a），因此如果负载因子越大，对空间的利用更充分，然后后果是查找效率的降低；如果负载因子太小，那么散列表的数据将过于稀疏，对空间造成严重浪费。系统默认负载因子为0-75，一半情况下我们是无需修改的。" class="headerlink" title="加载因子：是哈希表在其容量自动增加之前可以达到多满的一种尺度。它衡量的是一个散列表的空间的使用程度，负载因子越大表示散列表的装填程度越高，反之越小。对于使用链表法的散列表来说，查找一个元素的平均时间是O（1+a），因此如果负载因子越大，对空间的利用更充分，然后后果是查找效率的降低；如果负载因子太小，那么散列表的数据将过于稀疏，对空间造成严重浪费。系统默认负载因子为0.75，一半情况下我们是无需修改的。"></a>加载因子：是哈希表在其容量自动增加之前可以达到多满的一种尺度。它衡量的是一个散列表的空间的使用程度，负载因子越大表示散列表的装填程度越高，反之越小。对于使用链表法的散列表来说，查找一个元素的平均时间是O（1+a），因此如果负载因子越大，对空间的利用更充分，然后后果是查找效率的降低；如果负载因子太小，那么散列表的数据将过于稀疏，对空间造成严重浪费。系统默认负载因子为0.75，一半情况下我们是无需修改的。</h3><h2 id="2-HashMap的数据结构"><a href="#2-HashMap的数据结构" class="headerlink" title="2.  HashMap的数据结构"></a>2.  HashMap的数据结构</h2><h3 id="HashMap是一个“链表散列”，HashMap底层还是数组，只是数组的每一项都是一条链。"><a href="#HashMap是一个“链表散列”，HashMap底层还是数组，只是数组的每一项都是一条链。" class="headerlink" title="HashMap是一个“链表散列”，HashMap底层还是数组，只是数组的每一项都是一条链。"></a>HashMap是一个“链表散列”，HashMap底层还是数组，只是数组的每一项都是一条链。</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity, <span class="keyword">float</span> loadFactor)</span> </span>&#123;</span><br><span class="line">      <span class="comment">//容量不能小于0</span></span><br><span class="line">      <span class="keyword">if</span> (initialCapacity &lt; <span class="number">0</span>)</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Illegal initial capacity: "</span> +</span><br><span class="line">                                             initialCapacity);</span><br><span class="line">      <span class="comment">//容量不能超出最大容量</span></span><br><span class="line">      <span class="keyword">if</span> (initialCapacity &gt; MAXIMUM_CAPACITY)</span><br><span class="line">          initialCapacity = MAXIMUM_CAPACITY;</span><br><span class="line">      <span class="comment">//加载因子不能&lt;0 或者 为非数字</span></span><br><span class="line">      <span class="keyword">if</span> (loadFactor &lt;= <span class="number">0</span> || Float.isNaN(loadFactor))</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Illegal load factor: "</span> +</span><br><span class="line">                                             loadFactor);</span><br><span class="line">      <span class="keyword">this</span>.loadFactor = loadFactor;</span><br><span class="line">      <span class="keyword">this</span>.threshold = tableSizeFor(initialCapacity);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">implements</span> <span class="title">Map</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> hash;</span><br><span class="line">        <span class="keyword">final</span> K key;</span><br><span class="line">        V value;</span><br><span class="line">        Node&lt;K,V&gt; next;</span><br><span class="line"></span><br><span class="line">        Node(<span class="keyword">int</span> hash, K key, V value, Node&lt;K,V&gt; next) &#123;</span><br><span class="line">            <span class="keyword">this</span>.hash = hash;</span><br><span class="line">            <span class="keyword">this</span>.key = key;</span><br><span class="line">            <span class="keyword">this</span>.value = value;</span><br><span class="line">            <span class="keyword">this</span>.next = next;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> K <span class="title">getKey</span><span class="params">()</span>        </span>&#123; <span class="keyword">return</span> key; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> V <span class="title">getValue</span><span class="params">()</span>      </span>&#123; <span class="keyword">return</span> value; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> key + <span class="string">"="</span> + value; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> Objects.hashCode(key) ^ Objects.hashCode(value);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> V <span class="title">setValue</span><span class="params">(V newValue)</span> </span>&#123;</span><br><span class="line">            V oldValue = value;</span><br><span class="line">            value = newValue;</span><br><span class="line">            <span class="keyword">return</span> oldValue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (o == <span class="keyword">this</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (o <span class="keyword">instanceof</span> Map.Entry) &#123;</span><br><span class="line">                Map.Entry&lt;?,?&gt; e = (Map.Entry&lt;?,?&gt;)o;</span><br><span class="line">                <span class="keyword">if</span> (Objects.equals(key, e.getKey()) &amp;&amp;</span><br><span class="line">                    Objects.equals(value, e.getValue()))</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="Node是HashMap的一个内部类，它也是维护着一个key-value映射关系，除了key和value，还有next引用（该引用指向当前table位置的链表），hash值（用来确定每一个Node链表在table中位置）"><a href="#Node是HashMap的一个内部类，它也是维护着一个key-value映射关系，除了key和value，还有next引用（该引用指向当前table位置的链表），hash值（用来确定每一个Node链表在table中位置）" class="headerlink" title="Node是HashMap的一个内部类，它也是维护着一个key-value映射关系，除了key和value，还有next引用（该引用指向当前table位置的链表），hash值（用来确定每一个Node链表在table中位置）"></a>Node是HashMap的一个内部类，它也是维护着一个key-value映射关系，除了key和value，还有next引用（该引用指向当前table位置的链表），hash值（用来确定每一个Node链表在table中位置）</h3><h2 id="3-HashMap的存储实现put-K-V"><a href="#3-HashMap的存储实现put-K-V" class="headerlink" title="3.  HashMap的存储实现put(K,V)"></a>3.  HashMap的存储实现put(K,V)</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (table == EMPTY_TABLE) &#123;</span><br><span class="line">            inflateTable(threshold);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//如果key为空的情况</span></span><br><span class="line">        <span class="keyword">if</span> (key == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">return</span> putForNullKey(value);</span><br><span class="line">            <span class="comment">//计算key的hash值</span></span><br><span class="line">        <span class="keyword">int</span> hash = sun.misc.Hashing.singleWordWangJenkinsHash(key);</span><br><span class="line">        <span class="comment">//计算该hash值在table中的下标</span></span><br><span class="line">        <span class="keyword">int</span> i = indexFor(hash, table.length);</span><br><span class="line">        <span class="comment">//对table[i]进行遍历</span></span><br><span class="line">        <span class="keyword">for</span> (HashMapEntry&lt;K,V&gt; e = table[i]; e != <span class="keyword">null</span>; e = e.next) &#123;</span><br><span class="line">            Object k;</span><br><span class="line">            <span class="comment">//判断该条链上是否有hash值相同的（key相同）</span></span><br><span class="line">            <span class="comment">//若存在相同，则直接覆盖value，返回旧value。</span></span><br><span class="line">            <span class="keyword">if</span> (e.hash == hash &amp;&amp; ((k = e.key) == key || key.equals(k))) &#123;</span><br><span class="line">                V oldValue = e.value;</span><br><span class="line">                e.value = value;</span><br><span class="line">                e.recordAccess(<span class="keyword">this</span>);</span><br><span class="line">                <span class="keyword">return</span> oldValue;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//修改次数+1</span></span><br><span class="line">        modCount++;</span><br><span class="line">        <span class="comment">//把当前key，value添加到table[i]的链表中</span></span><br><span class="line">        addEntry(hash, key, value, i);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="从上面的我们可以看到两点："><a href="#从上面的我们可以看到两点：" class="headerlink" title="从上面的我们可以看到两点："></a>从上面的我们可以看到两点：</h3><h3 id="1-putForNullKey-value-看出如果key为null，则调用putForNullKey-value-，这就是为什么HashMap可以用null作为键的原因，下面详细看看这个方法："><a href="#1-putForNullKey-value-看出如果key为null，则调用putForNullKey-value-，这就是为什么HashMap可以用null作为键的原因，下面详细看看这个方法：" class="headerlink" title="1. putForNullKey(value)看出如果key为null，则调用putForNullKey(value)，这就是为什么HashMap可以用null作为键的原因，下面详细看看这个方法："></a>1. putForNullKey(value)看出如果key为null，则调用putForNullKey(value)，这就是为什么HashMap可以用null作为键的原因，下面详细看看这个方法：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> V <span class="title">putForNullKey</span><span class="params">(V value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (HashMapEntry&lt;K,V&gt; e = table[<span class="number">0</span>]; e != <span class="keyword">null</span>; e = e.next) &#123;</span><br><span class="line">            <span class="comment">//查找链表中是否有null键</span></span><br><span class="line">            <span class="keyword">if</span> (e.key == <span class="keyword">null</span>) &#123;</span><br><span class="line">                V oldValue = e.value;</span><br><span class="line">                e.value = value;</span><br><span class="line">                e.recordAccess(<span class="keyword">this</span>);</span><br><span class="line">                <span class="keyword">return</span> oldValue;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        modCount++;</span><br><span class="line">        如果找不到，则把<span class="keyword">null</span>键插入</span><br><span class="line">        addEntry(<span class="number">0</span>, <span class="keyword">null</span>, value, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="然后我们看看addEntry方法做了什么："><a href="#然后我们看看addEntry方法做了什么：" class="headerlink" title="然后我们看看addEntry方法做了什么："></a>然后我们看看addEntry方法做了什么：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addEntry</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">int</span> bucketIndex)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ((size &gt;= threshold) &amp;&amp; (<span class="keyword">null</span> != table[bucketIndex])) &#123;</span><br><span class="line">            resize(<span class="number">2</span> * table.length);</span><br><span class="line">            <span class="comment">//着一步就是对key为null的处理，如果key为null，hash值为0，          //  也就是会插入到哈希表的表头table[0]的位置</span></span><br><span class="line">            hash = (<span class="keyword">null</span> != key) ? sun.misc.Hashing.singleWordWangJenkinsHash(key) : <span class="number">0</span>;</span><br><span class="line">            bucketIndex = indexFor(hash, table.length);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        createEntry(hash, key, value, bucketIndex);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-因为链中存在该key，则用传入的value覆盖掉旧的value，同时把旧的value返回：这就是为什么HashMap不能有两个key的原因。"><a href="#2-因为链中存在该key，则用传入的value覆盖掉旧的value，同时把旧的value返回：这就是为什么HashMap不能有两个key的原因。" class="headerlink" title="2. 因为链中存在该key，则用传入的value覆盖掉旧的value，同时把旧的value返回：这就是为什么HashMap不能有两个key的原因。"></a>2. 因为链中存在该key，则用传入的value覆盖掉旧的value，同时把旧的value返回：这就是为什么HashMap不能有两个key的原因。</h3><h3 id="对于hash操作，最重要的也是最困难的就是如何通过key确定hash的位置，我们看看HashMap的做法："><a href="#对于hash操作，最重要的也是最困难的就是如何通过key确定hash的位置，我们看看HashMap的做法：" class="headerlink" title="对于hash操作，最重要的也是最困难的就是如何通过key确定hash的位置，我们看看HashMap的做法："></a>对于hash操作，最重要的也是最困难的就是如何通过key确定hash的位置，我们看看HashMap的做法：</h3><h3 id="首先求得key的hash值：hash-key-然后通过indexFor方法算出该hash值在table中的下标"><a href="#首先求得key的hash值：hash-key-然后通过indexFor方法算出该hash值在table中的下标" class="headerlink" title="首先求得key的hash值：hash(key),然后通过indexFor方法算出该hash值在table中的下标"></a>首先求得key的hash值：hash(key),然后通过indexFor方法算出该hash值在table中的下标</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">indexFor</span><span class="params">(<span class="keyword">int</span> h, <span class="keyword">int</span> length)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// assert Integer.bitCount(length) == 1 : "length must be a non-zero power of 2";</span></span><br><span class="line">        <span class="keyword">return</span> h &amp; (length-<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="对于HashMap的table而言，数据分布需要均匀（最好每一项都只有一个元素，这样就可以直接找到），不能太紧也不能太松，太紧会导致查询速度慢，太松则浪费空间。计算hash值后，怎么才能保证table元素分布均匀呢？我们会想到取模，但是由于取模的消耗太大，而HashMap是通过-amp-运算符（按位与操作）来实现的：h-amp-（length-1）"><a href="#对于HashMap的table而言，数据分布需要均匀（最好每一项都只有一个元素，这样就可以直接找到），不能太紧也不能太松，太紧会导致查询速度慢，太松则浪费空间。计算hash值后，怎么才能保证table元素分布均匀呢？我们会想到取模，但是由于取模的消耗太大，而HashMap是通过-amp-运算符（按位与操作）来实现的：h-amp-（length-1）" class="headerlink" title="对于HashMap的table而言，数据分布需要均匀（最好每一项都只有一个元素，这样就可以直接找到），不能太紧也不能太松，太紧会导致查询速度慢，太松则浪费空间。计算hash值后，怎么才能保证table元素分布均匀呢？我们会想到取模，但是由于取模的消耗太大，而HashMap是通过&amp;运算符（按位与操作）来实现的：h&amp;（length-1）"></a>对于HashMap的table而言，数据分布需要均匀（最好每一项都只有一个元素，这样就可以直接找到），不能太紧也不能太松，太紧会导致查询速度慢，太松则浪费空间。计算hash值后，怎么才能保证table元素分布均匀呢？我们会想到取模，但是由于取模的消耗太大，而HashMap是通过&amp;运算符（按位与操作）来实现的：h&amp;（length-1）</h3><h3 id="在构造函数中存在：capacity-lt-lt-1-这样做总是能够保证HashMap的底层数组长度为2的次方。当length为2的n次方时，h-amp-（length-1）就相当于对length取模，而且速度比直接取模快得多，这是zhashMap在速度上的一个优化。"><a href="#在构造函数中存在：capacity-lt-lt-1-这样做总是能够保证HashMap的底层数组长度为2的次方。当length为2的n次方时，h-amp-（length-1）就相当于对length取模，而且速度比直接取模快得多，这是zhashMap在速度上的一个优化。" class="headerlink" title="在构造函数中存在：capacity&lt;&lt;=1,这样做总是能够保证HashMap的底层数组长度为2的次方。当length为2的n次方时，h&amp;（length-1）就相当于对length取模，而且速度比直接取模快得多，这是zhashMap在速度上的一个优化。"></a>在构造函数中存在：capacity&lt;&lt;=1,这样做总是能够保证HashMap的底层数组长度为2的次方。当length为2的n次方时，h&amp;（length-1）就相当于对length取模，而且速度比直接取模快得多，这是zhashMap在速度上的一个优化。</h3><h3 id="点那个length-2-n时，不同-的hash值发生碰撞的概率比较小，这样就会使得数据在table数组中分布比较均匀，查询速度也较快。"><a href="#点那个length-2-n时，不同-的hash值发生碰撞的概率比较小，这样就会使得数据在table数组中分布比较均匀，查询速度也较快。" class="headerlink" title="点那个length = 2^n时，不同 的hash值发生碰撞的概率比较小，这样就会使得数据在table数组中分布比较均匀，查询速度也较快。"></a>点那个length = 2^n时，不同 的hash值发生碰撞的概率比较小，这样就会使得数据在table数组中分布比较均匀，查询速度也较快。</h3><h3 id="计算了hash值后，如何把key-value插入该索引的链表中："><a href="#计算了hash值后，如何把key-value插入该索引的链表中：" class="headerlink" title="计算了hash值后，如何把key-value插入该索引的链表中："></a>计算了hash值后，如何把key-value插入该索引的链表中：</h3><h3 id="调用addEntry方法："><a href="#调用addEntry方法：" class="headerlink" title="调用addEntry方法："></a>调用addEntry方法：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addEntry</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">int</span> bucketIndex)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//  如果容量大于极限容量，将要进行重建内部数据结构操作，之后的容量是原来的两倍，并且重新设置hash值和hash值在table中的索引值</span></span><br><span class="line">        <span class="keyword">if</span> ((size &gt;= threshold) &amp;&amp; (<span class="keyword">null</span> != table[bucketIndex])) &#123;</span><br><span class="line">            resize(<span class="number">2</span> * table.length);</span><br><span class="line">            hash = (<span class="keyword">null</span> != key) ? sun.misc.Hashing.singleWordWangJenkinsHash(key) : <span class="number">0</span>;</span><br><span class="line">            bucketIndex = indexFor(hash, table.length);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//真正创建Entry节点的操作</span></span><br><span class="line">        createEntry(hash, key, value, bucketIndex);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">createEntry</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">int</span> bucketIndex)</span> </span>&#123;</span><br><span class="line">        HashMapEntry&lt;K,V&gt; e = table[bucketIndex];</span><br><span class="line">        table[bucketIndex] = <span class="keyword">new</span> HashMapEntry&lt;&gt;(hash, key, value, e);</span><br><span class="line">        size++;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="首先取得bucketIndex位置的Entry头节点，把该节点插入到链表汇总的头部，，该节点的next指针指向原来的头节点。"><a href="#首先取得bucketIndex位置的Entry头节点，把该节点插入到链表汇总的头部，，该节点的next指针指向原来的头节点。" class="headerlink" title="首先取得bucketIndex位置的Entry头节点，把该节点插入到链表汇总的头部，，该节点的next指针指向原来的头节点。"></a>首先取得bucketIndex位置的Entry头节点，把该节点插入到链表汇总的头部，，该节点的next指针指向原来的头节点。</h3><h3 id="这里有两点注意："><a href="#这里有两点注意：" class="headerlink" title="这里有两点注意："></a>这里有两点注意：</h3><h4 id="一-链的产生"><a href="#一-链的产生" class="headerlink" title="一.链的产生"></a>一.链的产生</h4><p> 系统总是将新的Entry对象添加到bugketIndex处。如果bucketIndex处应有了对象，那么新添加的Entry对象将指向原有的Entry对象，形成一条Entry链，但是若bucketIndex处没有Entry对象，也就是e==null，那么新添加的Entry对象指向为null，也就不会产生Entry链了。</p>
<h4 id="二-扩容问题"><a href="#二-扩容问题" class="headerlink" title="二. 扩容问题"></a>二. 扩容问题</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">threshold = (<span class="keyword">int</span>)Math.min(newCapacity * loadFactor, MAXIMUM_CAPACITY + <span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<h3 id="梳理下存储的步骤："><a href="#梳理下存储的步骤：" class="headerlink" title="梳理下存储的步骤："></a>梳理下存储的步骤：</h3><blockquote>
<ul>
<li>1.传入key和value，判断key是否为null，如果为null，则调用putForNullkey，以null ️作为key存储到哈希表中；</li>
<li>2.计算key的hash值，根据hash值搜索在哈希表table中的索引位置，若当前索引位置不为null，则对该位置的Entry链表进行遍历，如果链中存在该key，则用传入的value覆盖掉旧的value，同时把旧的value返回；</li>
<li>3.否则调用addEntry，用key-value创建一个新的节点，并把该节点插入到所以对应的链表的头部<h2 id="4-HashMap的读取实现get-key-value"><a href="#4-HashMap的读取实现get-key-value" class="headerlink" title="4.  HashMap的读取实现get(key,value)"></a>4.  HashMap的读取实现get(key,value)</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//如果key为null，求null键</span></span><br><span class="line">        <span class="keyword">if</span> (key == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">return</span> getForNullKey();</span><br><span class="line">        <span class="comment">//用该key求得entry</span></span><br><span class="line">        Entry&lt;K,V&gt; entry = getEntry(key);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span> == entry ? <span class="keyword">null</span> : entry.getValue();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> Entry&lt;K,V&gt; <span class="title">getEntry</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (size == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> hash = (key == <span class="keyword">null</span>) ? <span class="number">0</span> : sun.misc.Hashing.singleWordWangJenkinsHash(key);</span><br><span class="line">        <span class="keyword">for</span> (HashMapEntry&lt;K,V&gt; e = table[indexFor(hash, table.length)];</span><br><span class="line">             e != <span class="keyword">null</span>;</span><br><span class="line">             e = e.next) &#123;</span><br><span class="line">            Object k;</span><br><span class="line">            <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">                <span class="keyword">return</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="读取的步骤比较简单，调用hash-key-求得hash值，然后调用indexFor-hash-求得hash值对应的table的索引位置，然后遍历索引位置的链表，如果存在key，则把key对应的Entry返回，否则返回null。"><a href="#读取的步骤比较简单，调用hash-key-求得hash值，然后调用indexFor-hash-求得hash值对应的table的索引位置，然后遍历索引位置的链表，如果存在key，则把key对应的Entry返回，否则返回null。" class="headerlink" title="读取的步骤比较简单，调用hash(key)求得hash值，然后调用indexFor(hash)求得hash值对应的table的索引位置，然后遍历索引位置的链表，如果存在key，则把key对应的Entry返回，否则返回null。"></a>读取的步骤比较简单，调用hash(key)求得hash值，然后调用indexFor(hash)求得hash值对应的table的索引位置，然后遍历索引位置的链表，如果存在key，则把key对应的Entry返回，否则返回null。</h3><h2 id="5-HashMap键的遍历-keyset"><a href="#5-HashMap键的遍历-keyset" class="headerlink" title="5.  HashMap键的遍历,keyset()"></a>5.  HashMap键的遍历,keyset()</h2><p>HashMap遍历的核心代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">HashIterator</span>&lt;<span class="title">E</span>&gt; <span class="keyword">implements</span> <span class="title">Iterator</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line">        HashMapEntry&lt;K,V&gt; next;        <span class="comment">// next entry to return</span></span><br><span class="line">        <span class="keyword">int</span> expectedModCount;   <span class="comment">// For fast-fail</span></span><br><span class="line">        <span class="keyword">int</span> index;              <span class="comment">// current slot</span></span><br><span class="line">        HashMapEntry&lt;K,V&gt; current;     <span class="comment">// current entry</span></span><br><span class="line">        <span class="comment">//当调用keyset().iterator()时，调用此代码</span></span><br><span class="line">        HashIterator() &#123;</span><br><span class="line">            expectedModCount = modCount;</span><br><span class="line">            <span class="keyword">if</span> (size &gt; <span class="number">0</span>) &#123; <span class="comment">// advance to first entry</span></span><br><span class="line">                HashMapEntry[] t = table;</span><br><span class="line">                <span class="comment">//从哈希表数组从上到下，查找第一个不为null的节点，并把next引用指向该节点</span></span><br><span class="line">                <span class="keyword">while</span> (index &lt; t.length &amp;&amp; (next = t[index++]) == <span class="keyword">null</span>)</span><br><span class="line">                    ;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> next != <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//当调用next时，会调用此代码</span></span><br><span class="line">        <span class="function"><span class="keyword">final</span> Entry&lt;K,V&gt; <span class="title">nextEntry</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (modCount != expectedModCount)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ConcurrentModificationException();</span><br><span class="line">            HashMapEntry&lt;K,V&gt; e = next;</span><br><span class="line">            <span class="keyword">if</span> (e == <span class="keyword">null</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchElementException();</span><br><span class="line">            <span class="comment">//如果当前节点的下一个节点为null，从节点出发往下查找哈希表，找到第一个不为null的节点</span></span><br><span class="line">            <span class="keyword">if</span> ((next = e.next) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                HashMapEntry[] t = table;</span><br><span class="line">                <span class="keyword">while</span> (index &lt; t.length &amp;&amp; (next = t[index++]) == <span class="keyword">null</span>)</span><br><span class="line">                    ;</span><br><span class="line">            &#125;</span><br><span class="line">            current = e;</span><br><span class="line">            <span class="keyword">return</span> e;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (current == <span class="keyword">null</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException();</span><br><span class="line">            <span class="keyword">if</span> (modCount != expectedModCount)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ConcurrentModificationException();</span><br><span class="line">            Object k = current.key;</span><br><span class="line">            current = <span class="keyword">null</span>;</span><br><span class="line">            HashMap.<span class="keyword">this</span>.removeEntryForKey(k);</span><br><span class="line">            expectedModCount = modCount;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="从这里可以看出，HashMap遍历时，按哈希表的每一个索引的链表从上往下遍历，由于HashMap的存储规则，最晚添加的节点都有可能在第一个索引的链表中，这就早晨改了H啊是M阿婆的遍历是无序的。"><a href="#从这里可以看出，HashMap遍历时，按哈希表的每一个索引的链表从上往下遍历，由于HashMap的存储规则，最晚添加的节点都有可能在第一个索引的链表中，这就早晨改了H啊是M阿婆的遍历是无序的。" class="headerlink" title="从这里可以看出，HashMap遍历时，按哈希表的每一个索引的链表从上往下遍历，由于HashMap的存储规则，最晚添加的节点都有可能在第一个索引的链表中，这就早晨改了H啊是M阿婆的遍历是无序的。"></a>从这里可以看出，HashMap遍历时，按哈希表的每一个索引的链表从上往下遍历，由于HashMap的存储规则，最晚添加的节点都有可能在第一个索引的链表中，这就早晨改了H啊是M阿婆的遍历是无序的。</h3>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/29/Android动画讲解/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="吴晓龙">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://opq81riyh.bkt.clouddn.com/666.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="吴晓龙">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/29/Android动画讲解/" itemprop="url">Android动画讲解</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-29T11:43:21+08:00">
                2018-01-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Android动画讲解"><a href="#Android动画讲解" class="headerlink" title="#Android动画讲解"></a>#Android动画讲解</h2><p><img src="http://opq81riyh.bkt.clouddn.com/%E5%8A%A8%E7%94%BB.png" alt=""><br><img src="http://opq81riyh.bkt.clouddn.com/%E5%8A%A8%E7%94%BB.mindnode.zip" alt="333"></p>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/25/基于8-0源码解析：bindService-启动过程/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="吴晓龙">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://opq81riyh.bkt.clouddn.com/666.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="吴晓龙">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/25/基于8-0源码解析：bindService-启动过程/" itemprop="url">基于8.0源码解析：bindService 启动过程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-25T11:44:40+08:00">
                2018-01-25
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/源码解析/" itemprop="url" rel="index">
                    <span itemprop="name">源码解析</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="基于8-0源码解析：bindService-启动过程"><a href="#基于8-0源码解析：bindService-启动过程" class="headerlink" title="基于8.0源码解析：bindService 启动过程"></a>基于8.0源码解析：bindService 启动过程</h1><p>欢迎关注我的公众号：<br><img src="http://opq81riyh.bkt.clouddn.com/qrcode_for_gh_1d2b09f3edbf_258%20%282%29.jpg" alt=""></p>
<hr>
<p><img src="http://opq81riyh.bkt.clouddn.com/bindService%20%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B.png" alt=""></p>
<p>调用bindService 后会到ContextWrapper中：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">bindService</span><span class="params">(Intent service, ServiceConnection conn,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> mBase.bindService(service, conn, flags);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>应为ContextWrapper是继承自context，而context的实现是contextImpl，<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="number">1538</span>    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">bindService</span><span class="params">(Intent service, ServiceConnection conn,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">1539</span>            <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line"><span class="number">1540</span>        warnIfCallingFromSystemProcess();</span><br><span class="line"><span class="number">1541</span>        <span class="keyword">return</span> bindServiceCommon(service, conn, flags, mMainThread.getHandler(),</span><br><span class="line"><span class="number">1542</span>                Process.myUserHandle());</span><br><span class="line"><span class="number">1543</span>    &#125;</span><br></pre></td></tr></table></figure></p>
<p>这个方法又调用了bindServiceCommon，<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">bindServiceCommon</span><span class="params">(Intent service, ServiceConnection conn, <span class="keyword">int</span> flags, Handler</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">1582</span>            handler, UserHandle user)</span> </span>&#123;</span><br><span class="line"><span class="number">1583</span>        <span class="comment">// Keep this in sync with DevicePolicyManager.bindDeviceAdminServiceAsUser.</span></span><br><span class="line"><span class="number">1584</span>        IServiceConnection sd;</span><br><span class="line"><span class="number">1585</span>        <span class="keyword">if</span> (conn == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">1586</span>            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"connection is null"</span>);</span><br><span class="line"><span class="number">1587</span>        &#125;</span><br><span class="line"><span class="number">1588</span>        <span class="keyword">if</span> (mPackageInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">1589</span>            sd = mPackageInfo.getServiceDispatcher(conn, getOuterContext(), handler, flags);</span><br><span class="line"><span class="number">1590</span>        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="number">1591</span>            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Not supported in system context"</span>);</span><br><span class="line"><span class="number">1592</span>        &#125;</span><br><span class="line"><span class="number">1593</span>        validateServiceIntent(service);</span><br><span class="line"><span class="number">1594</span>        <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="number">1595</span>            IBinder token = getActivityToken();</span><br><span class="line"><span class="number">1596</span>            <span class="keyword">if</span> (token == <span class="keyword">null</span> &amp;&amp; (flags&amp;BIND_AUTO_CREATE) == <span class="number">0</span> &amp;&amp; mPackageInfo != <span class="keyword">null</span></span><br><span class="line"><span class="number">1597</span>                    &amp;&amp; mPackageInfo.getApplicationInfo().targetSdkVersion</span><br><span class="line"><span class="number">1598</span>                    &lt; android.os.Build.VERSION_CODES.ICE_CREAM_SANDWICH) &#123;</span><br><span class="line"><span class="number">1599</span>                flags |= BIND_WAIVE_PRIORITY;</span><br><span class="line"><span class="number">1600</span>            &#125;</span><br><span class="line"><span class="number">1601</span>            service.prepareToLeaveProcess(<span class="keyword">this</span>);</span><br><span class="line"><span class="number">1602</span>            <span class="keyword">int</span> res = ActivityManager.getService().bindService(</span><br><span class="line"><span class="number">1603</span>                mMainThread.getApplicationThread(), getActivityToken(), service,</span><br><span class="line"><span class="number">1604</span>                service.resolveTypeIfNeeded(getContentResolver()),</span><br><span class="line"><span class="number">1605</span>                sd, flags, getOpPackageName(), user.getIdentifier());</span><br><span class="line"><span class="number">1606</span>            <span class="keyword">if</span> (res &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">1607</span>                <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(</span><br><span class="line"><span class="number">1608</span>                        <span class="string">"Not allowed to bind to service "</span> + service);</span><br><span class="line"><span class="number">1609</span>            &#125;</span><br><span class="line"><span class="number">1610</span>            <span class="keyword">return</span> res != <span class="number">0</span>;</span><br><span class="line"><span class="number">1611</span>        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line"><span class="number">1612</span>            <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line"><span class="number">1613</span>        &#125;</span><br><span class="line"><span class="number">1614</span>    &#125;</span><br></pre></td></tr></table></figure></p>
<p>ActivityManager.getService().bindService会通过Binder机制调用到ActivityManagerService中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">bindService</span><span class="params">(IApplicationThread caller, IBinder token, Intent service,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">18276</span>            String resolvedType, IServiceConnection connection, <span class="keyword">int</span> flags, String callingPackage,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">18277</span>            <span class="keyword">int</span> userId)</span> <span class="keyword">throws</span> TransactionTooLargeException </span>&#123;</span><br><span class="line"><span class="number">18278</span>        enforceNotIsolatedCaller(<span class="string">"bindService"</span>);</span><br><span class="line"><span class="number">18279</span></span><br><span class="line"><span class="number">18280</span>        <span class="comment">// Refuse possible leaked file descriptors</span></span><br><span class="line"><span class="number">18281</span>        <span class="keyword">if</span> (service != <span class="keyword">null</span> &amp;&amp; service.hasFileDescriptors() == <span class="keyword">true</span>) &#123;</span><br><span class="line"><span class="number">18282</span>            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"File descriptors passed in Intent"</span>);</span><br><span class="line"><span class="number">18283</span>        &#125;</span><br><span class="line"><span class="number">18284</span></span><br><span class="line"><span class="number">18285</span>        <span class="keyword">if</span> (callingPackage == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">18286</span>            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"callingPackage cannot be null"</span>);</span><br><span class="line"><span class="number">18287</span>        &#125;</span><br><span class="line"><span class="number">18288</span></span><br><span class="line"><span class="number">18289</span>        <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line"><span class="number">18290</span>            <span class="keyword">return</span> mServices.bindServiceLocked(caller, token, service,</span><br><span class="line"><span class="number">18291</span>                    resolvedType, connection, flags, callingPackage, userId);</span><br><span class="line"><span class="number">18292</span>        &#125;</span><br><span class="line"><span class="number">18293</span>    &#125;</span><br><span class="line"><span class="number">18294</span></span><br></pre></td></tr></table></figure>
<p>mServices.bindServiceLocked会调用到ActiveServices中：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bindServiceLocked</span><span class="params">(IApplicationThread caller, IBinder token, Intent service,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">1229</span>            String resolvedType, <span class="keyword">final</span> IServiceConnection connection, <span class="keyword">int</span> flags,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">1230</span>            String callingPackage, <span class="keyword">final</span> <span class="keyword">int</span> userId)</span> <span class="keyword">throws</span> TransactionTooLargeException </span>&#123;</span><br><span class="line"><span class="number">1231</span>        <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"bindService: "</span> + service</span><br><span class="line"><span class="number">1232</span>                + <span class="string">" type="</span> + resolvedType + <span class="string">" conn="</span> + connection.asBinder()</span><br><span class="line"><span class="number">1233</span>                + <span class="string">" flags=0x"</span> + Integer.toHexString(flags));</span><br><span class="line"><span class="number">1234</span>        <span class="keyword">final</span> ProcessRecord callerApp = mAm.getRecordForAppLocked(caller);</span><br><span class="line"><span class="number">1235</span>        <span class="keyword">if</span> (callerApp == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">1236</span>            <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(</span><br><span class="line"><span class="number">1237</span>                    <span class="string">"Unable to find app for caller "</span> + caller</span><br><span class="line"><span class="number">1238</span>                    + <span class="string">" (pid="</span> + Binder.getCallingPid()</span><br><span class="line"><span class="number">1239</span>                    + <span class="string">") when binding service "</span> + service);</span><br><span class="line"><span class="number">1240</span>        &#125;</span><br><span class="line"><span class="number">1241</span></span><br><span class="line"><span class="number">1242</span>        ActivityRecord activity = <span class="keyword">null</span>;</span><br><span class="line"><span class="number">1243</span>        <span class="keyword">if</span> (token != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">1244</span>            activity = ActivityRecord.isInStackLocked(token);</span><br><span class="line"><span class="number">1245</span>            <span class="keyword">if</span> (activity == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">1246</span>                Slog.w(TAG, <span class="string">"Binding with unknown activity: "</span> + token);</span><br><span class="line"><span class="number">1247</span>                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="number">1248</span>            &#125;</span><br><span class="line"><span class="number">1249</span>        &#125;</span><br><span class="line"><span class="number">1250</span></span><br><span class="line"><span class="number">1251</span>        <span class="keyword">int</span> clientLabel = <span class="number">0</span>;</span><br><span class="line"><span class="number">1252</span>        PendingIntent clientIntent = <span class="keyword">null</span>;</span><br><span class="line"><span class="number">1253</span>        <span class="keyword">final</span> <span class="keyword">boolean</span> isCallerSystem = callerApp.info.uid == Process.SYSTEM_UID;</span><br><span class="line"><span class="number">1254</span></span><br><span class="line"><span class="number">1255</span>        <span class="keyword">if</span> (isCallerSystem) &#123;</span><br><span class="line"><span class="number">1256</span>            <span class="comment">// Hacky kind of thing -- allow system stuff to tell us</span></span><br><span class="line"><span class="number">1257</span>            <span class="comment">// what they are, so we can report this elsewhere for</span></span><br><span class="line"><span class="number">1258</span>            <span class="comment">// others to know why certain services are running.</span></span><br><span class="line"><span class="number">1259</span>            service.setDefusable(<span class="keyword">true</span>);</span><br><span class="line"><span class="number">1260</span>            clientIntent = service.getParcelableExtra(Intent.EXTRA_CLIENT_INTENT);</span><br><span class="line"><span class="number">1261</span>            <span class="keyword">if</span> (clientIntent != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">1262</span>                clientLabel = service.getIntExtra(Intent.EXTRA_CLIENT_LABEL, <span class="number">0</span>);</span><br><span class="line"><span class="number">1263</span>                <span class="keyword">if</span> (clientLabel != <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">1264</span>                    <span class="comment">// There are no useful extras in the intent, trash them.</span></span><br><span class="line"><span class="number">1265</span>                    <span class="comment">// System code calling with this stuff just needs to know</span></span><br><span class="line"><span class="number">1266</span>                    <span class="comment">// this will happen.</span></span><br><span class="line"><span class="number">1267</span>                    service = service.cloneFilter();</span><br><span class="line"><span class="number">1268</span>                &#125;</span><br><span class="line"><span class="number">1269</span>            &#125;</span><br><span class="line"><span class="number">1270</span>        &#125;</span><br><span class="line"><span class="number">1271</span></span><br><span class="line"><span class="number">1272</span>        <span class="keyword">if</span> ((flags&amp;Context.BIND_TREAT_LIKE_ACTIVITY) != <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">1273</span>            mAm.enforceCallingPermission(android.Manifest.permission.MANAGE_ACTIVITY_STACKS,</span><br><span class="line"><span class="number">1274</span>                    <span class="string">"BIND_TREAT_LIKE_ACTIVITY"</span>);</span><br><span class="line"><span class="number">1275</span>        &#125;</span><br><span class="line"><span class="number">1276</span></span><br><span class="line"><span class="number">1277</span>        <span class="keyword">if</span> ((flags &amp; Context.BIND_ALLOW_WHITELIST_MANAGEMENT) != <span class="number">0</span> &amp;&amp; !isCallerSystem) &#123;</span><br><span class="line"><span class="number">1278</span>            <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(</span><br><span class="line"><span class="number">1279</span>                    <span class="string">"Non-system caller "</span> + caller + <span class="string">" (pid="</span> + Binder.getCallingPid()</span><br><span class="line"><span class="number">1280</span>                    + <span class="string">") set BIND_ALLOW_WHITELIST_MANAGEMENT when binding service "</span> + service);</span><br><span class="line"><span class="number">1281</span>        &#125;</span><br><span class="line"><span class="number">1282</span></span><br><span class="line"><span class="number">1283</span>        <span class="keyword">final</span> <span class="keyword">boolean</span> callerFg = callerApp.setSchedGroup != ProcessList.SCHED_GROUP_BACKGROUND;</span><br><span class="line"><span class="number">1284</span>        <span class="keyword">final</span> <span class="keyword">boolean</span> isBindExternal = (flags &amp; Context.BIND_EXTERNAL_SERVICE) != <span class="number">0</span>;</span><br><span class="line"><span class="number">1285</span></span><br><span class="line"><span class="number">1286</span>        ServiceLookupResult res =</span><br><span class="line"><span class="number">1287</span>            retrieveServiceLocked(service, resolvedType, callingPackage, Binder.getCallingPid(),</span><br><span class="line"><span class="number">1288</span>                    Binder.getCallingUid(), userId, <span class="keyword">true</span>, callerFg, isBindExternal);</span><br><span class="line"><span class="number">1289</span>        <span class="keyword">if</span> (res == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">1290</span>            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="number">1291</span>        &#125;</span><br><span class="line"><span class="number">1292</span>        <span class="keyword">if</span> (res.record == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">1293</span>            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line"><span class="number">1294</span>        &#125;</span><br><span class="line"><span class="number">1295</span>        ServiceRecord s = res.record;</span><br><span class="line"><span class="number">1296</span></span><br><span class="line"><span class="number">1297</span>        <span class="keyword">boolean</span> permissionsReviewRequired = <span class="keyword">false</span>;</span><br><span class="line"><span class="number">1298</span></span><br><span class="line"><span class="number">1299</span>        <span class="comment">// If permissions need a review before any of the app components can run,</span></span><br><span class="line"><span class="number">1300</span>        <span class="comment">// we schedule binding to the service but do not start its process, then</span></span><br><span class="line"><span class="number">1301</span>        <span class="comment">// we launch a review activity to which is passed a callback to invoke</span></span><br><span class="line"><span class="number">1302</span>        <span class="comment">// when done to start the bound service's process to completing the binding.</span></span><br><span class="line"><span class="number">1303</span>        <span class="keyword">if</span> (mAm.mPermissionReviewRequired) &#123;</span><br><span class="line"><span class="number">1304</span>            <span class="keyword">if</span> (mAm.getPackageManagerInternalLocked().isPermissionsReviewRequired(</span><br><span class="line"><span class="number">1305</span>                    s.packageName, s.userId)) &#123;</span><br><span class="line"><span class="number">1306</span></span><br><span class="line"><span class="number">1307</span>                permissionsReviewRequired = <span class="keyword">true</span>;</span><br><span class="line"><span class="number">1308</span></span><br><span class="line"><span class="number">1309</span>                <span class="comment">// Show a permission review UI only for binding from a foreground app</span></span><br><span class="line"><span class="number">1310</span>                <span class="keyword">if</span> (!callerFg) &#123;</span><br><span class="line"><span class="number">1311</span>                    Slog.w(TAG, <span class="string">"u"</span> + s.userId + <span class="string">" Binding to a service in package"</span></span><br><span class="line"><span class="number">1312</span>                            + s.packageName + <span class="string">" requires a permissions review"</span>);</span><br><span class="line"><span class="number">1313</span>                    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="number">1314</span>                &#125;</span><br><span class="line"><span class="number">1315</span></span><br><span class="line"><span class="number">1316</span>                <span class="keyword">final</span> ServiceRecord serviceRecord = s;</span><br><span class="line"><span class="number">1317</span>                <span class="keyword">final</span> Intent serviceIntent = service;</span><br><span class="line"><span class="number">1318</span></span><br><span class="line"><span class="number">1319</span>                RemoteCallback callback = <span class="keyword">new</span> RemoteCallback(</span><br><span class="line"><span class="number">1320</span>                        <span class="keyword">new</span> RemoteCallback.OnResultListener() &#123;</span><br><span class="line"><span class="number">1321</span>                    <span class="meta">@Override</span></span><br><span class="line"><span class="number">1322</span>                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResult</span><span class="params">(Bundle result)</span> </span>&#123;</span><br><span class="line"><span class="number">1323</span>                        <span class="keyword">synchronized</span>(mAm) &#123;</span><br><span class="line"><span class="number">1324</span>                            <span class="keyword">final</span> <span class="keyword">long</span> identity = Binder.clearCallingIdentity();</span><br><span class="line"><span class="number">1325</span>                            <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="number">1326</span>                                <span class="keyword">if</span> (!mPendingServices.contains(serviceRecord)) &#123;</span><br><span class="line"><span class="number">1327</span>                                    <span class="keyword">return</span>;</span><br><span class="line"><span class="number">1328</span>                                &#125;</span><br><span class="line"><span class="number">1329</span>                                <span class="comment">// If there is still a pending record, then the service</span></span><br><span class="line"><span class="number">1330</span>                                <span class="comment">// binding request is still valid, so hook them up. We</span></span><br><span class="line"><span class="number">1331</span>                                <span class="comment">// proceed only if the caller cleared the review requirement</span></span><br><span class="line"><span class="number">1332</span>                                <span class="comment">// otherwise we unbind because the user didn't approve.</span></span><br><span class="line"><span class="number">1333</span>                                <span class="keyword">if</span> (!mAm.getPackageManagerInternalLocked()</span><br><span class="line"><span class="number">1334</span>                                        .isPermissionsReviewRequired(</span><br><span class="line"><span class="number">1335</span>                                                serviceRecord.packageName,</span><br><span class="line"><span class="number">1336</span>                                                serviceRecord.userId)) &#123;</span><br><span class="line"><span class="number">1337</span>                                    <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="number">1338</span>                                        bringUpServiceLocked(serviceRecord,</span><br><span class="line"><span class="number">1339</span>                                                serviceIntent.getFlags(),</span><br><span class="line"><span class="number">1340</span>                                                callerFg, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line"><span class="number">1341</span>                                    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line"><span class="number">1342</span>                                        <span class="comment">/* ignore - local call */</span></span><br><span class="line"><span class="number">1343</span>                                    &#125;</span><br><span class="line"><span class="number">1344</span>                                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="number">1345</span>                                    unbindServiceLocked(connection);</span><br><span class="line"><span class="number">1346</span>                                &#125;</span><br><span class="line"><span class="number">1347</span>                            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line"><span class="number">1348</span>                                Binder.restoreCallingIdentity(identity);</span><br><span class="line"><span class="number">1349</span>                            &#125;</span><br><span class="line"><span class="number">1350</span>                        &#125;</span><br><span class="line"><span class="number">1351</span>                    &#125;</span><br><span class="line"><span class="number">1352</span>                &#125;);</span><br><span class="line"><span class="number">1353</span></span><br><span class="line"><span class="number">1354</span>                <span class="keyword">final</span> Intent intent = <span class="keyword">new</span> Intent(Intent.ACTION_REVIEW_PERMISSIONS);</span><br><span class="line"><span class="number">1355</span>                intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK</span><br><span class="line"><span class="number">1356</span>                        | Intent.FLAG_ACTIVITY_EXCLUDE_FROM_RECENTS);</span><br><span class="line"><span class="number">1357</span>                intent.putExtra(Intent.EXTRA_PACKAGE_NAME, s.packageName);</span><br><span class="line"><span class="number">1358</span>                intent.putExtra(Intent.EXTRA_REMOTE_CALLBACK, callback);</span><br><span class="line"><span class="number">1359</span></span><br><span class="line"><span class="number">1360</span>                <span class="keyword">if</span> (DEBUG_PERMISSIONS_REVIEW) &#123;</span><br><span class="line"><span class="number">1361</span>                    Slog.i(TAG, <span class="string">"u"</span> + s.userId + <span class="string">" Launching permission review for package "</span></span><br><span class="line"><span class="number">1362</span>                            + s.packageName);</span><br><span class="line"><span class="number">1363</span>                &#125;</span><br><span class="line"><span class="number">1364</span></span><br><span class="line"><span class="number">1365</span>                mAm.mHandler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line"><span class="number">1366</span>                    <span class="meta">@Override</span></span><br><span class="line"><span class="number">1367</span>                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="number">1368</span>                        mAm.mContext.startActivityAsUser(intent, <span class="keyword">new</span> UserHandle(userId));</span><br><span class="line"><span class="number">1369</span>                    &#125;</span><br><span class="line"><span class="number">1370</span>                &#125;);</span><br><span class="line"><span class="number">1371</span>            &#125;</span><br><span class="line"><span class="number">1372</span>        &#125;</span><br><span class="line"><span class="number">1373</span></span><br><span class="line"><span class="number">1374</span>        <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</span><br><span class="line"><span class="number">1375</span></span><br><span class="line"><span class="number">1376</span>        <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="number">1377</span>            <span class="keyword">if</span> (unscheduleServiceRestartLocked(s, callerApp.info.uid, <span class="keyword">false</span>)) &#123;</span><br><span class="line"><span class="number">1378</span>                <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"BIND SERVICE WHILE RESTART PENDING: "</span></span><br><span class="line"><span class="number">1379</span>                        + s);</span><br><span class="line"><span class="number">1380</span>            &#125;</span><br><span class="line"><span class="number">1381</span></span><br><span class="line"><span class="number">1382</span>            <span class="keyword">if</span> ((flags&amp;Context.BIND_AUTO_CREATE) != <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">1383</span>                s.lastActivity = SystemClock.uptimeMillis();</span><br><span class="line"><span class="number">1384</span>                <span class="keyword">if</span> (!s.hasAutoCreateConnections()) &#123;</span><br><span class="line"><span class="number">1385</span>                    <span class="comment">// This is the first binding, let the tracker know.</span></span><br><span class="line"><span class="number">1386</span>                    ServiceState stracker = s.getTracker();</span><br><span class="line"><span class="number">1387</span>                    <span class="keyword">if</span> (stracker != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">1388</span>                        stracker.setBound(<span class="keyword">true</span>, mAm.mProcessStats.getMemFactorLocked(),</span><br><span class="line"><span class="number">1389</span>                                s.lastActivity);</span><br><span class="line"><span class="number">1390</span>                    &#125;</span><br><span class="line"><span class="number">1391</span>                &#125;</span><br><span class="line"><span class="number">1392</span>            &#125;</span><br><span class="line"><span class="number">1393</span></span><br><span class="line"><span class="number">1394</span>            mAm.startAssociationLocked(callerApp.uid, callerApp.processName, callerApp.curProcState,</span><br><span class="line"><span class="number">1395</span>                    s.appInfo.uid, s.name, s.processName);</span><br><span class="line"><span class="number">1396</span>            <span class="comment">// Once the apps have become associated, if one of them is caller is ephemeral</span></span><br><span class="line"><span class="number">1397</span>            <span class="comment">// the target app should now be able to see the calling app</span></span><br><span class="line"><span class="number">1398</span>            mAm.grantEphemeralAccessLocked(callerApp.userId, service,</span><br><span class="line"><span class="number">1399</span>                    s.appInfo.uid, UserHandle.getAppId(callerApp.uid));</span><br><span class="line"><span class="number">1400</span></span><br><span class="line"><span class="number">1401</span>            AppBindRecord b = s.retrieveAppBindingLocked(service, callerApp);</span><br><span class="line"><span class="number">1402</span>            ConnectionRecord c = <span class="keyword">new</span> ConnectionRecord(b, activity,</span><br><span class="line"><span class="number">1403</span>                    connection, flags, clientLabel, clientIntent);</span><br><span class="line"><span class="number">1404</span></span><br><span class="line"><span class="number">1405</span>            IBinder binder = connection.asBinder();</span><br><span class="line"><span class="number">1406</span>            ArrayList&lt;ConnectionRecord&gt; clist = s.connections.get(binder);</span><br><span class="line"><span class="number">1407</span>            <span class="keyword">if</span> (clist == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">1408</span>                clist = <span class="keyword">new</span> ArrayList&lt;ConnectionRecord&gt;();</span><br><span class="line"><span class="number">1409</span>                s.connections.put(binder, clist);</span><br><span class="line"><span class="number">1410</span>            &#125;</span><br><span class="line"><span class="number">1411</span>            clist.add(c);</span><br><span class="line"><span class="number">1412</span>            b.connections.add(c);</span><br><span class="line"><span class="number">1413</span>            <span class="keyword">if</span> (activity != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">1414</span>                <span class="keyword">if</span> (activity.connections == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">1415</span>                    activity.connections = <span class="keyword">new</span> HashSet&lt;ConnectionRecord&gt;();</span><br><span class="line"><span class="number">1416</span>                &#125;</span><br><span class="line"><span class="number">1417</span>                activity.connections.add(c);</span><br><span class="line"><span class="number">1418</span>            &#125;</span><br><span class="line"><span class="number">1419</span>            b.client.connections.add(c);</span><br><span class="line"><span class="number">1420</span>            <span class="keyword">if</span> ((c.flags&amp;Context.BIND_ABOVE_CLIENT) != <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">1421</span>                b.client.hasAboveClient = <span class="keyword">true</span>;</span><br><span class="line"><span class="number">1422</span>            &#125;</span><br><span class="line"><span class="number">1423</span>            <span class="keyword">if</span> ((c.flags&amp;Context.BIND_ALLOW_WHITELIST_MANAGEMENT) != <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">1424</span>                s.whitelistManager = <span class="keyword">true</span>;</span><br><span class="line"><span class="number">1425</span>            &#125;</span><br><span class="line"><span class="number">1426</span>            <span class="keyword">if</span> (s.app != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">1427</span>                updateServiceClientActivitiesLocked(s.app, c, <span class="keyword">true</span>);</span><br><span class="line"><span class="number">1428</span>            &#125;</span><br><span class="line"><span class="number">1429</span>            clist = mServiceConnections.get(binder);</span><br><span class="line"><span class="number">1430</span>            <span class="keyword">if</span> (clist == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">1431</span>                clist = <span class="keyword">new</span> ArrayList&lt;ConnectionRecord&gt;();</span><br><span class="line"><span class="number">1432</span>                mServiceConnections.put(binder, clist);</span><br><span class="line"><span class="number">1433</span>            &#125;</span><br><span class="line"><span class="number">1434</span>            clist.add(c);</span><br><span class="line"><span class="number">1435</span></span><br><span class="line"><span class="number">1436</span>            <span class="keyword">if</span> ((flags&amp;Context.BIND_AUTO_CREATE) != <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">1437</span>                s.lastActivity = SystemClock.uptimeMillis();</span><br><span class="line"><span class="number">1438</span>                <span class="keyword">if</span> (bringUpServiceLocked(s, service.getFlags(), callerFg, <span class="keyword">false</span>,</span><br><span class="line"><span class="number">1439</span>                        permissionsReviewRequired) != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">1440</span>                    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="number">1441</span>                &#125;</span><br><span class="line"><span class="number">1442</span>            &#125;</span><br><span class="line"><span class="number">1443</span></span><br><span class="line"><span class="number">1444</span>            <span class="keyword">if</span> (s.app != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">1445</span>                <span class="keyword">if</span> ((flags&amp;Context.BIND_TREAT_LIKE_ACTIVITY) != <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">1446</span>                    s.app.treatLikeActivity = <span class="keyword">true</span>;</span><br><span class="line"><span class="number">1447</span>                &#125;</span><br><span class="line"><span class="number">1448</span>                <span class="keyword">if</span> (s.whitelistManager) &#123;</span><br><span class="line"><span class="number">1449</span>                    s.app.whitelistManager = <span class="keyword">true</span>;</span><br><span class="line"><span class="number">1450</span>                &#125;</span><br><span class="line"><span class="number">1451</span>                <span class="comment">// This could have made the service more important.</span></span><br><span class="line"><span class="number">1452</span>                mAm.updateLruProcessLocked(s.app, s.app.hasClientActivities</span><br><span class="line"><span class="number">1453</span>                        || s.app.treatLikeActivity, b.client);</span><br><span class="line"><span class="number">1454</span>                mAm.updateOomAdjLocked(s.app, <span class="keyword">true</span>);</span><br><span class="line"><span class="number">1455</span>            &#125;</span><br><span class="line"><span class="number">1456</span></span><br><span class="line"><span class="number">1457</span>            <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"Bind "</span> + s + <span class="string">" with "</span> + b</span><br><span class="line"><span class="number">1458</span>                    + <span class="string">": received="</span> + b.intent.received</span><br><span class="line"><span class="number">1459</span>                    + <span class="string">" apps="</span> + b.intent.apps.size()</span><br><span class="line"><span class="number">1460</span>                    + <span class="string">" doRebind="</span> + b.intent.doRebind);</span><br><span class="line"><span class="number">1461</span></span><br><span class="line"><span class="number">1462</span>            <span class="keyword">if</span> (s.app != <span class="keyword">null</span> &amp;&amp; b.intent.received) &#123;</span><br><span class="line"><span class="number">1463</span>                <span class="comment">// Service is already running, so we can immediately</span></span><br><span class="line"><span class="number">1464</span>                <span class="comment">// publish the connection.</span></span><br><span class="line"><span class="number">1465</span>                <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="number">1466</span>                    c.conn.connected(s.name, b.intent.binder, <span class="keyword">false</span>);</span><br><span class="line"><span class="number">1467</span>                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"><span class="number">1468</span>                    Slog.w(TAG, <span class="string">"Failure sending service "</span> + s.shortName</span><br><span class="line"><span class="number">1469</span>                            + <span class="string">" to connection "</span> + c.conn.asBinder()</span><br><span class="line"><span class="number">1470</span>                            + <span class="string">" (in "</span> + c.binding.client.processName + <span class="string">")"</span>, e);</span><br><span class="line"><span class="number">1471</span>                &#125;</span><br><span class="line"><span class="number">1472</span></span><br><span class="line"><span class="number">1473</span>                <span class="comment">// If this is the first app connected back to this binding,</span></span><br><span class="line"><span class="number">1474</span>                <span class="comment">// and the service had previously asked to be told when</span></span><br><span class="line"><span class="number">1475</span>                <span class="comment">// rebound, then do so.</span></span><br><span class="line"><span class="number">1476</span>                <span class="keyword">if</span> (b.intent.apps.size() == <span class="number">1</span> &amp;&amp; b.intent.doRebind) &#123;</span><br><span class="line"><span class="number">1477</span>                    requestServiceBindingLocked(s, b.intent, callerFg, <span class="keyword">true</span>);</span><br><span class="line"><span class="number">1478</span>                &#125;</span><br><span class="line"><span class="number">1479</span>            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!b.intent.requested) &#123;</span><br><span class="line"><span class="number">1480</span>                requestServiceBindingLocked(s, b.intent, callerFg, <span class="keyword">false</span>);</span><br><span class="line"><span class="number">1481</span>            &#125;</span><br><span class="line"><span class="number">1482</span></span><br><span class="line"><span class="number">1483</span>            getServiceMapLocked(s.userId).ensureNotStartingBackgroundLocked(s);</span><br><span class="line"><span class="number">1484</span></span><br><span class="line"><span class="number">1485</span>        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line"><span class="number">1486</span>            Binder.restoreCallingIdentity(origId);</span><br><span class="line"><span class="number">1487</span>        &#125;</span><br><span class="line"><span class="number">1488</span></span><br><span class="line"><span class="number">1489</span>        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"><span class="number">1490</span>    &#125;</span><br></pre></td></tr></table></figure></p>
<p>最后又调用了requestServiceBindingLocked：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">requestServiceBindingLocked</span><span class="params">(ServiceRecord r, IntentBindRecord i,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">1841</span>            <span class="keyword">boolean</span> execInFg, <span class="keyword">boolean</span> rebind)</span> <span class="keyword">throws</span> TransactionTooLargeException </span>&#123;</span><br><span class="line"><span class="number">1842</span>        <span class="keyword">if</span> (r.app == <span class="keyword">null</span> || r.app.thread == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">1843</span>            <span class="comment">// If service is not currently running, can't yet bind.</span></span><br><span class="line"><span class="number">1844</span>            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"><span class="number">1845</span>        &#125;</span><br><span class="line"><span class="number">1846</span>        <span class="keyword">if</span> (DEBUG_SERVICE) Slog.d(TAG_SERVICE, <span class="string">"requestBind "</span> + i + <span class="string">": requested="</span> + i.requested</span><br><span class="line"><span class="number">1847</span>                + <span class="string">" rebind="</span> + rebind);</span><br><span class="line"><span class="number">1848</span>        <span class="keyword">if</span> ((!i.requested || rebind) &amp;&amp; i.apps.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">1849</span>            <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="number">1850</span>                bumpServiceExecutingLocked(r, execInFg, <span class="string">"bind"</span>);</span><br><span class="line"><span class="number">1851</span>                r.app.forceProcessStateUpTo(ActivityManager.PROCESS_STATE_SERVICE);</span><br><span class="line"><span class="number">1852</span>                r.app.thread.scheduleBindService(r, i.intent.getIntent(), rebind,</span><br><span class="line"><span class="number">1853</span>                        r.app.repProcState);</span><br><span class="line"><span class="number">1854</span>                <span class="keyword">if</span> (!rebind) &#123;</span><br><span class="line"><span class="number">1855</span>                    i.requested = <span class="keyword">true</span>;</span><br><span class="line"><span class="number">1856</span>                &#125;</span><br><span class="line"><span class="number">1857</span>                i.hasBound = <span class="keyword">true</span>;</span><br><span class="line"><span class="number">1858</span>                i.doRebind = <span class="keyword">false</span>;</span><br><span class="line"><span class="number">1859</span>            &#125; <span class="keyword">catch</span> (TransactionTooLargeException e) &#123;</span><br><span class="line"><span class="number">1860</span>                <span class="comment">// Keep the executeNesting count accurate.</span></span><br><span class="line"><span class="number">1861</span>                <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"Crashed while binding "</span> + r, e);</span><br><span class="line"><span class="number">1862</span>                <span class="keyword">final</span> <span class="keyword">boolean</span> inDestroying = mDestroyingServices.contains(r);</span><br><span class="line"><span class="number">1863</span>                serviceDoneExecutingLocked(r, inDestroying, inDestroying);</span><br><span class="line"><span class="number">1864</span>                <span class="keyword">throw</span> e;</span><br><span class="line"><span class="number">1865</span>            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line"><span class="number">1866</span>                <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"Crashed while binding "</span> + r);</span><br><span class="line"><span class="number">1867</span>                <span class="comment">// Keep the executeNesting count accurate.</span></span><br><span class="line"><span class="number">1868</span>                <span class="keyword">final</span> <span class="keyword">boolean</span> inDestroying = mDestroyingServices.contains(r);</span><br><span class="line"><span class="number">1869</span>                serviceDoneExecutingLocked(r, inDestroying, inDestroying);</span><br><span class="line"><span class="number">1870</span>                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"><span class="number">1871</span>            &#125;</span><br><span class="line"><span class="number">1872</span>        &#125;</span><br><span class="line"><span class="number">1873</span>        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"><span class="number">1874</span>    &#125;</span><br></pre></td></tr></table></figure></p>
<p>r.app.thread.scheduleBindService会调用到ActivityThread中：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">scheduleBindService</span><span class="params">(IBinder token, Intent intent,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">853</span>                <span class="keyword">boolean</span> rebind, <span class="keyword">int</span> processState)</span> </span>&#123;</span><br><span class="line"><span class="number">854</span>            updateProcessState(processState, <span class="keyword">false</span>);</span><br><span class="line"><span class="number">855</span>            BindServiceData s = <span class="keyword">new</span> BindServiceData();</span><br><span class="line"><span class="number">856</span>            s.token = token;</span><br><span class="line"><span class="number">857</span>            s.intent = intent;</span><br><span class="line"><span class="number">858</span>            s.rebind = rebind;</span><br><span class="line"><span class="number">859</span></span><br><span class="line"><span class="number">860</span>            <span class="keyword">if</span> (DEBUG_SERVICE)</span><br><span class="line"><span class="number">861</span>                Slog.v(TAG, <span class="string">"scheduleBindService token="</span> + token + <span class="string">" intent="</span> + intent + <span class="string">" uid="</span></span><br><span class="line"><span class="number">862</span>                        + Binder.getCallingUid() + <span class="string">" pid="</span> + Binder.getCallingPid());</span><br><span class="line"><span class="number">863</span>            sendMessage(H.BIND_SERVICE, s);</span><br><span class="line"><span class="number">864</span>        &#125;</span><br></pre></td></tr></table></figure></p>
<p>对应的H中：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> BIND_SERVICE:</span><br><span class="line">Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"serviceBind"</span>);</span><br><span class="line">handleBindService((BindServiceData)msg.obj);</span><br><span class="line">Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line"><span class="keyword">break</span>;</span><br></pre></td></tr></table></figure></p>
<p>handleBindService中<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleBindService</span><span class="params">(BindServiceData data)</span> </span>&#123;</span><br><span class="line">Service s = mServices.get(data.token);</span><br><span class="line"><span class="keyword">if</span> (DEBUG_SERVICE)</span><br><span class="line">Slog.v(TAG, <span class="string">"handleBindService s="</span> + s + <span class="string">" rebind="</span> + data.rebind);</span><br><span class="line"><span class="keyword">if</span> (s != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">data.intent.setExtrasClassLoader(s.getClassLoader());</span><br><span class="line">data.intent.prepareToEnterProcess();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (!data.rebind) &#123;</span><br><span class="line">IBinder binder = s.onBind(data.intent);</span><br><span class="line">ActivityManagerNative.getDefault().publishService(</span><br><span class="line">data.token, data.intent, binder);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">s.onRebind(data.intent);</span><br><span class="line">ActivityManagerNative.getDefault().serviceDoneExecuting(</span><br><span class="line">data.token, SERVICE_DONE_EXECUTING_ANON, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line">ensureJitEnabled();</span><br><span class="line">&#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line"><span class="keyword">throw</span> ex.rethrowFromSystemServer();</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"><span class="keyword">if</span> (!mInstrumentation.onException(s, e)) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line"><span class="string">"Unable to bind to service "</span> + s</span><br><span class="line">+ <span class="string">" with "</span> + data.intent + <span class="string">": "</span> + e.toString(), e);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ActivityManagerNative.getDefault().publishService(<br>data.token, data.intent, binder),于是又回到了ActivityManagerService中（Binder机制）：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">publishService</span><span class="params">(IBinder token, Intent intent, IBinder service)</span> </span>&#123;</span><br><span class="line"><span class="number">18302</span>        <span class="comment">// Refuse possible leaked file descriptors</span></span><br><span class="line"><span class="number">18303</span>        <span class="keyword">if</span> (intent != <span class="keyword">null</span> &amp;&amp; intent.hasFileDescriptors() == <span class="keyword">true</span>) &#123;</span><br><span class="line"><span class="number">18304</span>            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"File descriptors passed in Intent"</span>);</span><br><span class="line"><span class="number">18305</span>        &#125;</span><br><span class="line"><span class="number">18306</span></span><br><span class="line"><span class="number">18307</span>        <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line"><span class="number">18308</span>            <span class="keyword">if</span> (!(token <span class="keyword">instanceof</span> ServiceRecord)) &#123;</span><br><span class="line"><span class="number">18309</span>                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Invalid service token"</span>);</span><br><span class="line"><span class="number">18310</span>            &#125;</span><br><span class="line"><span class="number">18311</span>            mServices.publishServiceLocked((ServiceRecord)token, intent, service);</span><br><span class="line"><span class="number">18312</span>        &#125;</span><br><span class="line"><span class="number">18313</span>    &#125;</span><br></pre></td></tr></table></figure></p>
<p>最后又调用到了mServices.publishServiceLocked，（<strong>ActiveServices.java</strong>）<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">publishServiceLocked</span><span class="params">(ServiceRecord r, Intent intent, IBinder service)</span> </span>&#123;</span><br><span class="line"><span class="number">1493</span>        <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</span><br><span class="line"><span class="number">1494</span>        <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="number">1495</span>            <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"PUBLISHING "</span> + r</span><br><span class="line"><span class="number">1496</span>                    + <span class="string">" "</span> + intent + <span class="string">": "</span> + service);</span><br><span class="line"><span class="number">1497</span>            <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">1498</span>                Intent.FilterComparison filter</span><br><span class="line"><span class="number">1499</span>                        = <span class="keyword">new</span> Intent.FilterComparison(intent);</span><br><span class="line"><span class="number">1500</span>                IntentBindRecord b = r.bindings.get(filter);</span><br><span class="line"><span class="number">1501</span>                <span class="keyword">if</span> (b != <span class="keyword">null</span> &amp;&amp; !b.received) &#123;</span><br><span class="line"><span class="number">1502</span>                    b.binder = service;</span><br><span class="line"><span class="number">1503</span>                    b.requested = <span class="keyword">true</span>;</span><br><span class="line"><span class="number">1504</span>                    b.received = <span class="keyword">true</span>;</span><br><span class="line"><span class="number">1505</span>                    <span class="keyword">for</span> (<span class="keyword">int</span> conni=r.connections.size()-<span class="number">1</span>; conni&gt;=<span class="number">0</span>; conni--) &#123;</span><br><span class="line"><span class="number">1506</span>                        ArrayList&lt;ConnectionRecord&gt; clist = r.connections.valueAt(conni);</span><br><span class="line"><span class="number">1507</span>                        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;clist.size(); i++) &#123;</span><br><span class="line"><span class="number">1508</span>                            ConnectionRecord c = clist.get(i);</span><br><span class="line"><span class="number">1509</span>                            <span class="keyword">if</span> (!filter.equals(c.binding.intent.intent)) &#123;</span><br><span class="line"><span class="number">1510</span>                                <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(</span><br><span class="line"><span class="number">1511</span>                                        TAG_SERVICE, <span class="string">"Not publishing to: "</span> + c);</span><br><span class="line"><span class="number">1512</span>                                <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(</span><br><span class="line"><span class="number">1513</span>                                        TAG_SERVICE, <span class="string">"Bound intent: "</span> + c.binding.intent.intent);</span><br><span class="line"><span class="number">1514</span>                                <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(</span><br><span class="line"><span class="number">1515</span>                                        TAG_SERVICE, <span class="string">"Published intent: "</span> + intent);</span><br><span class="line"><span class="number">1516</span>                                <span class="keyword">continue</span>;</span><br><span class="line"><span class="number">1517</span>                            &#125;</span><br><span class="line"><span class="number">1518</span>                            <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"Publishing to: "</span> + c);</span><br><span class="line"><span class="number">1519</span>                            <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="number">1520</span>                                c.conn.connected(r.name, service, <span class="keyword">false</span>);</span><br><span class="line"><span class="number">1521</span>                            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"><span class="number">1522</span>                                Slog.w(TAG, <span class="string">"Failure sending service "</span> + r.name +</span><br><span class="line"><span class="number">1523</span>                                      <span class="string">" to connection "</span> + c.conn.asBinder() +</span><br><span class="line"><span class="number">1524</span>                                      <span class="string">" (in "</span> + c.binding.client.processName + <span class="string">")"</span>, e);</span><br><span class="line"><span class="number">1525</span>                            &#125;</span><br><span class="line"><span class="number">1526</span>                        &#125;</span><br><span class="line"><span class="number">1527</span>                    &#125;</span><br><span class="line"><span class="number">1528</span>                &#125;</span><br><span class="line"><span class="number">1529</span></span><br><span class="line"><span class="number">1530</span>                serviceDoneExecutingLocked(r, mDestroyingServices.contains(r), <span class="keyword">false</span>);</span><br><span class="line"><span class="number">1531</span>            &#125;</span><br><span class="line"><span class="number">1532</span>        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line"><span class="number">1533</span>            Binder.restoreCallingIdentity(origId);</span><br><span class="line"><span class="number">1534</span>        &#125;</span><br><span class="line"><span class="number">1535</span>    &#125;</span><br></pre></td></tr></table></figure></p>
<p>c.conn.connected(r.name,service,false);就是调用的Service的connected</p>
<p><img src="http://opq81riyh.bkt.clouddn.com/bindService%20%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B.png" alt=""></p>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/24/基于8-0源码解析：startService-启动过程/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="吴晓龙">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://opq81riyh.bkt.clouddn.com/666.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="吴晓龙">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/24/基于8-0源码解析：startService-启动过程/" itemprop="url">基于8.0源码解析：startService 启动过程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-24T16:18:22+08:00">
                2018-01-24
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/源码解析/" itemprop="url" rel="index">
                    <span itemprop="name">源码解析</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="基于8-0源码解析：startService-启动过程"><a href="#基于8-0源码解析：startService-启动过程" class="headerlink" title="基于8.0源码解析：startService 启动过程"></a>基于8.0源码解析：startService 启动过程</h1><p>欢迎关注我的公众号：<br><img src="http://opq81riyh.bkt.clouddn.com/qrcode_for_gh_1d2b09f3edbf_258%20%282%29.jpg" alt=""></p>
<hr>
<p><img src="http://opq81riyh.bkt.clouddn.com/startservice.png" alt=""><br>调用startService 后会到ContextWrapper中：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ComponentName <span class="title">startService</span><span class="params">(Intent service)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> mBase.startService(service);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个mBase就是Context,然后到ContextImpl中看一眼：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="number">1459</span>    <span class="function"><span class="keyword">public</span> ComponentName <span class="title">startService</span><span class="params">(Intent service)</span> </span>&#123;</span><br><span class="line"><span class="number">1460</span>        warnIfCallingFromSystemProcess();</span><br><span class="line"><span class="number">1461</span>        <span class="keyword">return</span> startServiceCommon(service, <span class="keyword">false</span>, mUser);</span><br><span class="line"><span class="number">1462</span>    &#125;</span><br><span class="line"><span class="number">1463</span></span><br></pre></td></tr></table></figure></p>
<p>又调用了startServiceCommon<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> ComponentName <span class="title">startServiceCommon</span><span class="params">(Intent service, <span class="keyword">boolean</span> requireForeground,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">1487</span>            UserHandle user)</span> </span>&#123;</span><br><span class="line"><span class="number">1488</span>        <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="number">1489</span>            validateServiceIntent(service);</span><br><span class="line"><span class="number">1490</span>            service.prepareToLeaveProcess(<span class="keyword">this</span>);</span><br><span class="line"><span class="number">1491</span>            ComponentName cn = ActivityManager.getService().startService(</span><br><span class="line"><span class="number">1492</span>                mMainThread.getApplicationThread(), service, service.resolveTypeIfNeeded(</span><br><span class="line"><span class="number">1493</span>                            getContentResolver()), requireForeground,</span><br><span class="line"><span class="number">1494</span>                            getOpPackageName(), user.getIdentifier());</span><br><span class="line"><span class="number">1495</span>            <span class="keyword">if</span> (cn != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">1496</span>                <span class="keyword">if</span> (cn.getPackageName().equals(<span class="string">"!"</span>)) &#123;</span><br><span class="line"><span class="number">1497</span>                    <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(</span><br><span class="line"><span class="number">1498</span>                            <span class="string">"Not allowed to start service "</span> + service</span><br><span class="line"><span class="number">1499</span>                            + <span class="string">" without permission "</span> + cn.getClassName());</span><br><span class="line"><span class="number">1500</span>                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cn.getPackageName().equals(<span class="string">"!!"</span>)) &#123;</span><br><span class="line"><span class="number">1501</span>                    <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(</span><br><span class="line"><span class="number">1502</span>                            <span class="string">"Unable to start service "</span> + service</span><br><span class="line"><span class="number">1503</span>                            + <span class="string">": "</span> + cn.getClassName());</span><br><span class="line"><span class="number">1504</span>                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cn.getPackageName().equals(<span class="string">"?"</span>)) &#123;</span><br><span class="line"><span class="number">1505</span>                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line"><span class="number">1506</span>                            <span class="string">"Not allowed to start service "</span> + service + <span class="string">": "</span> + cn.getClassName());</span><br><span class="line"><span class="number">1507</span>                &#125;</span><br><span class="line"><span class="number">1508</span>            &#125;</span><br><span class="line"><span class="number">1509</span>            <span class="keyword">return</span> cn;</span><br><span class="line"><span class="number">1510</span>        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line"><span class="number">1511</span>            <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line"><span class="number">1512</span>        &#125;</span><br><span class="line"><span class="number">1513</span>    &#125;</span><br><span class="line"><span class="number">1514</span></span><br></pre></td></tr></table></figure></p>
<p>看到其中有这么一句：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ComponentName cn = ActivityManager.getService().startService(</span><br><span class="line"><span class="number">1492</span>                mMainThread.getApplicationThread(), service, service.resolveTypeIfNeeded(</span><br><span class="line"><span class="number">1493</span>                            getContentResolver()), requireForeground,</span><br><span class="line"><span class="number">1494</span>                            getOpPackageName(), user.getIdentifier());</span><br></pre></td></tr></table></figure></p>
<p>了解Binder机制的就会知道这会调用到ActivityManagerService中，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="number">18125</span>    <span class="function"><span class="keyword">public</span> ComponentName <span class="title">startService</span><span class="params">(IApplicationThread caller, Intent service,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">18126</span>            String resolvedType, <span class="keyword">boolean</span> requireForeground, String callingPackage, <span class="keyword">int</span> userId)</span></span></span><br><span class="line"><span class="function">18127            <span class="keyword">throws</span> TransactionTooLargeException </span>&#123;</span><br><span class="line"><span class="number">18128</span>        enforceNotIsolatedCaller(<span class="string">"startService"</span>);</span><br><span class="line"><span class="number">18129</span>        <span class="comment">// Refuse possible leaked file descriptors</span></span><br><span class="line"><span class="number">18130</span>        <span class="keyword">if</span> (service != <span class="keyword">null</span> &amp;&amp; service.hasFileDescriptors() == <span class="keyword">true</span>) &#123;</span><br><span class="line"><span class="number">18131</span>            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"File descriptors passed in Intent"</span>);</span><br><span class="line"><span class="number">18132</span>        &#125;</span><br><span class="line"><span class="number">18133</span></span><br><span class="line"><span class="number">18134</span>        <span class="keyword">if</span> (callingPackage == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">18135</span>            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"callingPackage cannot be null"</span>);</span><br><span class="line"><span class="number">18136</span>        &#125;</span><br><span class="line"><span class="number">18137</span></span><br><span class="line"><span class="number">18138</span>        <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE,</span><br><span class="line"><span class="number">18139</span>                <span class="string">"*** startService: "</span> + service + <span class="string">" type="</span> + resolvedType + <span class="string">" fg="</span> + requireForeground);</span><br><span class="line"><span class="number">18140</span>        <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line"><span class="number">18141</span>            <span class="keyword">final</span> <span class="keyword">int</span> callingPid = Binder.getCallingPid();</span><br><span class="line"><span class="number">18142</span>            <span class="keyword">final</span> <span class="keyword">int</span> callingUid = Binder.getCallingUid();</span><br><span class="line"><span class="number">18143</span>            <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</span><br><span class="line"><span class="number">18144</span>            ComponentName res;</span><br><span class="line"><span class="number">18145</span>            <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="number">18146</span>                res = mServices.startServiceLocked(caller, service,</span><br><span class="line"><span class="number">18147</span>                        resolvedType, callingPid, callingUid,</span><br><span class="line"><span class="number">18148</span>                        requireForeground, callingPackage, userId);</span><br><span class="line"><span class="number">18149</span>            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line"><span class="number">18150</span>                Binder.restoreCallingIdentity(origId);</span><br><span class="line"><span class="number">18151</span>            &#125;</span><br><span class="line"><span class="number">18152</span>            <span class="keyword">return</span> res;</span><br><span class="line"><span class="number">18153</span>        &#125;</span><br><span class="line"><span class="number">18154</span>    &#125;</span><br></pre></td></tr></table></figure>
<p>mServices.startServiceLocked<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ComponentName <span class="title">startServiceLocked</span><span class="params">(IApplicationThread caller, Intent service, String resolvedType,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">328</span>            <span class="keyword">int</span> callingPid, <span class="keyword">int</span> callingUid, <span class="keyword">boolean</span> fgRequired, String callingPackage, <span class="keyword">final</span> <span class="keyword">int</span> userId)</span></span></span><br><span class="line"><span class="function">329            <span class="keyword">throws</span> TransactionTooLargeException </span>&#123;</span><br><span class="line"><span class="number">330</span>        <span class="keyword">if</span> (DEBUG_DELAYED_STARTS) Slog.v(TAG_SERVICE, <span class="string">"startService: "</span> + service</span><br><span class="line"><span class="number">331</span>                + <span class="string">" type="</span> + resolvedType + <span class="string">" args="</span> + service.getExtras());</span><br><span class="line"><span class="number">332</span></span><br><span class="line"><span class="number">333</span>        <span class="keyword">final</span> <span class="keyword">boolean</span> callerFg;</span><br><span class="line"><span class="number">334</span>        <span class="keyword">if</span> (caller != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">335</span>            <span class="keyword">final</span> ProcessRecord callerApp = mAm.getRecordForAppLocked(caller);</span><br><span class="line"><span class="number">336</span>            <span class="keyword">if</span> (callerApp == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">337</span>                <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(</span><br><span class="line"><span class="number">338</span>                        <span class="string">"Unable to find app for caller "</span> + caller</span><br><span class="line"><span class="number">339</span>                        + <span class="string">" (pid="</span> + callingPid</span><br><span class="line"><span class="number">340</span>                        + <span class="string">") when starting service "</span> + service);</span><br><span class="line"><span class="number">341</span>            &#125;</span><br><span class="line"><span class="number">342</span>            callerFg = callerApp.setSchedGroup != ProcessList.SCHED_GROUP_BACKGROUND;</span><br><span class="line"><span class="number">343</span>        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="number">344</span>            callerFg = <span class="keyword">true</span>;</span><br><span class="line"><span class="number">345</span>        &#125;</span><br><span class="line"><span class="number">346</span></span><br><span class="line"><span class="number">347</span>        ServiceLookupResult res =</span><br><span class="line"><span class="number">348</span>            retrieveServiceLocked(service, resolvedType, callingPackage,</span><br><span class="line"><span class="number">349</span>                    callingPid, callingUid, userId, <span class="keyword">true</span>, callerFg, <span class="keyword">false</span>);</span><br><span class="line"><span class="number">350</span>        <span class="keyword">if</span> (res == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">351</span>            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"><span class="number">352</span>        &#125;</span><br><span class="line"><span class="number">353</span>        <span class="keyword">if</span> (res.record == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">354</span>            <span class="keyword">return</span> <span class="keyword">new</span> ComponentName(<span class="string">"!"</span>, res.permission != <span class="keyword">null</span></span><br><span class="line"><span class="number">355</span>                    ? res.permission : <span class="string">"private to package"</span>);</span><br><span class="line"><span class="number">356</span>        &#125;</span><br><span class="line"><span class="number">357</span></span><br><span class="line"><span class="number">358</span>        ServiceRecord r = res.record;</span><br><span class="line"><span class="number">359</span></span><br><span class="line"><span class="number">360</span>        <span class="keyword">if</span> (!mAm.mUserController.exists(r.userId)) &#123;</span><br><span class="line"><span class="number">361</span>            Slog.w(TAG, <span class="string">"Trying to start service with non-existent user! "</span> + r.userId);</span><br><span class="line"><span class="number">362</span>            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"><span class="number">363</span>        &#125;</span><br><span class="line"><span class="number">364</span></span><br><span class="line"><span class="number">365</span>        <span class="comment">// If this isn't a direct-to-foreground start, check our ability to kick off an</span></span><br><span class="line"><span class="number">366</span>        <span class="comment">// arbitrary service</span></span><br><span class="line"><span class="number">367</span>        <span class="keyword">if</span> (!r.startRequested &amp;&amp; !fgRequired) &#123;</span><br><span class="line"><span class="number">368</span>            <span class="comment">// Before going further -- if this app is not allowed to start services in the</span></span><br><span class="line"><span class="number">369</span>            <span class="comment">// background, then at this point we aren't going to let it period.</span></span><br><span class="line"><span class="number">370</span>            <span class="keyword">final</span> <span class="keyword">int</span> allowed = mAm.getAppStartModeLocked(r.appInfo.uid, r.packageName,</span><br><span class="line"><span class="number">371</span>                    r.appInfo.targetSdkVersion, callingPid, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line"><span class="number">372</span>            <span class="keyword">if</span> (allowed != ActivityManager.APP_START_MODE_NORMAL) &#123;</span><br><span class="line"><span class="number">373</span>                Slog.w(TAG, <span class="string">"Background start not allowed: service "</span></span><br><span class="line"><span class="number">374</span>                        + service + <span class="string">" to "</span> + r.name.flattenToShortString()</span><br><span class="line"><span class="number">375</span>                        + <span class="string">" from pid="</span> + callingPid + <span class="string">" uid="</span> + callingUid</span><br><span class="line"><span class="number">376</span>                        + <span class="string">" pkg="</span> + callingPackage);</span><br><span class="line"><span class="number">377</span>                <span class="keyword">if</span> (allowed == ActivityManager.APP_START_MODE_DELAYED) &#123;</span><br><span class="line"><span class="number">378</span>                    <span class="comment">// In this case we are silently disabling the app, to disrupt as</span></span><br><span class="line"><span class="number">379</span>                    <span class="comment">// little as possible existing apps.</span></span><br><span class="line"><span class="number">380</span>                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"><span class="number">381</span>                &#125;</span><br><span class="line"><span class="number">382</span>                <span class="comment">// This app knows it is in the new model where this operation is not</span></span><br><span class="line"><span class="number">383</span>                <span class="comment">// allowed, so tell it what has happened.</span></span><br><span class="line"><span class="number">384</span>                UidRecord uidRec = mAm.mActiveUids.get(r.appInfo.uid);</span><br><span class="line"><span class="number">385</span>                <span class="keyword">return</span> <span class="keyword">new</span> ComponentName(<span class="string">"?"</span>, <span class="string">"app is in background uid "</span> + uidRec);</span><br><span class="line"><span class="number">386</span>            &#125;</span><br><span class="line"><span class="number">387</span>        &#125;</span><br><span class="line"><span class="number">388</span></span><br><span class="line"><span class="number">389</span>        NeededUriGrants neededGrants = mAm.checkGrantUriPermissionFromIntentLocked(</span><br><span class="line"><span class="number">390</span>                callingUid, r.packageName, service, service.getFlags(), <span class="keyword">null</span>, r.userId);</span><br><span class="line"><span class="number">391</span></span><br><span class="line"><span class="number">392</span>        <span class="comment">// If permissions need a review before any of the app components can run,</span></span><br><span class="line"><span class="number">393</span>        <span class="comment">// we do not start the service and launch a review activity if the calling app</span></span><br><span class="line"><span class="number">394</span>        <span class="comment">// is in the foreground passing it a pending intent to start the service when</span></span><br><span class="line"><span class="number">395</span>        <span class="comment">// review is completed.</span></span><br><span class="line"><span class="number">396</span>        <span class="keyword">if</span> (mAm.mPermissionReviewRequired) &#123;</span><br><span class="line"><span class="number">397</span>            <span class="keyword">if</span> (!requestStartTargetPermissionsReviewIfNeededLocked(r, callingPackage,</span><br><span class="line"><span class="number">398</span>                    callingUid, service, callerFg, userId)) &#123;</span><br><span class="line"><span class="number">399</span>                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"><span class="number">400</span>            &#125;</span><br><span class="line"><span class="number">401</span>        &#125;</span><br><span class="line"><span class="number">402</span></span><br><span class="line"><span class="number">403</span>        <span class="keyword">if</span> (unscheduleServiceRestartLocked(r, callingUid, <span class="keyword">false</span>)) &#123;</span><br><span class="line"><span class="number">404</span>            <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"START SERVICE WHILE RESTART PENDING: "</span> + r);</span><br><span class="line"><span class="number">405</span>        &#125;</span><br><span class="line"><span class="number">406</span>        r.lastActivity = SystemClock.uptimeMillis();</span><br><span class="line"><span class="number">407</span>        r.startRequested = <span class="keyword">true</span>;</span><br><span class="line"><span class="number">408</span>        r.delayedStop = <span class="keyword">false</span>;</span><br><span class="line"><span class="number">409</span>        r.fgRequired = fgRequired;</span><br><span class="line"><span class="number">410</span>        r.pendingStarts.add(<span class="keyword">new</span> ServiceRecord.StartItem(r, <span class="keyword">false</span>, r.makeNextStartId(),</span><br><span class="line"><span class="number">411</span>                service, neededGrants, callingUid));</span><br><span class="line"><span class="number">412</span></span><br><span class="line"><span class="number">413</span>        <span class="keyword">final</span> ServiceMap smap = getServiceMapLocked(r.userId);</span><br><span class="line"><span class="number">414</span>        <span class="keyword">boolean</span> addToStarting = <span class="keyword">false</span>;</span><br><span class="line"><span class="number">415</span>        <span class="keyword">if</span> (!callerFg &amp;&amp; !fgRequired &amp;&amp; r.app == <span class="keyword">null</span></span><br><span class="line"><span class="number">416</span>                &amp;&amp; mAm.mUserController.hasStartedUserState(r.userId)) &#123;</span><br><span class="line"><span class="number">417</span>            ProcessRecord proc = mAm.getProcessRecordLocked(r.processName, r.appInfo.uid, <span class="keyword">false</span>);</span><br><span class="line"><span class="number">418</span>            <span class="keyword">if</span> (proc == <span class="keyword">null</span> || proc.curProcState &gt; ActivityManager.PROCESS_STATE_RECEIVER) &#123;</span><br><span class="line"><span class="number">419</span>                <span class="comment">// If this is not coming from a foreground caller, then we may want</span></span><br><span class="line"><span class="number">420</span>                <span class="comment">// to delay the start if there are already other background services</span></span><br><span class="line"><span class="number">421</span>                <span class="comment">// that are starting.  This is to avoid process start spam when lots</span></span><br><span class="line"><span class="number">422</span>                <span class="comment">// of applications are all handling things like connectivity broadcasts.</span></span><br><span class="line"><span class="number">423</span>                <span class="comment">// We only do this for cached processes, because otherwise an application</span></span><br><span class="line"><span class="number">424</span>                <span class="comment">// can have assumptions about calling startService() for a service to run</span></span><br><span class="line"><span class="number">425</span>                <span class="comment">// in its own process, and for that process to not be killed before the</span></span><br><span class="line"><span class="number">426</span>                <span class="comment">// service is started.  This is especially the case for receivers, which</span></span><br><span class="line"><span class="number">427</span>                <span class="comment">// may start a service in onReceive() to do some additional work and have</span></span><br><span class="line"><span class="number">428</span>                <span class="comment">// initialized some global state as part of that.</span></span><br><span class="line"><span class="number">429</span>                <span class="keyword">if</span> (DEBUG_DELAYED_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"Potential start delay of "</span></span><br><span class="line"><span class="number">430</span>                        + r + <span class="string">" in "</span> + proc);</span><br><span class="line"><span class="number">431</span>                <span class="keyword">if</span> (r.delayed) &#123;</span><br><span class="line"><span class="number">432</span>                    <span class="comment">// This service is already scheduled for a delayed start; just leave</span></span><br><span class="line"><span class="number">433</span>                    <span class="comment">// it still waiting.</span></span><br><span class="line"><span class="number">434</span>                    <span class="keyword">if</span> (DEBUG_DELAYED_STARTS) Slog.v(TAG_SERVICE, <span class="string">"Continuing to delay: "</span> + r);</span><br><span class="line"><span class="number">435</span>                    <span class="keyword">return</span> r.name;</span><br><span class="line"><span class="number">436</span>                &#125;</span><br><span class="line"><span class="number">437</span>                <span class="keyword">if</span> (smap.mStartingBackground.size() &gt;= mMaxStartingBackground) &#123;</span><br><span class="line"><span class="number">438</span>                    <span class="comment">// Something else is starting, delay!</span></span><br><span class="line"><span class="number">439</span>                    Slog.i(TAG_SERVICE, <span class="string">"Delaying start of: "</span> + r);</span><br><span class="line"><span class="number">440</span>                    smap.mDelayedStartList.add(r);</span><br><span class="line"><span class="number">441</span>                    r.delayed = <span class="keyword">true</span>;</span><br><span class="line"><span class="number">442</span>                    <span class="keyword">return</span> r.name;</span><br><span class="line"><span class="number">443</span>                &#125;</span><br><span class="line"><span class="number">444</span>                <span class="keyword">if</span> (DEBUG_DELAYED_STARTS) Slog.v(TAG_SERVICE, <span class="string">"Not delaying: "</span> + r);</span><br><span class="line"><span class="number">445</span>                addToStarting = <span class="keyword">true</span>;</span><br><span class="line"><span class="number">446</span>            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (proc.curProcState &gt;= ActivityManager.PROCESS_STATE_SERVICE) &#123;</span><br><span class="line"><span class="number">447</span>                <span class="comment">// We slightly loosen when we will enqueue this new service as a background</span></span><br><span class="line"><span class="number">448</span>                <span class="comment">// starting service we are waiting for, to also include processes that are</span></span><br><span class="line"><span class="number">449</span>                <span class="comment">// currently running other services or receivers.</span></span><br><span class="line"><span class="number">450</span>                addToStarting = <span class="keyword">true</span>;</span><br><span class="line"><span class="number">451</span>                <span class="keyword">if</span> (DEBUG_DELAYED_STARTS) Slog.v(TAG_SERVICE,</span><br><span class="line"><span class="number">452</span>                        <span class="string">"Not delaying, but counting as bg: "</span> + r);</span><br><span class="line"><span class="number">453</span>            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (DEBUG_DELAYED_STARTS) &#123;</span><br><span class="line"><span class="number">454</span>                StringBuilder sb = <span class="keyword">new</span> StringBuilder(<span class="number">128</span>);</span><br><span class="line"><span class="number">455</span>                sb.append(<span class="string">"Not potential delay (state="</span>).append(proc.curProcState)</span><br><span class="line"><span class="number">456</span>                        .append(<span class="string">' '</span>).append(proc.adjType);</span><br><span class="line"><span class="number">457</span>                String reason = proc.makeAdjReason();</span><br><span class="line"><span class="number">458</span>                <span class="keyword">if</span> (reason != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">459</span>                    sb.append(<span class="string">' '</span>);</span><br><span class="line"><span class="number">460</span>                    sb.append(reason);</span><br><span class="line"><span class="number">461</span>                &#125;</span><br><span class="line"><span class="number">462</span>                sb.append(<span class="string">"): "</span>);</span><br><span class="line"><span class="number">463</span>                sb.append(r.toString());</span><br><span class="line"><span class="number">464</span>                Slog.v(TAG_SERVICE, sb.toString());</span><br><span class="line"><span class="number">465</span>            &#125;</span><br><span class="line"><span class="number">466</span>        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (DEBUG_DELAYED_STARTS) &#123;</span><br><span class="line"><span class="number">467</span>            <span class="keyword">if</span> (callerFg || fgRequired) &#123;</span><br><span class="line"><span class="number">468</span>                Slog.v(TAG_SERVICE, <span class="string">"Not potential delay (callerFg="</span> + callerFg + <span class="string">" uid="</span></span><br><span class="line"><span class="number">469</span>                        + callingUid + <span class="string">" pid="</span> + callingPid + <span class="string">" fgRequired="</span> + fgRequired + <span class="string">"): "</span> + r);</span><br><span class="line"><span class="number">470</span>            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r.app != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">471</span>                Slog.v(TAG_SERVICE, <span class="string">"Not potential delay (cur app="</span> + r.app + <span class="string">"): "</span> + r);</span><br><span class="line"><span class="number">472</span>            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="number">473</span>                Slog.v(TAG_SERVICE,</span><br><span class="line"><span class="number">474</span>                        <span class="string">"Not potential delay (user "</span> + r.userId + <span class="string">" not started): "</span> + r);</span><br><span class="line"><span class="number">475</span>            &#125;</span><br><span class="line"><span class="number">476</span>        &#125;</span><br><span class="line"><span class="number">477</span></span><br><span class="line"><span class="number">478</span>        ComponentName cmp = startServiceInnerLocked(smap, service, r, callerFg, addToStarting);</span><br><span class="line"><span class="number">479</span>        <span class="keyword">return</span> cmp;</span><br><span class="line"><span class="number">480</span>    &#125;</span><br></pre></td></tr></table></figure></p>
<p>最后调用了ComponentName cmp = startServiceInnerLocked(smap, service, r, callerFg, addToStarting);<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ComponentName <span class="title">startServiceInnerLocked</span><span class="params">(ServiceMap smap, Intent service, ServiceRecord r,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">527</span>            <span class="keyword">boolean</span> callerFg, <span class="keyword">boolean</span> addToStarting)</span> <span class="keyword">throws</span> TransactionTooLargeException </span>&#123;</span><br><span class="line"><span class="number">528</span>        ServiceState stracker = r.getTracker();</span><br><span class="line"><span class="number">529</span>        <span class="keyword">if</span> (stracker != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">530</span>            stracker.setStarted(<span class="keyword">true</span>, mAm.mProcessStats.getMemFactorLocked(), r.lastActivity);</span><br><span class="line"><span class="number">531</span>        &#125;</span><br><span class="line"><span class="number">532</span>        r.callStart = <span class="keyword">false</span>;</span><br><span class="line"><span class="number">533</span>        <span class="keyword">synchronized</span> (r.stats.getBatteryStats()) &#123;</span><br><span class="line"><span class="number">534</span>            r.stats.startRunningLocked();</span><br><span class="line"><span class="number">535</span>        &#125;</span><br><span class="line"><span class="number">536</span>        String error = bringUpServiceLocked(r, service.getFlags(), callerFg, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line"><span class="number">537</span>        <span class="keyword">if</span> (error != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">538</span>            <span class="keyword">return</span> <span class="keyword">new</span> ComponentName(<span class="string">"!!"</span>, error);</span><br><span class="line"><span class="number">539</span>        &#125;</span><br><span class="line"><span class="number">540</span></span><br><span class="line"><span class="number">541</span>        <span class="keyword">if</span> (r.startRequested &amp;&amp; addToStarting) &#123;</span><br><span class="line"><span class="number">542</span>            <span class="keyword">boolean</span> first = smap.mStartingBackground.size() == <span class="number">0</span>;</span><br><span class="line"><span class="number">543</span>            smap.mStartingBackground.add(r);</span><br><span class="line"><span class="number">544</span>            r.startingBgTimeout = SystemClock.uptimeMillis() + mAm.mConstants.BG_START_TIMEOUT;</span><br><span class="line"><span class="number">545</span>            <span class="keyword">if</span> (DEBUG_DELAYED_SERVICE) &#123;</span><br><span class="line"><span class="number">546</span>                RuntimeException here = <span class="keyword">new</span> RuntimeException(<span class="string">"here"</span>);</span><br><span class="line"><span class="number">547</span>                here.fillInStackTrace();</span><br><span class="line"><span class="number">548</span>                Slog.v(TAG_SERVICE, <span class="string">"Starting background (first="</span> + first + <span class="string">"): "</span> + r, here);</span><br><span class="line"><span class="number">549</span>            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (DEBUG_DELAYED_STARTS) &#123;</span><br><span class="line"><span class="number">550</span>                Slog.v(TAG_SERVICE, <span class="string">"Starting background (first="</span> + first + <span class="string">"): "</span> + r);</span><br><span class="line"><span class="number">551</span>            &#125;</span><br><span class="line"><span class="number">552</span>            <span class="keyword">if</span> (first) &#123;</span><br><span class="line"><span class="number">553</span>                smap.rescheduleDelayedStartsLocked();</span><br><span class="line"><span class="number">554</span>            &#125;</span><br><span class="line"><span class="number">555</span>        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (callerFg || r.fgRequired) &#123;</span><br><span class="line"><span class="number">556</span>            smap.ensureNotStartingBackgroundLocked(r);</span><br><span class="line"><span class="number">557</span>        &#125;</span><br><span class="line"><span class="number">558</span></span><br><span class="line"><span class="number">559</span>        <span class="keyword">return</span> r.name;</span><br><span class="line"><span class="number">560</span>    &#125;</span><br></pre></td></tr></table></figure></p>
<p>这个方法中又调用到了 String error = bringUpServiceLocked(r, service.getFlags(), callerFg, false, false);<br>然后掉用到：<br>sendServiceArgsLocked(r, execInFg, false);<br>进而调用到：<br>realStartServiceLocked(r, app, execInFg);<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">realStartServiceLocked</span><span class="params">(ServiceRecord r,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">2190</span>            ProcessRecord app, <span class="keyword">boolean</span> execInFg)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line"><span class="number">2191</span>        <span class="keyword">if</span> (app.thread == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">2192</span>            <span class="keyword">throw</span> <span class="keyword">new</span> RemoteException();</span><br><span class="line"><span class="number">2193</span>        &#125;</span><br><span class="line"><span class="number">2194</span>        <span class="keyword">if</span> (DEBUG_MU)</span><br><span class="line"><span class="number">2195</span>            Slog.v(TAG_MU, <span class="string">"realStartServiceLocked, ServiceRecord.uid = "</span> + r.appInfo.uid</span><br><span class="line"><span class="number">2196</span>                    + <span class="string">", ProcessRecord.uid = "</span> + app.uid);</span><br><span class="line"><span class="number">2197</span>        r.app = app;</span><br><span class="line"><span class="number">2198</span>        r.restartTime = r.lastActivity = SystemClock.uptimeMillis();</span><br><span class="line"><span class="number">2199</span></span><br><span class="line"><span class="number">2200</span>        <span class="keyword">final</span> <span class="keyword">boolean</span> newService = app.services.add(r);</span><br><span class="line"><span class="number">2201</span>        bumpServiceExecutingLocked(r, execInFg, <span class="string">"create"</span>);</span><br><span class="line"><span class="number">2202</span>        mAm.updateLruProcessLocked(app, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line"><span class="number">2203</span>        updateServiceForegroundLocked(r.app, <span class="comment">/* oomAdj= */</span> <span class="keyword">false</span>);</span><br><span class="line"><span class="number">2204</span>        mAm.updateOomAdjLocked();</span><br><span class="line"><span class="number">2205</span></span><br><span class="line"><span class="number">2206</span>        <span class="keyword">boolean</span> created = <span class="keyword">false</span>;</span><br><span class="line"><span class="number">2207</span>        <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="number">2208</span>            <span class="keyword">if</span> (LOG_SERVICE_START_STOP) &#123;</span><br><span class="line"><span class="number">2209</span>                String nameTerm;</span><br><span class="line"><span class="number">2210</span>                <span class="keyword">int</span> lastPeriod = r.shortName.lastIndexOf(<span class="string">'.'</span>);</span><br><span class="line"><span class="number">2211</span>                nameTerm = lastPeriod &gt;= <span class="number">0</span> ? r.shortName.substring(lastPeriod) : r.shortName;</span><br><span class="line"><span class="number">2212</span>                EventLogTags.writeAmCreateService(</span><br><span class="line"><span class="number">2213</span>                        r.userId, System.identityHashCode(r), nameTerm, r.app.uid, r.app.pid);</span><br><span class="line"><span class="number">2214</span>            &#125;</span><br><span class="line"><span class="number">2215</span>            <span class="keyword">synchronized</span> (r.stats.getBatteryStats()) &#123;</span><br><span class="line"><span class="number">2216</span>                r.stats.startLaunchedLocked();</span><br><span class="line"><span class="number">2217</span>            &#125;</span><br><span class="line"><span class="number">2218</span>            mAm.notifyPackageUse(r.serviceInfo.packageName,</span><br><span class="line"><span class="number">2219</span>                                 PackageManager.NOTIFY_PACKAGE_USE_SERVICE);</span><br><span class="line"><span class="number">2220</span>            app.forceProcessStateUpTo(ActivityManager.PROCESS_STATE_SERVICE);</span><br><span class="line"><span class="number">2221</span>            app.thread.scheduleCreateService(r, r.serviceInfo,</span><br><span class="line"><span class="number">2222</span>                    mAm.compatibilityInfoForPackageLocked(r.serviceInfo.applicationInfo),</span><br><span class="line"><span class="number">2223</span>                    app.repProcState);</span><br><span class="line"><span class="number">2224</span>            r.postNotification();</span><br><span class="line"><span class="number">2225</span>            created = <span class="keyword">true</span>;</span><br><span class="line"><span class="number">2226</span>        &#125; <span class="keyword">catch</span> (DeadObjectException e) &#123;</span><br><span class="line"><span class="number">2227</span>            Slog.w(TAG, <span class="string">"Application dead when creating service "</span> + r);</span><br><span class="line"><span class="number">2228</span>            mAm.appDiedLocked(app);</span><br><span class="line"><span class="number">2229</span>            <span class="keyword">throw</span> e;</span><br><span class="line"><span class="number">2230</span>        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line"><span class="number">2231</span>            <span class="keyword">if</span> (!created) &#123;</span><br><span class="line"><span class="number">2232</span>                <span class="comment">// Keep the executeNesting count accurate.</span></span><br><span class="line"><span class="number">2233</span>                <span class="keyword">final</span> <span class="keyword">boolean</span> inDestroying = mDestroyingServices.contains(r);</span><br><span class="line"><span class="number">2234</span>                serviceDoneExecutingLocked(r, inDestroying, inDestroying);</span><br><span class="line"><span class="number">2235</span></span><br><span class="line"><span class="number">2236</span>                <span class="comment">// Cleanup.</span></span><br><span class="line"><span class="number">2237</span>                <span class="keyword">if</span> (newService) &#123;</span><br><span class="line"><span class="number">2238</span>                    app.services.remove(r);</span><br><span class="line"><span class="number">2239</span>                    r.app = <span class="keyword">null</span>;</span><br><span class="line"><span class="number">2240</span>                &#125;</span><br><span class="line"><span class="number">2241</span></span><br><span class="line"><span class="number">2242</span>                <span class="comment">// Retry.</span></span><br><span class="line"><span class="number">2243</span>                <span class="keyword">if</span> (!inDestroying) &#123;</span><br><span class="line"><span class="number">2244</span>                    scheduleServiceRestartLocked(r, <span class="keyword">false</span>);</span><br><span class="line"><span class="number">2245</span>                &#125;</span><br><span class="line"><span class="number">2246</span>            &#125;</span><br><span class="line"><span class="number">2247</span>        &#125;</span><br><span class="line"><span class="number">2248</span></span><br><span class="line"><span class="number">2249</span>        <span class="keyword">if</span> (r.whitelistManager) &#123;</span><br><span class="line"><span class="number">2250</span>            app.whitelistManager = <span class="keyword">true</span>;</span><br><span class="line"><span class="number">2251</span>        &#125;</span><br><span class="line"><span class="number">2252</span></span><br><span class="line"><span class="number">2253</span>        requestServiceBindingsLocked(r, execInFg);</span><br><span class="line"><span class="number">2254</span></span><br><span class="line"><span class="number">2255</span>        updateServiceClientActivitiesLocked(app, <span class="keyword">null</span>, <span class="keyword">true</span>);</span><br><span class="line"><span class="number">2256</span></span><br><span class="line"><span class="number">2257</span>        <span class="comment">// If the service is in the started state, and there are no</span></span><br><span class="line"><span class="number">2258</span>        <span class="comment">// pending arguments, then fake up one so its onStartCommand() will</span></span><br><span class="line"><span class="number">2259</span>        <span class="comment">// be called.</span></span><br><span class="line"><span class="number">2260</span>        <span class="keyword">if</span> (r.startRequested &amp;&amp; r.callStart &amp;&amp; r.pendingStarts.size() == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">2261</span>            r.pendingStarts.add(<span class="keyword">new</span> ServiceRecord.StartItem(r, <span class="keyword">false</span>, r.makeNextStartId(),</span><br><span class="line"><span class="number">2262</span>                    <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="number">0</span>));</span><br><span class="line"><span class="number">2263</span>        &#125;</span><br><span class="line"><span class="number">2264</span></span><br><span class="line"><span class="number">2265</span>        sendServiceArgsLocked(r, execInFg, <span class="keyword">true</span>);</span><br><span class="line"><span class="number">2266</span></span><br><span class="line"><span class="number">2267</span>        <span class="keyword">if</span> (r.delayed) &#123;</span><br><span class="line"><span class="number">2268</span>            <span class="keyword">if</span> (DEBUG_DELAYED_STARTS) Slog.v(TAG_SERVICE, <span class="string">"REM FR DELAY LIST (new proc): "</span> + r);</span><br><span class="line"><span class="number">2269</span>            getServiceMapLocked(r.userId).mDelayedStartList.remove(r);</span><br><span class="line"><span class="number">2270</span>            r.delayed = <span class="keyword">false</span>;</span><br><span class="line"><span class="number">2271</span>        &#125;</span><br><span class="line"><span class="number">2272</span></span><br><span class="line"><span class="number">2273</span>        <span class="keyword">if</span> (r.delayedStop) &#123;</span><br><span class="line"><span class="number">2274</span>            <span class="comment">// Oh and hey we've already been asked to stop!</span></span><br><span class="line"><span class="number">2275</span>            r.delayedStop = <span class="keyword">false</span>;</span><br><span class="line"><span class="number">2276</span>            <span class="keyword">if</span> (r.startRequested) &#123;</span><br><span class="line"><span class="number">2277</span>                <span class="keyword">if</span> (DEBUG_DELAYED_STARTS) Slog.v(TAG_SERVICE,</span><br><span class="line"><span class="number">2278</span>                        <span class="string">"Applying delayed stop (from start): "</span> + r);</span><br><span class="line"><span class="number">2279</span>                stopServiceLocked(r);</span><br><span class="line"><span class="number">2280</span>            &#125;</span><br><span class="line"><span class="number">2281</span>        &#125;</span><br><span class="line"><span class="number">2282</span>    &#125;</span><br></pre></td></tr></table></figure></p>
<p>app.thread.scheduleCreateService,这个thread就是IApplicationThread，就是ActivityThread对象，于是我们回到ActivityThread中：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">scheduleCreateService</span><span class="params">(IBinder token,</span></span></span><br><span class="line"><span class="function"><span class="params">ServiceInfo info, CompatibilityInfo compatInfo, <span class="keyword">int</span> processState)</span> </span>&#123;</span><br><span class="line">updateProcessState(processState, <span class="keyword">false</span>);</span><br><span class="line">CreateServiceData s = <span class="keyword">new</span> CreateServiceData();</span><br><span class="line">s.token = token;</span><br><span class="line">s.info = info;</span><br><span class="line">s.compatInfo = compatInfo;</span><br><span class="line"></span><br><span class="line">sendMessage(H.CREATE_SERVICE, s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们去到H中找到对应的handleMessage处理CREATE_SERVICE的方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> CREATE_SERVICE:</span><br><span class="line">Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, (<span class="string">"serviceCreate: "</span> + String.valueOf(msg.obj)));</span><br><span class="line">handleCreateService((CreateServiceData)msg.obj);</span><br><span class="line">Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line"><span class="keyword">break</span>;</span><br></pre></td></tr></table></figure></p>
<p>然后handleCreateService：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleCreateService</span><span class="params">(CreateServiceData data)</span> </span>&#123;</span><br><span class="line"><span class="comment">// If we are getting ready to gc after going to the background, well</span></span><br><span class="line"><span class="comment">// we are back active so skip it.</span></span><br><span class="line">unscheduleGcIdler();</span><br><span class="line"></span><br><span class="line">LoadedApk packageInfo = getPackageInfoNoCheck(</span><br><span class="line">data.info.applicationInfo, data.compatInfo);</span><br><span class="line">Service service = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">java.lang.ClassLoader cl = packageInfo.getClassLoader();</span><br><span class="line">service = (Service) cl.loadClass(data.info.name).newInstance();</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"><span class="keyword">if</span> (!mInstrumentation.onException(service, e)) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line"><span class="string">"Unable to instantiate service "</span> + data.info.name</span><br><span class="line">+ <span class="string">": "</span> + e.toString(), e);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (localLOGV) Slog.v(TAG, <span class="string">"Creating service "</span> + data.info.name);</span><br><span class="line"></span><br><span class="line">ContextImpl context = ContextImpl.createAppContext(<span class="keyword">this</span>, packageInfo);</span><br><span class="line">context.setOuterContext(service);</span><br><span class="line"></span><br><span class="line">Application app = packageInfo.makeApplication(<span class="keyword">false</span>, mInstrumentation);</span><br><span class="line">service.attach(context, <span class="keyword">this</span>, data.info.name, data.token, app,</span><br><span class="line">ActivityManagerNative.getDefault());</span><br><span class="line">service.onCreate();</span><br><span class="line">mServices.put(data.token, service);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">ActivityManagerNative.getDefault().serviceDoneExecuting(</span><br><span class="line">data.token, SERVICE_DONE_EXECUTING_ANON, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line"><span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"><span class="keyword">if</span> (!mInstrumentation.onException(service, e)) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line"><span class="string">"Unable to create service "</span> + data.info.name</span><br><span class="line">+ <span class="string">": "</span> + e.toString(), e);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个方法中service = (Service) cl.loadClass(data.info.name).newInstance();<br>用反射的方式创建了service对象；<br>然后ContextImpl context = ContextImpl.createAppContext(this, packageInfo);又创建了context对象；<br>然后用service.attach将context对象进行参数设置；<br>然后就调用了service.onCreate();<br>这就是Service的启动过程。</p>
<p>在刚刚realStartServiceLocked方法中：调用了 app.thread.scheduleCreateService方法后又调用了：<br>sendServiceArgsLocked(r, execInFg, true);<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">sendServiceArgsLocked</span><span class="params">(ServiceRecord r, <span class="keyword">boolean</span> execInFg,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">2285</span>            <span class="keyword">boolean</span> oomAdjusted)</span> <span class="keyword">throws</span> TransactionTooLargeException </span>&#123;</span><br><span class="line"><span class="number">2286</span>        <span class="keyword">final</span> <span class="keyword">int</span> N = r.pendingStarts.size();</span><br><span class="line"><span class="number">2287</span>        <span class="keyword">if</span> (N == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">2288</span>            <span class="keyword">return</span>;</span><br><span class="line"><span class="number">2289</span>        &#125;</span><br><span class="line"><span class="number">2290</span></span><br><span class="line"><span class="number">2291</span>        ArrayList&lt;ServiceStartArgs&gt; args = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"><span class="number">2292</span></span><br><span class="line"><span class="number">2293</span>        <span class="keyword">while</span> (r.pendingStarts.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">2294</span>            ServiceRecord.StartItem si = r.pendingStarts.remove(<span class="number">0</span>);</span><br><span class="line"><span class="number">2295</span>            <span class="keyword">if</span> (DEBUG_SERVICE) &#123;</span><br><span class="line"><span class="number">2296</span>                Slog.v(TAG_SERVICE, <span class="string">"Sending arguments to: "</span></span><br><span class="line"><span class="number">2297</span>                        + r + <span class="string">" "</span> + r.intent + <span class="string">" args="</span> + si.intent);</span><br><span class="line"><span class="number">2298</span>            &#125;</span><br><span class="line"><span class="number">2299</span>            <span class="keyword">if</span> (si.intent == <span class="keyword">null</span> &amp;&amp; N &gt; <span class="number">1</span>) &#123;</span><br><span class="line"><span class="number">2300</span>                <span class="comment">// If somehow we got a dummy null intent in the middle,</span></span><br><span class="line"><span class="number">2301</span>                <span class="comment">// then skip it.  DO NOT skip a null intent when it is</span></span><br><span class="line"><span class="number">2302</span>                <span class="comment">// the only one in the list -- this is to support the</span></span><br><span class="line"><span class="number">2303</span>                <span class="comment">// onStartCommand(null) case.</span></span><br><span class="line"><span class="number">2304</span>                <span class="keyword">continue</span>;</span><br><span class="line"><span class="number">2305</span>            &#125;</span><br><span class="line"><span class="number">2306</span>            si.deliveredTime = SystemClock.uptimeMillis();</span><br><span class="line"><span class="number">2307</span>            r.deliveredStarts.add(si);</span><br><span class="line"><span class="number">2308</span>            si.deliveryCount++;</span><br><span class="line"><span class="number">2309</span>            <span class="keyword">if</span> (si.neededGrants != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">2310</span>                mAm.grantUriPermissionUncheckedFromIntentLocked(si.neededGrants,</span><br><span class="line"><span class="number">2311</span>                        si.getUriPermissionsLocked());</span><br><span class="line"><span class="number">2312</span>            &#125;</span><br><span class="line"><span class="number">2313</span>            mAm.grantEphemeralAccessLocked(r.userId, si.intent,</span><br><span class="line"><span class="number">2314</span>                    r.appInfo.uid, UserHandle.getAppId(si.callingId));</span><br><span class="line"><span class="number">2315</span>            bumpServiceExecutingLocked(r, execInFg, <span class="string">"start"</span>);</span><br><span class="line"><span class="number">2316</span>            <span class="keyword">if</span> (!oomAdjusted) &#123;</span><br><span class="line"><span class="number">2317</span>                oomAdjusted = <span class="keyword">true</span>;</span><br><span class="line"><span class="number">2318</span>                mAm.updateOomAdjLocked(r.app, <span class="keyword">true</span>);</span><br><span class="line"><span class="number">2319</span>            &#125;</span><br><span class="line"><span class="number">2320</span>            <span class="keyword">if</span> (r.fgRequired &amp;&amp; !r.fgWaiting) &#123;</span><br><span class="line"><span class="number">2321</span>                <span class="keyword">if</span> (!r.isForeground) &#123;</span><br><span class="line"><span class="number">2322</span>                    <span class="keyword">if</span> (DEBUG_BACKGROUND_CHECK) &#123;</span><br><span class="line"><span class="number">2323</span>                        Slog.i(TAG, <span class="string">"Launched service must call startForeground() within timeout: "</span> + r);</span><br><span class="line"><span class="number">2324</span>                    &#125;</span><br><span class="line"><span class="number">2325</span>                    scheduleServiceForegroundTransitionTimeoutLocked(r);</span><br><span class="line"><span class="number">2326</span>                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="number">2327</span>                    <span class="keyword">if</span> (DEBUG_BACKGROUND_CHECK) &#123;</span><br><span class="line"><span class="number">2328</span>                        Slog.i(TAG, <span class="string">"Service already foreground; no new timeout: "</span> + r);</span><br><span class="line"><span class="number">2329</span>                    &#125;</span><br><span class="line"><span class="number">2330</span>                    r.fgRequired = <span class="keyword">false</span>;</span><br><span class="line"><span class="number">2331</span>                &#125;</span><br><span class="line"><span class="number">2332</span>            &#125;</span><br><span class="line"><span class="number">2333</span>            <span class="keyword">int</span> flags = <span class="number">0</span>;</span><br><span class="line"><span class="number">2334</span>            <span class="keyword">if</span> (si.deliveryCount &gt; <span class="number">1</span>) &#123;</span><br><span class="line"><span class="number">2335</span>                flags |= Service.START_FLAG_RETRY;</span><br><span class="line"><span class="number">2336</span>            &#125;</span><br><span class="line"><span class="number">2337</span>            <span class="keyword">if</span> (si.doneExecutingCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">2338</span>                flags |= Service.START_FLAG_REDELIVERY;</span><br><span class="line"><span class="number">2339</span>            &#125;</span><br><span class="line"><span class="number">2340</span>            args.add(<span class="keyword">new</span> ServiceStartArgs(si.taskRemoved, si.id, flags, si.intent));</span><br><span class="line"><span class="number">2341</span>        &#125;</span><br><span class="line"><span class="number">2342</span></span><br><span class="line"><span class="number">2343</span>        ParceledListSlice&lt;ServiceStartArgs&gt; slice = <span class="keyword">new</span> ParceledListSlice&lt;&gt;(args);</span><br><span class="line"><span class="number">2344</span>        slice.setInlineCountLimit(<span class="number">4</span>);</span><br><span class="line"><span class="number">2345</span>        Exception caughtException = <span class="keyword">null</span>;</span><br><span class="line"><span class="number">2346</span>        <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="number">2347</span>            r.app.thread.scheduleServiceArgs(r, slice);</span><br><span class="line"><span class="number">2348</span>        &#125; <span class="keyword">catch</span> (TransactionTooLargeException e) &#123;</span><br><span class="line"><span class="number">2349</span>            <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"Transaction too large for "</span> + args.size()</span><br><span class="line"><span class="number">2350</span>                    + <span class="string">" args, first: "</span> + args.get(<span class="number">0</span>).args);</span><br><span class="line"><span class="number">2351</span>            Slog.w(TAG, <span class="string">"Failed delivering service starts"</span>, e);</span><br><span class="line"><span class="number">2352</span>            caughtException = e;</span><br><span class="line"><span class="number">2353</span>        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line"><span class="number">2354</span>            <span class="comment">// Remote process gone...  we'll let the normal cleanup take care of this.</span></span><br><span class="line"><span class="number">2355</span>            <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"Crashed while sending args: "</span> + r);</span><br><span class="line"><span class="number">2356</span>            Slog.w(TAG, <span class="string">"Failed delivering service starts"</span>, e);</span><br><span class="line"><span class="number">2357</span>            caughtException = e;</span><br><span class="line"><span class="number">2358</span>        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"><span class="number">2359</span>            Slog.w(TAG, <span class="string">"Unexpected exception"</span>, e);</span><br><span class="line"><span class="number">2360</span>            caughtException = e;</span><br><span class="line"><span class="number">2361</span>        &#125;</span><br><span class="line"><span class="number">2362</span></span><br><span class="line"><span class="number">2363</span>        <span class="keyword">if</span> (caughtException != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">2364</span>            <span class="comment">// Keep nesting count correct</span></span><br><span class="line"><span class="number">2365</span>            <span class="keyword">final</span> <span class="keyword">boolean</span> inDestroying = mDestroyingServices.contains(r);</span><br><span class="line"><span class="number">2366</span>            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; args.size(); i++) &#123;</span><br><span class="line"><span class="number">2367</span>                serviceDoneExecutingLocked(r, inDestroying, inDestroying);</span><br><span class="line"><span class="number">2368</span>            &#125;</span><br><span class="line"><span class="number">2369</span>            <span class="keyword">if</span> (caughtException <span class="keyword">instanceof</span> TransactionTooLargeException) &#123;</span><br><span class="line"><span class="number">2370</span>                <span class="keyword">throw</span> (TransactionTooLargeException)caughtException;</span><br><span class="line"><span class="number">2371</span>            &#125;</span><br><span class="line"><span class="number">2372</span>        &#125;</span><br><span class="line"><span class="number">2373</span>    &#125;</span><br></pre></td></tr></table></figure></p>
<p>看到有这么一句r.app.thread.scheduleServiceArgs(r, slice);<br>于是回到ActivityThread中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">scheduleServiceArgs</span><span class="params">(IBinder token, <span class="keyword">boolean</span> taskRemoved, <span class="keyword">int</span> startId,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="keyword">int</span> flags ,Intent args)</span> </span>&#123;</span><br><span class="line">ServiceArgsData s = <span class="keyword">new</span> ServiceArgsData();</span><br><span class="line">s.token = token;</span><br><span class="line">s.taskRemoved = taskRemoved;</span><br><span class="line">s.startId = startId;</span><br><span class="line">s.flags = flags;</span><br><span class="line">s.args = args;</span><br><span class="line"></span><br><span class="line">sendMessage(H.SERVICE_ARGS, s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>还是去H中找对应的处理case：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> SERVICE_ARGS:</span><br><span class="line">Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, (<span class="string">"serviceStart: "</span> + String.valueOf(msg.obj)));</span><br><span class="line">handleServiceArgs((ServiceArgsData)msg.obj);</span><br><span class="line">Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line"><span class="keyword">break</span>;</span><br></pre></td></tr></table></figure></p>
<p>接着去看handleServiceArgs：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleServiceArgs</span><span class="params">(ServiceArgsData data)</span> </span>&#123;</span><br><span class="line">Service s = mServices.get(data.token);</span><br><span class="line"><span class="keyword">if</span> (s != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (data.args != <span class="keyword">null</span>) &#123;</span><br><span class="line">data.args.setExtrasClassLoader(s.getClassLoader());</span><br><span class="line">data.args.prepareToEnterProcess();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">int</span> res;</span><br><span class="line"><span class="keyword">if</span> (!data.taskRemoved) &#123;</span><br><span class="line">res = s.onStartCommand(data.args, data.flags, data.startId);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">s.onTaskRemoved(data.args);</span><br><span class="line">res = Service.START_TASK_REMOVED_COMPLETE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">QueuedWork.waitToFinish();</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">ActivityManagerNative.getDefault().serviceDoneExecuting(</span><br><span class="line">data.token, SERVICE_DONE_EXECUTING_START, data.startId, res);</span><br><span class="line">&#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line"><span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">&#125;</span><br><span class="line">ensureJitEnabled();</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"><span class="keyword">if</span> (!mInstrumentation.onException(s, e)) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line"><span class="string">"Unable to start service "</span> + s</span><br><span class="line">+ <span class="string">" with "</span> + data.args + <span class="string">": "</span> + e.toString(), e);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>s.onStartCommand中s就是上面创建的service对象。那么onStartCommand方法就是在这里调用的。至此service启动过程完毕。下面画图看下这个流程：<br><img src="http://opq81riyh.bkt.clouddn.com/startservice.png" alt=""></p>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/19/RemoteViews一-仿qq音乐自定义通知栏实现快捷切换歌曲/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="吴晓龙">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://opq81riyh.bkt.clouddn.com/666.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="吴晓龙">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/19/RemoteViews一-仿qq音乐自定义通知栏实现快捷切换歌曲/" itemprop="url">RemoteViews一 仿qq音乐自定义通知栏实现快捷切换歌曲</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-19T17:24:05+08:00">
                2018-01-19
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/源码解析/" itemprop="url" rel="index">
                    <span itemprop="name">源码解析</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h5 id="RemoteViews一-仿qq音乐自定义通知栏实现快捷切换歌曲"><a href="#RemoteViews一-仿qq音乐自定义通知栏实现快捷切换歌曲" class="headerlink" title="RemoteViews一 仿qq音乐自定义通知栏实现快捷切换歌曲"></a>RemoteViews一 仿qq音乐自定义通知栏实现快捷切换歌曲</h5><h3 id="定义：RemoteViews表示一种view结构，它可以在其他进程中显示，由于它在其它进程中，为了能够更新它的界面，RemoteViews提供了一组基础的操作用于更新它的界面。"><a href="#定义：RemoteViews表示一种view结构，它可以在其他进程中显示，由于它在其它进程中，为了能够更新它的界面，RemoteViews提供了一组基础的操作用于更新它的界面。" class="headerlink" title="定义：RemoteViews表示一种view结构，它可以在其他进程中显示，由于它在其它进程中，为了能够更新它的界面，RemoteViews提供了一组基础的操作用于更新它的界面。"></a>定义：RemoteViews表示一种view结构，它可以在其他进程中显示，由于它在其它进程中，为了能够更新它的界面，RemoteViews提供了一组基础的操作用于更新它的界面。</h3><h2 id="本文大概需要5分钟，从以下三方面讲解。文章底部有总结，急性子可以直接看总结，快速掌握知识点。"><a href="#本文大概需要5分钟，从以下三方面讲解。文章底部有总结，急性子可以直接看总结，快速掌握知识点。" class="headerlink" title="本文大概需要5分钟，从以下三方面讲解。文章底部有总结，急性子可以直接看总结，快速掌握知识点。"></a>本文大概需要5分钟，从以下三方面讲解。文章底部有总结，急性子可以直接看总结，快速掌握知识点。</h2><ol>
<li>一、成果展示</li>
<li>二、代码讲解</li>
<li>三、总结</li>
</ol>
<h6 id="一、成果展示"><a href="#一、成果展示" class="headerlink" title="一、成果展示"></a>一、成果展示</h6><h4 id="仿照qq音乐通知栏切换歌曲（缺图，只能以文字代替）"><a href="#仿照qq音乐通知栏切换歌曲（缺图，只能以文字代替）" class="headerlink" title="仿照qq音乐通知栏切换歌曲（缺图，只能以文字代替）"></a>仿照qq音乐通知栏切换歌曲（缺图，只能以文字代替）</h4><p><img src="http://opq81riyh.bkt.clouddn.com/remoteviews.png" alt="remoteviews"></p>
<h4 id="点击下一曲后，执行相应的代码（以相应Toast代替）"><a href="#点击下一曲后，执行相应的代码（以相应Toast代替）" class="headerlink" title="点击下一曲后，执行相应的代码（以相应Toast代替）"></a>点击下一曲后，执行相应的代码（以相应Toast代替）</h4><p><img src="http://opq81riyh.bkt.clouddn.com/pause.png" alt="pause"></p>
<h4 id="后台启动相应的service执行切换歌曲和暂停等逻辑"><a href="#后台启动相应的service执行切换歌曲和暂停等逻辑" class="headerlink" title="后台启动相应的service执行切换歌曲和暂停等逻辑"></a>后台启动相应的service执行切换歌曲和暂停等逻辑</h4><p><img src="http://opq81riyh.bkt.clouddn.com/log.png" alt="log"></p>
<h4 id="二、代码讲解"><a href="#二、代码讲解" class="headerlink" title="二、代码讲解"></a>二、代码讲解</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> android.com.remoteviews;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.app.Notification;</span><br><span class="line"><span class="keyword">import</span> android.app.NotificationManager;</span><br><span class="line"><span class="keyword">import</span> android.app.PendingIntent;</span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.support.v7.app.AppCompatActivity;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.widget.RemoteViews;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> android.R.string.no;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line"><span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">setContentView(R.layout.activity_main);</span><br><span class="line">initRemoteViews();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initRemoteViews</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">Notification notification = <span class="keyword">new</span> Notification();</span><br><span class="line">notification.icon = R.mipmap.ic_launcher;</span><br><span class="line">notification.tickerText = <span class="string">"remoteviewTest"</span>;</span><br><span class="line">notification.when = System.currentTimeMillis();</span><br><span class="line">notification.flags = Notification.FLAG_AUTO_CANCEL;</span><br><span class="line">Intent intent = <span class="keyword">new</span> Intent(<span class="keyword">this</span>, SecondActivity.class);</span><br><span class="line">PendingIntent pendingIntent = PendingIntent.getActivity(<span class="keyword">this</span>, <span class="number">0</span>, intent, PendingIntent.FLAG_UPDATE_CURRENT);</span><br><span class="line">RemoteViews remoteViews = <span class="keyword">new</span> RemoteViews(getPackageName(), R.layout.layout_remoteviews);</span><br><span class="line">remoteViews.setTextViewText(R.id.tv_remote, <span class="string">"暧昧"</span>);</span><br><span class="line">remoteViews.setImageViewResource(R.id.iv_remote,R.mipmap.ic_launcher);</span><br><span class="line">Intent changeService = <span class="keyword">new</span> Intent(<span class="keyword">this</span>, ChangeService.class);</span><br><span class="line">changeService.putExtra(<span class="string">"data"</span>,<span class="string">"下一曲"</span>);</span><br><span class="line">PendingIntent changeIntent = PendingIntent.getService(<span class="keyword">this</span>, <span class="number">1</span>, changeService, PendingIntent.FLAG_UPDATE_CURRENT);</span><br><span class="line">changeService.putExtra(<span class="string">"data"</span>,<span class="string">"暂停"</span>);</span><br><span class="line">PendingIntent pauseIntent = PendingIntent.getService(<span class="keyword">this</span>, <span class="number">2</span>, changeService, PendingIntent.FLAG_UPDATE_CURRENT);</span><br><span class="line"></span><br><span class="line">remoteViews.setOnClickPendingIntent(R.id.tv_pause,pauseIntent);</span><br><span class="line">remoteViews.setOnClickPendingIntent(R.id.tv_next,changeIntent);</span><br><span class="line">PendingIntent clickIntent = PendingIntent.getActivity(<span class="keyword">this</span>, <span class="number">1</span>, <span class="keyword">new</span> Intent(<span class="keyword">this</span>, ThirdActivity.class), PendingIntent.FLAG_UPDATE_CURRENT);</span><br><span class="line">remoteViews.setOnClickPendingIntent(R.id.iv_remote,clickIntent);</span><br><span class="line">notification.contentView = remoteViews;</span><br><span class="line">notification.contentIntent = pendingIntent;</span><br><span class="line">NotificationManager notifacationManager = (NotificationManager) getSystemService(Context.NOTIFICATION_SERVICE);</span><br><span class="line">notifacationManager.notify(<span class="number">2</span>,notification);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面是核心代码，以下会分块讲解：<br>首先需要notification，设置参数，icon应该是每一首歌曲对应的图片<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Notification notification = <span class="keyword">new</span> Notification();</span><br><span class="line">notification.icon = R.mipmap.ic_launcher;</span><br><span class="line">notification.tickerText = <span class="string">"remoteviewTest"</span>;</span><br><span class="line">notification.when = System.currentTimeMillis();</span><br><span class="line">notification.flags = Notification.FLAG_AUTO_CANCEL;</span><br></pre></td></tr></table></figure></p>
<p>然后构造出PendingIntent<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Intent intent = <span class="keyword">new</span> Intent(<span class="keyword">this</span>, SecondActivity.class);</span><br><span class="line">PendingIntent pendingIntent = PendingIntent.getActivity(<span class="keyword">this</span>, <span class="number">0</span>, intent, PendingIntent.FLAG_UPDATE_CURRENT);</span><br></pre></td></tr></table></figure></p>
<p>再然后，构造出remoteviews，它有两个参数，一个是包名，另一个是布局的id，这里我写了一个简单的展示在通知栏的布局。<br>注意了，remoteview设置文字和图片资源都没有findViewById，只能通过这种set方法，将对应的id和资源传进去。（这里先说用法，remoteview机制的原理在后面讲解）<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">RemoteViews remoteViews = <span class="keyword">new</span> RemoteViews(getPackageName(), R.layout.layout_remoteviews);</span><br><span class="line">remoteViews.setTextViewText(R.id.tv_remote, <span class="string">"暧昧"</span>);</span><br><span class="line">remoteViews.setImageViewResource(R.id.iv_remote,R.mipmap.ic_launcher);</span><br></pre></td></tr></table></figure></p>
<p>布局的代码如下：<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"utf-8"</span>?&gt;</span><br><span class="line">&lt;LinearLayout xmlns:android=<span class="string">"http://schemas.android.com/apk/res/android"</span></span><br><span class="line">android:orientation=<span class="string">"horizontal"</span></span><br><span class="line">android:gravity=<span class="string">"center_vertical"</span></span><br><span class="line">android:layout_width=<span class="string">"match_parent"</span></span><br><span class="line">android:layout_height=<span class="string">"wrap_content"</span>&gt;</span><br><span class="line"></span><br><span class="line">&lt;ImageView</span><br><span class="line">android:id=<span class="string">"@+id/iv_remote"</span></span><br><span class="line">android:layout_width=<span class="string">"wrap_content"</span></span><br><span class="line">android:layout_height=<span class="string">"wrap_content"</span></span><br><span class="line">android:src=<span class="string">"@mipmap/ic_launcher_round"</span>/&gt;</span><br><span class="line">&lt;TextView</span><br><span class="line">android:id=<span class="string">"@+id/tv_remote"</span></span><br><span class="line">android:layout_width=<span class="string">"wrap_content"</span></span><br><span class="line">android:layout_height=<span class="string">"wrap_content"</span></span><br><span class="line">android:layout_marginLeft=<span class="string">"10dp"</span></span><br><span class="line">android:text=<span class="string">"i am a apple"</span>/&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;TextView</span><br><span class="line">android:id=<span class="string">"@+id/tv_pause"</span></span><br><span class="line">android:layout_width=<span class="string">"wrap_content"</span></span><br><span class="line">android:layout_height=<span class="string">"wrap_content"</span></span><br><span class="line">android:layout_marginLeft=<span class="string">"10dp"</span></span><br><span class="line">android:text=<span class="string">"暂停"</span>/&gt;</span><br><span class="line">&lt;TextView</span><br><span class="line">android:id=<span class="string">"@+id/tv_next"</span></span><br><span class="line">android:layout_width=<span class="string">"wrap_content"</span></span><br><span class="line">android:layout_height=<span class="string">"wrap_content"</span></span><br><span class="line">android:layout_marginLeft=<span class="string">"10dp"</span></span><br><span class="line">android:text=<span class="string">"下一曲"</span>/&gt;</span><br><span class="line"></span><br><span class="line">&lt;TextView</span><br><span class="line">android:id=<span class="string">"@+id/tv_close"</span></span><br><span class="line">android:layout_width=<span class="string">"wrap_content"</span></span><br><span class="line">android:layout_height=<span class="string">"wrap_content"</span></span><br><span class="line">android:layout_marginLeft=<span class="string">"10dp"</span></span><br><span class="line">android:text=<span class="string">"关闭"</span>/&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;/LinearLayout&gt;</span><br></pre></td></tr></table></figure></p>
<p>这里要澄清以下，不是非要用textview，而是我没有图，只能用文字代替，等以后又图了做个好看的哈哈。</p>
<p>下面说下remoteview上面点击事件，同理没有直接设置点击事件的方法（进它的源码瞅一眼就知道为啥了）,还是只能传进去penddingIntent，由于qq音乐点击通知栏按钮直接切换歌曲，界面不发生变化所以，这块的penddingIntent用的PendingIntent.getService。当然，点击整个通知栏要跳到qq音乐主界面的话，就是底下PendingIntent.getActivity了。<br>有一点，PendingIntent两个如果requescode一样，只是extras不一样会被认为是同一个peddingInetent。原因是，区分PenddingIntent是由内部intent和requescode，而内部intent区分是由componentName和intent-filter，ectras不参与Intent的匹配过程。<br>如果notify方法的id是常量，那么不管PenddingIntent是否匹配，后面的通知会直接替换前面的通知。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Intent changeService = <span class="keyword">new</span> Intent(<span class="keyword">this</span>, ChangeService.class);</span><br><span class="line">changeService.putExtra(<span class="string">"data"</span>,<span class="string">"下一曲"</span>);</span><br><span class="line">PendingIntent changeIntent = PendingIntent.getService(<span class="keyword">this</span>, <span class="number">1</span>, changeService, PendingIntent.FLAG_UPDATE_CURRENT);</span><br><span class="line">changeService.putExtra(<span class="string">"data"</span>,<span class="string">"暂停"</span>);</span><br><span class="line">PendingIntent pauseIntent = PendingIntent.getService(<span class="keyword">this</span>, <span class="number">2</span>, changeService, PendingIntent.FLAG_UPDATE_CURRENT);</span><br><span class="line"></span><br><span class="line">remoteViews.setOnClickPendingIntent(R.id.tv_pause,pauseIntent);</span><br><span class="line">remoteViews.setOnClickPendingIntent(R.id.tv_next,changeIntent);</span><br><span class="line">PendingIntent clickIntent = PendingIntent.getActivity(<span class="keyword">this</span>, <span class="number">1</span>, <span class="keyword">new</span> Intent(<span class="keyword">this</span>, ThirdActivity.class), PendingIntent.FLAG_UPDATE_CURRENT);</span><br><span class="line">remoteViews.setOnClickPendingIntent(R.id.iv_remote,clickIntent);</span><br></pre></td></tr></table></figure></p>
<p>最后将自定义的remoteviews设置给notification的contentview<br>并且获取系统NotificationManager，通过notifacationManager.notify方法<br>将自定义的通知工具栏发出，展示在通知栏中国呢。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">notification.contentView = remoteViews;</span><br><span class="line">notification.contentIntent = pendingIntent;</span><br><span class="line">NotificationManager notifacationManager = (NotificationManager) getSystemService(Context.NOTIFICATION_SERVICE);</span><br><span class="line">notifacationManager.notify(<span class="number">2</span>,notification);</span><br></pre></td></tr></table></figure></p>
<p>最后，本文只是仿照qq通知栏操作界面将remoteview的使用讲解一下，并不是一个播放器，再次强调，不是在做播放器。<br>我这么想的，如果要做qq音乐的播放器通知更新，应该service里面去更新notinication的界面，比如，收到点击下一曲的penddingIntent，service去播放下一首歌曲，同时更新remoteview的界面（歌曲名字和歌曲对应的图片）<br>对于qq音乐的其他操作，比如点击通知栏进入qq音乐主界面，就是notification的pendingIntent，它是由PenddingIntent.getActivity获取的。其他与qq音乐相关的先不管了，本文只提与remoteview有关的东西。</p>
<h4 id="三、总结"><a href="#三、总结" class="headerlink" title="三、总结"></a>三、总结</h4><ol>
<li>RemoteViews构造方法接受一个包名，一个layout的id；</li>
<li>RemoteViews设置图片资源和文字资源接受id和资源；</li>
<li>没有直接方法设置点击事件，只能通过PenddingIntent相关方法实现；</li>
<li>将RemoteViews设置在notification中，通过NotificationManager的notify方法实现。</li>
<li>注意点：notify方法的id，penddingIntent的requestCode能用来区分PenddingIntent是不是同一个。</li>
</ol>
<h4 id="后记，RemoteViews还有一个最重要的使用就是桌面小部件（AppWidgetProvider），下一篇会写一个类似天气的桌面部件，并完成RemoteViews的原理讲解。"><a href="#后记，RemoteViews还有一个最重要的使用就是桌面小部件（AppWidgetProvider），下一篇会写一个类似天气的桌面部件，并完成RemoteViews的原理讲解。" class="headerlink" title="后记，RemoteViews还有一个最重要的使用就是桌面小部件（AppWidgetProvider），下一篇会写一个类似天气的桌面部件，并完成RemoteViews的原理讲解。"></a>后记，RemoteViews还有一个最重要的使用就是桌面小部件（AppWidgetProvider），下一篇会写一个类似天气的桌面部件，并完成RemoteViews的原理讲解。</h4><p><a href="http://blog.csdn.net/lantier743865" target="_blank" rel="noopener">我的csdn博客</a><br>欢迎关注我的微信公众号：<br><img src="http://opq81riyh.bkt.clouddn.com/qrcode_for_gh_1d2b09f3edbf_258%20%282%29.jpg" alt="微信公众号"></p>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="http://opq81riyh.bkt.clouddn.com/666.jpg" alt="吴晓龙">
            
              <p class="site-author-name" itemprop="name">吴晓龙</p>
              <p class="site-description motion-element" itemprop="description">耐得住寂寞 守得住繁华</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">17</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">10</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">12</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/lantier743865" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-globe"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://weibo.com/3166661920/profile?topnav=1&wvr=6" target="_blank" title="微博">
                      
                        <i class="fa fa-fw fa-globe"></i>微博</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://juejin.im/user/58c9e40b61ff4b006c808011" target="_blank" title="掘金">
                      
                        <i class="fa fa-fw fa-globe"></i>掘金</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.jianshu.com/u/218df555dee7" target="_blank" title="简书">
                      
                        <i class="fa fa-fw fa-globe"></i>简书</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">吴晓龙</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
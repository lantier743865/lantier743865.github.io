<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="源码解析,">





  <link rel="alternate" href="/atom.xml" title="吴晓龙" type="application/atom+xml">






<meta name="description" content="基于8.0源码解析：startService 启动过程欢迎关注我的公众号：  调用startService 后会到ContextWrapper中：1234@Overridepublic ComponentName startService(Intent service) &amp;#123;return mBase.startService(service);&amp;#125; 这个mBase就是Context">
<meta name="keywords" content="源码解析">
<meta property="og:type" content="article">
<meta property="og:title" content="基于8.0源码解析：startService 启动过程">
<meta property="og:url" content="http://yoursite.com/2018/01/24/基于8-0源码解析：startService-启动过程/index.html">
<meta property="og:site_name" content="吴晓龙">
<meta property="og:description" content="基于8.0源码解析：startService 启动过程欢迎关注我的公众号：  调用startService 后会到ContextWrapper中：1234@Overridepublic ComponentName startService(Intent service) &amp;#123;return mBase.startService(service);&amp;#125; 这个mBase就是Context">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://opq81riyh.bkt.clouddn.com/qrcode_for_gh_1d2b09f3edbf_258%20%282%29.jpg">
<meta property="og:image" content="http://opq81riyh.bkt.clouddn.com/startservice.png">
<meta property="og:image" content="http://opq81riyh.bkt.clouddn.com/startservice.png">
<meta property="og:updated_time" content="2018-01-24T08:21:11.483Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="基于8.0源码解析：startService 启动过程">
<meta name="twitter:description" content="基于8.0源码解析：startService 启动过程欢迎关注我的公众号：  调用startService 后会到ContextWrapper中：1234@Overridepublic ComponentName startService(Intent service) &amp;#123;return mBase.startService(service);&amp;#125; 这个mBase就是Context">
<meta name="twitter:image" content="http://opq81riyh.bkt.clouddn.com/qrcode_for_gh_1d2b09f3edbf_258%20%282%29.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/01/24/基于8-0源码解析：startService-启动过程/">





  <title>基于8.0源码解析：startService 启动过程 | 吴晓龙</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">吴晓龙</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">爱吃哈密瓜的程序员</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-search">
          <a href="/search" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            搜索
          </a>
        </li>
      
        
        <li class="menu-item menu-item-schedule">
          <a href="/schedule" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            日程表
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            站点地图
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/commonweal" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            公益404
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/24/基于8-0源码解析：startService-启动过程/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="吴晓龙">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://opq81riyh.bkt.clouddn.com/666.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="吴晓龙">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">基于8.0源码解析：startService 启动过程</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-24T16:18:22+08:00">
                2018-01-24
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/源码解析/" itemprop="url" rel="index">
                    <span itemprop="name">源码解析</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="基于8-0源码解析：startService-启动过程"><a href="#基于8-0源码解析：startService-启动过程" class="headerlink" title="基于8.0源码解析：startService 启动过程"></a>基于8.0源码解析：startService 启动过程</h1><p>欢迎关注我的公众号：<br><img src="http://opq81riyh.bkt.clouddn.com/qrcode_for_gh_1d2b09f3edbf_258%20%282%29.jpg" alt=""></p>
<hr>
<p><img src="http://opq81riyh.bkt.clouddn.com/startservice.png" alt=""><br>调用startService 后会到ContextWrapper中：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ComponentName <span class="title">startService</span><span class="params">(Intent service)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> mBase.startService(service);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个mBase就是Context,然后到ContextImpl中看一眼：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="number">1459</span>    <span class="function"><span class="keyword">public</span> ComponentName <span class="title">startService</span><span class="params">(Intent service)</span> </span>&#123;</span><br><span class="line"><span class="number">1460</span>        warnIfCallingFromSystemProcess();</span><br><span class="line"><span class="number">1461</span>        <span class="keyword">return</span> startServiceCommon(service, <span class="keyword">false</span>, mUser);</span><br><span class="line"><span class="number">1462</span>    &#125;</span><br><span class="line"><span class="number">1463</span></span><br></pre></td></tr></table></figure></p>
<p>又调用了startServiceCommon<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> ComponentName <span class="title">startServiceCommon</span><span class="params">(Intent service, <span class="keyword">boolean</span> requireForeground,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">1487</span>            UserHandle user)</span> </span>&#123;</span><br><span class="line"><span class="number">1488</span>        <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="number">1489</span>            validateServiceIntent(service);</span><br><span class="line"><span class="number">1490</span>            service.prepareToLeaveProcess(<span class="keyword">this</span>);</span><br><span class="line"><span class="number">1491</span>            ComponentName cn = ActivityManager.getService().startService(</span><br><span class="line"><span class="number">1492</span>                mMainThread.getApplicationThread(), service, service.resolveTypeIfNeeded(</span><br><span class="line"><span class="number">1493</span>                            getContentResolver()), requireForeground,</span><br><span class="line"><span class="number">1494</span>                            getOpPackageName(), user.getIdentifier());</span><br><span class="line"><span class="number">1495</span>            <span class="keyword">if</span> (cn != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">1496</span>                <span class="keyword">if</span> (cn.getPackageName().equals(<span class="string">"!"</span>)) &#123;</span><br><span class="line"><span class="number">1497</span>                    <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(</span><br><span class="line"><span class="number">1498</span>                            <span class="string">"Not allowed to start service "</span> + service</span><br><span class="line"><span class="number">1499</span>                            + <span class="string">" without permission "</span> + cn.getClassName());</span><br><span class="line"><span class="number">1500</span>                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cn.getPackageName().equals(<span class="string">"!!"</span>)) &#123;</span><br><span class="line"><span class="number">1501</span>                    <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(</span><br><span class="line"><span class="number">1502</span>                            <span class="string">"Unable to start service "</span> + service</span><br><span class="line"><span class="number">1503</span>                            + <span class="string">": "</span> + cn.getClassName());</span><br><span class="line"><span class="number">1504</span>                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cn.getPackageName().equals(<span class="string">"?"</span>)) &#123;</span><br><span class="line"><span class="number">1505</span>                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line"><span class="number">1506</span>                            <span class="string">"Not allowed to start service "</span> + service + <span class="string">": "</span> + cn.getClassName());</span><br><span class="line"><span class="number">1507</span>                &#125;</span><br><span class="line"><span class="number">1508</span>            &#125;</span><br><span class="line"><span class="number">1509</span>            <span class="keyword">return</span> cn;</span><br><span class="line"><span class="number">1510</span>        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line"><span class="number">1511</span>            <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line"><span class="number">1512</span>        &#125;</span><br><span class="line"><span class="number">1513</span>    &#125;</span><br><span class="line"><span class="number">1514</span></span><br></pre></td></tr></table></figure></p>
<p>看到其中有这么一句：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ComponentName cn = ActivityManager.getService().startService(</span><br><span class="line"><span class="number">1492</span>                mMainThread.getApplicationThread(), service, service.resolveTypeIfNeeded(</span><br><span class="line"><span class="number">1493</span>                            getContentResolver()), requireForeground,</span><br><span class="line"><span class="number">1494</span>                            getOpPackageName(), user.getIdentifier());</span><br></pre></td></tr></table></figure></p>
<p>了解Binder机制的就会知道这会调用到ActivityManagerService中，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="number">18125</span>    <span class="function"><span class="keyword">public</span> ComponentName <span class="title">startService</span><span class="params">(IApplicationThread caller, Intent service,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">18126</span>            String resolvedType, <span class="keyword">boolean</span> requireForeground, String callingPackage, <span class="keyword">int</span> userId)</span></span></span><br><span class="line"><span class="function">18127            <span class="keyword">throws</span> TransactionTooLargeException </span>&#123;</span><br><span class="line"><span class="number">18128</span>        enforceNotIsolatedCaller(<span class="string">"startService"</span>);</span><br><span class="line"><span class="number">18129</span>        <span class="comment">// Refuse possible leaked file descriptors</span></span><br><span class="line"><span class="number">18130</span>        <span class="keyword">if</span> (service != <span class="keyword">null</span> &amp;&amp; service.hasFileDescriptors() == <span class="keyword">true</span>) &#123;</span><br><span class="line"><span class="number">18131</span>            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"File descriptors passed in Intent"</span>);</span><br><span class="line"><span class="number">18132</span>        &#125;</span><br><span class="line"><span class="number">18133</span></span><br><span class="line"><span class="number">18134</span>        <span class="keyword">if</span> (callingPackage == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">18135</span>            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"callingPackage cannot be null"</span>);</span><br><span class="line"><span class="number">18136</span>        &#125;</span><br><span class="line"><span class="number">18137</span></span><br><span class="line"><span class="number">18138</span>        <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE,</span><br><span class="line"><span class="number">18139</span>                <span class="string">"*** startService: "</span> + service + <span class="string">" type="</span> + resolvedType + <span class="string">" fg="</span> + requireForeground);</span><br><span class="line"><span class="number">18140</span>        <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line"><span class="number">18141</span>            <span class="keyword">final</span> <span class="keyword">int</span> callingPid = Binder.getCallingPid();</span><br><span class="line"><span class="number">18142</span>            <span class="keyword">final</span> <span class="keyword">int</span> callingUid = Binder.getCallingUid();</span><br><span class="line"><span class="number">18143</span>            <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</span><br><span class="line"><span class="number">18144</span>            ComponentName res;</span><br><span class="line"><span class="number">18145</span>            <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="number">18146</span>                res = mServices.startServiceLocked(caller, service,</span><br><span class="line"><span class="number">18147</span>                        resolvedType, callingPid, callingUid,</span><br><span class="line"><span class="number">18148</span>                        requireForeground, callingPackage, userId);</span><br><span class="line"><span class="number">18149</span>            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line"><span class="number">18150</span>                Binder.restoreCallingIdentity(origId);</span><br><span class="line"><span class="number">18151</span>            &#125;</span><br><span class="line"><span class="number">18152</span>            <span class="keyword">return</span> res;</span><br><span class="line"><span class="number">18153</span>        &#125;</span><br><span class="line"><span class="number">18154</span>    &#125;</span><br></pre></td></tr></table></figure>
<p>mServices.startServiceLocked<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ComponentName <span class="title">startServiceLocked</span><span class="params">(IApplicationThread caller, Intent service, String resolvedType,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">328</span>            <span class="keyword">int</span> callingPid, <span class="keyword">int</span> callingUid, <span class="keyword">boolean</span> fgRequired, String callingPackage, <span class="keyword">final</span> <span class="keyword">int</span> userId)</span></span></span><br><span class="line"><span class="function">329            <span class="keyword">throws</span> TransactionTooLargeException </span>&#123;</span><br><span class="line"><span class="number">330</span>        <span class="keyword">if</span> (DEBUG_DELAYED_STARTS) Slog.v(TAG_SERVICE, <span class="string">"startService: "</span> + service</span><br><span class="line"><span class="number">331</span>                + <span class="string">" type="</span> + resolvedType + <span class="string">" args="</span> + service.getExtras());</span><br><span class="line"><span class="number">332</span></span><br><span class="line"><span class="number">333</span>        <span class="keyword">final</span> <span class="keyword">boolean</span> callerFg;</span><br><span class="line"><span class="number">334</span>        <span class="keyword">if</span> (caller != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">335</span>            <span class="keyword">final</span> ProcessRecord callerApp = mAm.getRecordForAppLocked(caller);</span><br><span class="line"><span class="number">336</span>            <span class="keyword">if</span> (callerApp == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">337</span>                <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(</span><br><span class="line"><span class="number">338</span>                        <span class="string">"Unable to find app for caller "</span> + caller</span><br><span class="line"><span class="number">339</span>                        + <span class="string">" (pid="</span> + callingPid</span><br><span class="line"><span class="number">340</span>                        + <span class="string">") when starting service "</span> + service);</span><br><span class="line"><span class="number">341</span>            &#125;</span><br><span class="line"><span class="number">342</span>            callerFg = callerApp.setSchedGroup != ProcessList.SCHED_GROUP_BACKGROUND;</span><br><span class="line"><span class="number">343</span>        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="number">344</span>            callerFg = <span class="keyword">true</span>;</span><br><span class="line"><span class="number">345</span>        &#125;</span><br><span class="line"><span class="number">346</span></span><br><span class="line"><span class="number">347</span>        ServiceLookupResult res =</span><br><span class="line"><span class="number">348</span>            retrieveServiceLocked(service, resolvedType, callingPackage,</span><br><span class="line"><span class="number">349</span>                    callingPid, callingUid, userId, <span class="keyword">true</span>, callerFg, <span class="keyword">false</span>);</span><br><span class="line"><span class="number">350</span>        <span class="keyword">if</span> (res == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">351</span>            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"><span class="number">352</span>        &#125;</span><br><span class="line"><span class="number">353</span>        <span class="keyword">if</span> (res.record == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">354</span>            <span class="keyword">return</span> <span class="keyword">new</span> ComponentName(<span class="string">"!"</span>, res.permission != <span class="keyword">null</span></span><br><span class="line"><span class="number">355</span>                    ? res.permission : <span class="string">"private to package"</span>);</span><br><span class="line"><span class="number">356</span>        &#125;</span><br><span class="line"><span class="number">357</span></span><br><span class="line"><span class="number">358</span>        ServiceRecord r = res.record;</span><br><span class="line"><span class="number">359</span></span><br><span class="line"><span class="number">360</span>        <span class="keyword">if</span> (!mAm.mUserController.exists(r.userId)) &#123;</span><br><span class="line"><span class="number">361</span>            Slog.w(TAG, <span class="string">"Trying to start service with non-existent user! "</span> + r.userId);</span><br><span class="line"><span class="number">362</span>            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"><span class="number">363</span>        &#125;</span><br><span class="line"><span class="number">364</span></span><br><span class="line"><span class="number">365</span>        <span class="comment">// If this isn't a direct-to-foreground start, check our ability to kick off an</span></span><br><span class="line"><span class="number">366</span>        <span class="comment">// arbitrary service</span></span><br><span class="line"><span class="number">367</span>        <span class="keyword">if</span> (!r.startRequested &amp;&amp; !fgRequired) &#123;</span><br><span class="line"><span class="number">368</span>            <span class="comment">// Before going further -- if this app is not allowed to start services in the</span></span><br><span class="line"><span class="number">369</span>            <span class="comment">// background, then at this point we aren't going to let it period.</span></span><br><span class="line"><span class="number">370</span>            <span class="keyword">final</span> <span class="keyword">int</span> allowed = mAm.getAppStartModeLocked(r.appInfo.uid, r.packageName,</span><br><span class="line"><span class="number">371</span>                    r.appInfo.targetSdkVersion, callingPid, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line"><span class="number">372</span>            <span class="keyword">if</span> (allowed != ActivityManager.APP_START_MODE_NORMAL) &#123;</span><br><span class="line"><span class="number">373</span>                Slog.w(TAG, <span class="string">"Background start not allowed: service "</span></span><br><span class="line"><span class="number">374</span>                        + service + <span class="string">" to "</span> + r.name.flattenToShortString()</span><br><span class="line"><span class="number">375</span>                        + <span class="string">" from pid="</span> + callingPid + <span class="string">" uid="</span> + callingUid</span><br><span class="line"><span class="number">376</span>                        + <span class="string">" pkg="</span> + callingPackage);</span><br><span class="line"><span class="number">377</span>                <span class="keyword">if</span> (allowed == ActivityManager.APP_START_MODE_DELAYED) &#123;</span><br><span class="line"><span class="number">378</span>                    <span class="comment">// In this case we are silently disabling the app, to disrupt as</span></span><br><span class="line"><span class="number">379</span>                    <span class="comment">// little as possible existing apps.</span></span><br><span class="line"><span class="number">380</span>                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"><span class="number">381</span>                &#125;</span><br><span class="line"><span class="number">382</span>                <span class="comment">// This app knows it is in the new model where this operation is not</span></span><br><span class="line"><span class="number">383</span>                <span class="comment">// allowed, so tell it what has happened.</span></span><br><span class="line"><span class="number">384</span>                UidRecord uidRec = mAm.mActiveUids.get(r.appInfo.uid);</span><br><span class="line"><span class="number">385</span>                <span class="keyword">return</span> <span class="keyword">new</span> ComponentName(<span class="string">"?"</span>, <span class="string">"app is in background uid "</span> + uidRec);</span><br><span class="line"><span class="number">386</span>            &#125;</span><br><span class="line"><span class="number">387</span>        &#125;</span><br><span class="line"><span class="number">388</span></span><br><span class="line"><span class="number">389</span>        NeededUriGrants neededGrants = mAm.checkGrantUriPermissionFromIntentLocked(</span><br><span class="line"><span class="number">390</span>                callingUid, r.packageName, service, service.getFlags(), <span class="keyword">null</span>, r.userId);</span><br><span class="line"><span class="number">391</span></span><br><span class="line"><span class="number">392</span>        <span class="comment">// If permissions need a review before any of the app components can run,</span></span><br><span class="line"><span class="number">393</span>        <span class="comment">// we do not start the service and launch a review activity if the calling app</span></span><br><span class="line"><span class="number">394</span>        <span class="comment">// is in the foreground passing it a pending intent to start the service when</span></span><br><span class="line"><span class="number">395</span>        <span class="comment">// review is completed.</span></span><br><span class="line"><span class="number">396</span>        <span class="keyword">if</span> (mAm.mPermissionReviewRequired) &#123;</span><br><span class="line"><span class="number">397</span>            <span class="keyword">if</span> (!requestStartTargetPermissionsReviewIfNeededLocked(r, callingPackage,</span><br><span class="line"><span class="number">398</span>                    callingUid, service, callerFg, userId)) &#123;</span><br><span class="line"><span class="number">399</span>                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"><span class="number">400</span>            &#125;</span><br><span class="line"><span class="number">401</span>        &#125;</span><br><span class="line"><span class="number">402</span></span><br><span class="line"><span class="number">403</span>        <span class="keyword">if</span> (unscheduleServiceRestartLocked(r, callingUid, <span class="keyword">false</span>)) &#123;</span><br><span class="line"><span class="number">404</span>            <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"START SERVICE WHILE RESTART PENDING: "</span> + r);</span><br><span class="line"><span class="number">405</span>        &#125;</span><br><span class="line"><span class="number">406</span>        r.lastActivity = SystemClock.uptimeMillis();</span><br><span class="line"><span class="number">407</span>        r.startRequested = <span class="keyword">true</span>;</span><br><span class="line"><span class="number">408</span>        r.delayedStop = <span class="keyword">false</span>;</span><br><span class="line"><span class="number">409</span>        r.fgRequired = fgRequired;</span><br><span class="line"><span class="number">410</span>        r.pendingStarts.add(<span class="keyword">new</span> ServiceRecord.StartItem(r, <span class="keyword">false</span>, r.makeNextStartId(),</span><br><span class="line"><span class="number">411</span>                service, neededGrants, callingUid));</span><br><span class="line"><span class="number">412</span></span><br><span class="line"><span class="number">413</span>        <span class="keyword">final</span> ServiceMap smap = getServiceMapLocked(r.userId);</span><br><span class="line"><span class="number">414</span>        <span class="keyword">boolean</span> addToStarting = <span class="keyword">false</span>;</span><br><span class="line"><span class="number">415</span>        <span class="keyword">if</span> (!callerFg &amp;&amp; !fgRequired &amp;&amp; r.app == <span class="keyword">null</span></span><br><span class="line"><span class="number">416</span>                &amp;&amp; mAm.mUserController.hasStartedUserState(r.userId)) &#123;</span><br><span class="line"><span class="number">417</span>            ProcessRecord proc = mAm.getProcessRecordLocked(r.processName, r.appInfo.uid, <span class="keyword">false</span>);</span><br><span class="line"><span class="number">418</span>            <span class="keyword">if</span> (proc == <span class="keyword">null</span> || proc.curProcState &gt; ActivityManager.PROCESS_STATE_RECEIVER) &#123;</span><br><span class="line"><span class="number">419</span>                <span class="comment">// If this is not coming from a foreground caller, then we may want</span></span><br><span class="line"><span class="number">420</span>                <span class="comment">// to delay the start if there are already other background services</span></span><br><span class="line"><span class="number">421</span>                <span class="comment">// that are starting.  This is to avoid process start spam when lots</span></span><br><span class="line"><span class="number">422</span>                <span class="comment">// of applications are all handling things like connectivity broadcasts.</span></span><br><span class="line"><span class="number">423</span>                <span class="comment">// We only do this for cached processes, because otherwise an application</span></span><br><span class="line"><span class="number">424</span>                <span class="comment">// can have assumptions about calling startService() for a service to run</span></span><br><span class="line"><span class="number">425</span>                <span class="comment">// in its own process, and for that process to not be killed before the</span></span><br><span class="line"><span class="number">426</span>                <span class="comment">// service is started.  This is especially the case for receivers, which</span></span><br><span class="line"><span class="number">427</span>                <span class="comment">// may start a service in onReceive() to do some additional work and have</span></span><br><span class="line"><span class="number">428</span>                <span class="comment">// initialized some global state as part of that.</span></span><br><span class="line"><span class="number">429</span>                <span class="keyword">if</span> (DEBUG_DELAYED_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"Potential start delay of "</span></span><br><span class="line"><span class="number">430</span>                        + r + <span class="string">" in "</span> + proc);</span><br><span class="line"><span class="number">431</span>                <span class="keyword">if</span> (r.delayed) &#123;</span><br><span class="line"><span class="number">432</span>                    <span class="comment">// This service is already scheduled for a delayed start; just leave</span></span><br><span class="line"><span class="number">433</span>                    <span class="comment">// it still waiting.</span></span><br><span class="line"><span class="number">434</span>                    <span class="keyword">if</span> (DEBUG_DELAYED_STARTS) Slog.v(TAG_SERVICE, <span class="string">"Continuing to delay: "</span> + r);</span><br><span class="line"><span class="number">435</span>                    <span class="keyword">return</span> r.name;</span><br><span class="line"><span class="number">436</span>                &#125;</span><br><span class="line"><span class="number">437</span>                <span class="keyword">if</span> (smap.mStartingBackground.size() &gt;= mMaxStartingBackground) &#123;</span><br><span class="line"><span class="number">438</span>                    <span class="comment">// Something else is starting, delay!</span></span><br><span class="line"><span class="number">439</span>                    Slog.i(TAG_SERVICE, <span class="string">"Delaying start of: "</span> + r);</span><br><span class="line"><span class="number">440</span>                    smap.mDelayedStartList.add(r);</span><br><span class="line"><span class="number">441</span>                    r.delayed = <span class="keyword">true</span>;</span><br><span class="line"><span class="number">442</span>                    <span class="keyword">return</span> r.name;</span><br><span class="line"><span class="number">443</span>                &#125;</span><br><span class="line"><span class="number">444</span>                <span class="keyword">if</span> (DEBUG_DELAYED_STARTS) Slog.v(TAG_SERVICE, <span class="string">"Not delaying: "</span> + r);</span><br><span class="line"><span class="number">445</span>                addToStarting = <span class="keyword">true</span>;</span><br><span class="line"><span class="number">446</span>            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (proc.curProcState &gt;= ActivityManager.PROCESS_STATE_SERVICE) &#123;</span><br><span class="line"><span class="number">447</span>                <span class="comment">// We slightly loosen when we will enqueue this new service as a background</span></span><br><span class="line"><span class="number">448</span>                <span class="comment">// starting service we are waiting for, to also include processes that are</span></span><br><span class="line"><span class="number">449</span>                <span class="comment">// currently running other services or receivers.</span></span><br><span class="line"><span class="number">450</span>                addToStarting = <span class="keyword">true</span>;</span><br><span class="line"><span class="number">451</span>                <span class="keyword">if</span> (DEBUG_DELAYED_STARTS) Slog.v(TAG_SERVICE,</span><br><span class="line"><span class="number">452</span>                        <span class="string">"Not delaying, but counting as bg: "</span> + r);</span><br><span class="line"><span class="number">453</span>            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (DEBUG_DELAYED_STARTS) &#123;</span><br><span class="line"><span class="number">454</span>                StringBuilder sb = <span class="keyword">new</span> StringBuilder(<span class="number">128</span>);</span><br><span class="line"><span class="number">455</span>                sb.append(<span class="string">"Not potential delay (state="</span>).append(proc.curProcState)</span><br><span class="line"><span class="number">456</span>                        .append(<span class="string">' '</span>).append(proc.adjType);</span><br><span class="line"><span class="number">457</span>                String reason = proc.makeAdjReason();</span><br><span class="line"><span class="number">458</span>                <span class="keyword">if</span> (reason != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">459</span>                    sb.append(<span class="string">' '</span>);</span><br><span class="line"><span class="number">460</span>                    sb.append(reason);</span><br><span class="line"><span class="number">461</span>                &#125;</span><br><span class="line"><span class="number">462</span>                sb.append(<span class="string">"): "</span>);</span><br><span class="line"><span class="number">463</span>                sb.append(r.toString());</span><br><span class="line"><span class="number">464</span>                Slog.v(TAG_SERVICE, sb.toString());</span><br><span class="line"><span class="number">465</span>            &#125;</span><br><span class="line"><span class="number">466</span>        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (DEBUG_DELAYED_STARTS) &#123;</span><br><span class="line"><span class="number">467</span>            <span class="keyword">if</span> (callerFg || fgRequired) &#123;</span><br><span class="line"><span class="number">468</span>                Slog.v(TAG_SERVICE, <span class="string">"Not potential delay (callerFg="</span> + callerFg + <span class="string">" uid="</span></span><br><span class="line"><span class="number">469</span>                        + callingUid + <span class="string">" pid="</span> + callingPid + <span class="string">" fgRequired="</span> + fgRequired + <span class="string">"): "</span> + r);</span><br><span class="line"><span class="number">470</span>            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r.app != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">471</span>                Slog.v(TAG_SERVICE, <span class="string">"Not potential delay (cur app="</span> + r.app + <span class="string">"): "</span> + r);</span><br><span class="line"><span class="number">472</span>            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="number">473</span>                Slog.v(TAG_SERVICE,</span><br><span class="line"><span class="number">474</span>                        <span class="string">"Not potential delay (user "</span> + r.userId + <span class="string">" not started): "</span> + r);</span><br><span class="line"><span class="number">475</span>            &#125;</span><br><span class="line"><span class="number">476</span>        &#125;</span><br><span class="line"><span class="number">477</span></span><br><span class="line"><span class="number">478</span>        ComponentName cmp = startServiceInnerLocked(smap, service, r, callerFg, addToStarting);</span><br><span class="line"><span class="number">479</span>        <span class="keyword">return</span> cmp;</span><br><span class="line"><span class="number">480</span>    &#125;</span><br></pre></td></tr></table></figure></p>
<p>最后调用了ComponentName cmp = startServiceInnerLocked(smap, service, r, callerFg, addToStarting);<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ComponentName <span class="title">startServiceInnerLocked</span><span class="params">(ServiceMap smap, Intent service, ServiceRecord r,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">527</span>            <span class="keyword">boolean</span> callerFg, <span class="keyword">boolean</span> addToStarting)</span> <span class="keyword">throws</span> TransactionTooLargeException </span>&#123;</span><br><span class="line"><span class="number">528</span>        ServiceState stracker = r.getTracker();</span><br><span class="line"><span class="number">529</span>        <span class="keyword">if</span> (stracker != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">530</span>            stracker.setStarted(<span class="keyword">true</span>, mAm.mProcessStats.getMemFactorLocked(), r.lastActivity);</span><br><span class="line"><span class="number">531</span>        &#125;</span><br><span class="line"><span class="number">532</span>        r.callStart = <span class="keyword">false</span>;</span><br><span class="line"><span class="number">533</span>        <span class="keyword">synchronized</span> (r.stats.getBatteryStats()) &#123;</span><br><span class="line"><span class="number">534</span>            r.stats.startRunningLocked();</span><br><span class="line"><span class="number">535</span>        &#125;</span><br><span class="line"><span class="number">536</span>        String error = bringUpServiceLocked(r, service.getFlags(), callerFg, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line"><span class="number">537</span>        <span class="keyword">if</span> (error != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">538</span>            <span class="keyword">return</span> <span class="keyword">new</span> ComponentName(<span class="string">"!!"</span>, error);</span><br><span class="line"><span class="number">539</span>        &#125;</span><br><span class="line"><span class="number">540</span></span><br><span class="line"><span class="number">541</span>        <span class="keyword">if</span> (r.startRequested &amp;&amp; addToStarting) &#123;</span><br><span class="line"><span class="number">542</span>            <span class="keyword">boolean</span> first = smap.mStartingBackground.size() == <span class="number">0</span>;</span><br><span class="line"><span class="number">543</span>            smap.mStartingBackground.add(r);</span><br><span class="line"><span class="number">544</span>            r.startingBgTimeout = SystemClock.uptimeMillis() + mAm.mConstants.BG_START_TIMEOUT;</span><br><span class="line"><span class="number">545</span>            <span class="keyword">if</span> (DEBUG_DELAYED_SERVICE) &#123;</span><br><span class="line"><span class="number">546</span>                RuntimeException here = <span class="keyword">new</span> RuntimeException(<span class="string">"here"</span>);</span><br><span class="line"><span class="number">547</span>                here.fillInStackTrace();</span><br><span class="line"><span class="number">548</span>                Slog.v(TAG_SERVICE, <span class="string">"Starting background (first="</span> + first + <span class="string">"): "</span> + r, here);</span><br><span class="line"><span class="number">549</span>            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (DEBUG_DELAYED_STARTS) &#123;</span><br><span class="line"><span class="number">550</span>                Slog.v(TAG_SERVICE, <span class="string">"Starting background (first="</span> + first + <span class="string">"): "</span> + r);</span><br><span class="line"><span class="number">551</span>            &#125;</span><br><span class="line"><span class="number">552</span>            <span class="keyword">if</span> (first) &#123;</span><br><span class="line"><span class="number">553</span>                smap.rescheduleDelayedStartsLocked();</span><br><span class="line"><span class="number">554</span>            &#125;</span><br><span class="line"><span class="number">555</span>        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (callerFg || r.fgRequired) &#123;</span><br><span class="line"><span class="number">556</span>            smap.ensureNotStartingBackgroundLocked(r);</span><br><span class="line"><span class="number">557</span>        &#125;</span><br><span class="line"><span class="number">558</span></span><br><span class="line"><span class="number">559</span>        <span class="keyword">return</span> r.name;</span><br><span class="line"><span class="number">560</span>    &#125;</span><br></pre></td></tr></table></figure></p>
<p>这个方法中又调用到了 String error = bringUpServiceLocked(r, service.getFlags(), callerFg, false, false);<br>然后掉用到：<br>sendServiceArgsLocked(r, execInFg, false);<br>进而调用到：<br>realStartServiceLocked(r, app, execInFg);<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">realStartServiceLocked</span><span class="params">(ServiceRecord r,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">2190</span>            ProcessRecord app, <span class="keyword">boolean</span> execInFg)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line"><span class="number">2191</span>        <span class="keyword">if</span> (app.thread == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">2192</span>            <span class="keyword">throw</span> <span class="keyword">new</span> RemoteException();</span><br><span class="line"><span class="number">2193</span>        &#125;</span><br><span class="line"><span class="number">2194</span>        <span class="keyword">if</span> (DEBUG_MU)</span><br><span class="line"><span class="number">2195</span>            Slog.v(TAG_MU, <span class="string">"realStartServiceLocked, ServiceRecord.uid = "</span> + r.appInfo.uid</span><br><span class="line"><span class="number">2196</span>                    + <span class="string">", ProcessRecord.uid = "</span> + app.uid);</span><br><span class="line"><span class="number">2197</span>        r.app = app;</span><br><span class="line"><span class="number">2198</span>        r.restartTime = r.lastActivity = SystemClock.uptimeMillis();</span><br><span class="line"><span class="number">2199</span></span><br><span class="line"><span class="number">2200</span>        <span class="keyword">final</span> <span class="keyword">boolean</span> newService = app.services.add(r);</span><br><span class="line"><span class="number">2201</span>        bumpServiceExecutingLocked(r, execInFg, <span class="string">"create"</span>);</span><br><span class="line"><span class="number">2202</span>        mAm.updateLruProcessLocked(app, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line"><span class="number">2203</span>        updateServiceForegroundLocked(r.app, <span class="comment">/* oomAdj= */</span> <span class="keyword">false</span>);</span><br><span class="line"><span class="number">2204</span>        mAm.updateOomAdjLocked();</span><br><span class="line"><span class="number">2205</span></span><br><span class="line"><span class="number">2206</span>        <span class="keyword">boolean</span> created = <span class="keyword">false</span>;</span><br><span class="line"><span class="number">2207</span>        <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="number">2208</span>            <span class="keyword">if</span> (LOG_SERVICE_START_STOP) &#123;</span><br><span class="line"><span class="number">2209</span>                String nameTerm;</span><br><span class="line"><span class="number">2210</span>                <span class="keyword">int</span> lastPeriod = r.shortName.lastIndexOf(<span class="string">'.'</span>);</span><br><span class="line"><span class="number">2211</span>                nameTerm = lastPeriod &gt;= <span class="number">0</span> ? r.shortName.substring(lastPeriod) : r.shortName;</span><br><span class="line"><span class="number">2212</span>                EventLogTags.writeAmCreateService(</span><br><span class="line"><span class="number">2213</span>                        r.userId, System.identityHashCode(r), nameTerm, r.app.uid, r.app.pid);</span><br><span class="line"><span class="number">2214</span>            &#125;</span><br><span class="line"><span class="number">2215</span>            <span class="keyword">synchronized</span> (r.stats.getBatteryStats()) &#123;</span><br><span class="line"><span class="number">2216</span>                r.stats.startLaunchedLocked();</span><br><span class="line"><span class="number">2217</span>            &#125;</span><br><span class="line"><span class="number">2218</span>            mAm.notifyPackageUse(r.serviceInfo.packageName,</span><br><span class="line"><span class="number">2219</span>                                 PackageManager.NOTIFY_PACKAGE_USE_SERVICE);</span><br><span class="line"><span class="number">2220</span>            app.forceProcessStateUpTo(ActivityManager.PROCESS_STATE_SERVICE);</span><br><span class="line"><span class="number">2221</span>            app.thread.scheduleCreateService(r, r.serviceInfo,</span><br><span class="line"><span class="number">2222</span>                    mAm.compatibilityInfoForPackageLocked(r.serviceInfo.applicationInfo),</span><br><span class="line"><span class="number">2223</span>                    app.repProcState);</span><br><span class="line"><span class="number">2224</span>            r.postNotification();</span><br><span class="line"><span class="number">2225</span>            created = <span class="keyword">true</span>;</span><br><span class="line"><span class="number">2226</span>        &#125; <span class="keyword">catch</span> (DeadObjectException e) &#123;</span><br><span class="line"><span class="number">2227</span>            Slog.w(TAG, <span class="string">"Application dead when creating service "</span> + r);</span><br><span class="line"><span class="number">2228</span>            mAm.appDiedLocked(app);</span><br><span class="line"><span class="number">2229</span>            <span class="keyword">throw</span> e;</span><br><span class="line"><span class="number">2230</span>        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line"><span class="number">2231</span>            <span class="keyword">if</span> (!created) &#123;</span><br><span class="line"><span class="number">2232</span>                <span class="comment">// Keep the executeNesting count accurate.</span></span><br><span class="line"><span class="number">2233</span>                <span class="keyword">final</span> <span class="keyword">boolean</span> inDestroying = mDestroyingServices.contains(r);</span><br><span class="line"><span class="number">2234</span>                serviceDoneExecutingLocked(r, inDestroying, inDestroying);</span><br><span class="line"><span class="number">2235</span></span><br><span class="line"><span class="number">2236</span>                <span class="comment">// Cleanup.</span></span><br><span class="line"><span class="number">2237</span>                <span class="keyword">if</span> (newService) &#123;</span><br><span class="line"><span class="number">2238</span>                    app.services.remove(r);</span><br><span class="line"><span class="number">2239</span>                    r.app = <span class="keyword">null</span>;</span><br><span class="line"><span class="number">2240</span>                &#125;</span><br><span class="line"><span class="number">2241</span></span><br><span class="line"><span class="number">2242</span>                <span class="comment">// Retry.</span></span><br><span class="line"><span class="number">2243</span>                <span class="keyword">if</span> (!inDestroying) &#123;</span><br><span class="line"><span class="number">2244</span>                    scheduleServiceRestartLocked(r, <span class="keyword">false</span>);</span><br><span class="line"><span class="number">2245</span>                &#125;</span><br><span class="line"><span class="number">2246</span>            &#125;</span><br><span class="line"><span class="number">2247</span>        &#125;</span><br><span class="line"><span class="number">2248</span></span><br><span class="line"><span class="number">2249</span>        <span class="keyword">if</span> (r.whitelistManager) &#123;</span><br><span class="line"><span class="number">2250</span>            app.whitelistManager = <span class="keyword">true</span>;</span><br><span class="line"><span class="number">2251</span>        &#125;</span><br><span class="line"><span class="number">2252</span></span><br><span class="line"><span class="number">2253</span>        requestServiceBindingsLocked(r, execInFg);</span><br><span class="line"><span class="number">2254</span></span><br><span class="line"><span class="number">2255</span>        updateServiceClientActivitiesLocked(app, <span class="keyword">null</span>, <span class="keyword">true</span>);</span><br><span class="line"><span class="number">2256</span></span><br><span class="line"><span class="number">2257</span>        <span class="comment">// If the service is in the started state, and there are no</span></span><br><span class="line"><span class="number">2258</span>        <span class="comment">// pending arguments, then fake up one so its onStartCommand() will</span></span><br><span class="line"><span class="number">2259</span>        <span class="comment">// be called.</span></span><br><span class="line"><span class="number">2260</span>        <span class="keyword">if</span> (r.startRequested &amp;&amp; r.callStart &amp;&amp; r.pendingStarts.size() == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">2261</span>            r.pendingStarts.add(<span class="keyword">new</span> ServiceRecord.StartItem(r, <span class="keyword">false</span>, r.makeNextStartId(),</span><br><span class="line"><span class="number">2262</span>                    <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="number">0</span>));</span><br><span class="line"><span class="number">2263</span>        &#125;</span><br><span class="line"><span class="number">2264</span></span><br><span class="line"><span class="number">2265</span>        sendServiceArgsLocked(r, execInFg, <span class="keyword">true</span>);</span><br><span class="line"><span class="number">2266</span></span><br><span class="line"><span class="number">2267</span>        <span class="keyword">if</span> (r.delayed) &#123;</span><br><span class="line"><span class="number">2268</span>            <span class="keyword">if</span> (DEBUG_DELAYED_STARTS) Slog.v(TAG_SERVICE, <span class="string">"REM FR DELAY LIST (new proc): "</span> + r);</span><br><span class="line"><span class="number">2269</span>            getServiceMapLocked(r.userId).mDelayedStartList.remove(r);</span><br><span class="line"><span class="number">2270</span>            r.delayed = <span class="keyword">false</span>;</span><br><span class="line"><span class="number">2271</span>        &#125;</span><br><span class="line"><span class="number">2272</span></span><br><span class="line"><span class="number">2273</span>        <span class="keyword">if</span> (r.delayedStop) &#123;</span><br><span class="line"><span class="number">2274</span>            <span class="comment">// Oh and hey we've already been asked to stop!</span></span><br><span class="line"><span class="number">2275</span>            r.delayedStop = <span class="keyword">false</span>;</span><br><span class="line"><span class="number">2276</span>            <span class="keyword">if</span> (r.startRequested) &#123;</span><br><span class="line"><span class="number">2277</span>                <span class="keyword">if</span> (DEBUG_DELAYED_STARTS) Slog.v(TAG_SERVICE,</span><br><span class="line"><span class="number">2278</span>                        <span class="string">"Applying delayed stop (from start): "</span> + r);</span><br><span class="line"><span class="number">2279</span>                stopServiceLocked(r);</span><br><span class="line"><span class="number">2280</span>            &#125;</span><br><span class="line"><span class="number">2281</span>        &#125;</span><br><span class="line"><span class="number">2282</span>    &#125;</span><br></pre></td></tr></table></figure></p>
<p>app.thread.scheduleCreateService,这个thread就是IApplicationThread，就是ActivityThread对象，于是我们回到ActivityThread中：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">scheduleCreateService</span><span class="params">(IBinder token,</span></span></span><br><span class="line"><span class="function"><span class="params">ServiceInfo info, CompatibilityInfo compatInfo, <span class="keyword">int</span> processState)</span> </span>&#123;</span><br><span class="line">updateProcessState(processState, <span class="keyword">false</span>);</span><br><span class="line">CreateServiceData s = <span class="keyword">new</span> CreateServiceData();</span><br><span class="line">s.token = token;</span><br><span class="line">s.info = info;</span><br><span class="line">s.compatInfo = compatInfo;</span><br><span class="line"></span><br><span class="line">sendMessage(H.CREATE_SERVICE, s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们去到H中找到对应的handleMessage处理CREATE_SERVICE的方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> CREATE_SERVICE:</span><br><span class="line">Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, (<span class="string">"serviceCreate: "</span> + String.valueOf(msg.obj)));</span><br><span class="line">handleCreateService((CreateServiceData)msg.obj);</span><br><span class="line">Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line"><span class="keyword">break</span>;</span><br></pre></td></tr></table></figure></p>
<p>然后handleCreateService：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleCreateService</span><span class="params">(CreateServiceData data)</span> </span>&#123;</span><br><span class="line"><span class="comment">// If we are getting ready to gc after going to the background, well</span></span><br><span class="line"><span class="comment">// we are back active so skip it.</span></span><br><span class="line">unscheduleGcIdler();</span><br><span class="line"></span><br><span class="line">LoadedApk packageInfo = getPackageInfoNoCheck(</span><br><span class="line">data.info.applicationInfo, data.compatInfo);</span><br><span class="line">Service service = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">java.lang.ClassLoader cl = packageInfo.getClassLoader();</span><br><span class="line">service = (Service) cl.loadClass(data.info.name).newInstance();</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"><span class="keyword">if</span> (!mInstrumentation.onException(service, e)) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line"><span class="string">"Unable to instantiate service "</span> + data.info.name</span><br><span class="line">+ <span class="string">": "</span> + e.toString(), e);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (localLOGV) Slog.v(TAG, <span class="string">"Creating service "</span> + data.info.name);</span><br><span class="line"></span><br><span class="line">ContextImpl context = ContextImpl.createAppContext(<span class="keyword">this</span>, packageInfo);</span><br><span class="line">context.setOuterContext(service);</span><br><span class="line"></span><br><span class="line">Application app = packageInfo.makeApplication(<span class="keyword">false</span>, mInstrumentation);</span><br><span class="line">service.attach(context, <span class="keyword">this</span>, data.info.name, data.token, app,</span><br><span class="line">ActivityManagerNative.getDefault());</span><br><span class="line">service.onCreate();</span><br><span class="line">mServices.put(data.token, service);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">ActivityManagerNative.getDefault().serviceDoneExecuting(</span><br><span class="line">data.token, SERVICE_DONE_EXECUTING_ANON, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line"><span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"><span class="keyword">if</span> (!mInstrumentation.onException(service, e)) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line"><span class="string">"Unable to create service "</span> + data.info.name</span><br><span class="line">+ <span class="string">": "</span> + e.toString(), e);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个方法中service = (Service) cl.loadClass(data.info.name).newInstance();<br>用反射的方式创建了service对象；<br>然后ContextImpl context = ContextImpl.createAppContext(this, packageInfo);又创建了context对象；<br>然后用service.attach将context对象进行参数设置；<br>然后就调用了service.onCreate();<br>这就是Service的启动过程。</p>
<p>在刚刚realStartServiceLocked方法中：调用了 app.thread.scheduleCreateService方法后又调用了：<br>sendServiceArgsLocked(r, execInFg, true);<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">sendServiceArgsLocked</span><span class="params">(ServiceRecord r, <span class="keyword">boolean</span> execInFg,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">2285</span>            <span class="keyword">boolean</span> oomAdjusted)</span> <span class="keyword">throws</span> TransactionTooLargeException </span>&#123;</span><br><span class="line"><span class="number">2286</span>        <span class="keyword">final</span> <span class="keyword">int</span> N = r.pendingStarts.size();</span><br><span class="line"><span class="number">2287</span>        <span class="keyword">if</span> (N == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">2288</span>            <span class="keyword">return</span>;</span><br><span class="line"><span class="number">2289</span>        &#125;</span><br><span class="line"><span class="number">2290</span></span><br><span class="line"><span class="number">2291</span>        ArrayList&lt;ServiceStartArgs&gt; args = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"><span class="number">2292</span></span><br><span class="line"><span class="number">2293</span>        <span class="keyword">while</span> (r.pendingStarts.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">2294</span>            ServiceRecord.StartItem si = r.pendingStarts.remove(<span class="number">0</span>);</span><br><span class="line"><span class="number">2295</span>            <span class="keyword">if</span> (DEBUG_SERVICE) &#123;</span><br><span class="line"><span class="number">2296</span>                Slog.v(TAG_SERVICE, <span class="string">"Sending arguments to: "</span></span><br><span class="line"><span class="number">2297</span>                        + r + <span class="string">" "</span> + r.intent + <span class="string">" args="</span> + si.intent);</span><br><span class="line"><span class="number">2298</span>            &#125;</span><br><span class="line"><span class="number">2299</span>            <span class="keyword">if</span> (si.intent == <span class="keyword">null</span> &amp;&amp; N &gt; <span class="number">1</span>) &#123;</span><br><span class="line"><span class="number">2300</span>                <span class="comment">// If somehow we got a dummy null intent in the middle,</span></span><br><span class="line"><span class="number">2301</span>                <span class="comment">// then skip it.  DO NOT skip a null intent when it is</span></span><br><span class="line"><span class="number">2302</span>                <span class="comment">// the only one in the list -- this is to support the</span></span><br><span class="line"><span class="number">2303</span>                <span class="comment">// onStartCommand(null) case.</span></span><br><span class="line"><span class="number">2304</span>                <span class="keyword">continue</span>;</span><br><span class="line"><span class="number">2305</span>            &#125;</span><br><span class="line"><span class="number">2306</span>            si.deliveredTime = SystemClock.uptimeMillis();</span><br><span class="line"><span class="number">2307</span>            r.deliveredStarts.add(si);</span><br><span class="line"><span class="number">2308</span>            si.deliveryCount++;</span><br><span class="line"><span class="number">2309</span>            <span class="keyword">if</span> (si.neededGrants != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">2310</span>                mAm.grantUriPermissionUncheckedFromIntentLocked(si.neededGrants,</span><br><span class="line"><span class="number">2311</span>                        si.getUriPermissionsLocked());</span><br><span class="line"><span class="number">2312</span>            &#125;</span><br><span class="line"><span class="number">2313</span>            mAm.grantEphemeralAccessLocked(r.userId, si.intent,</span><br><span class="line"><span class="number">2314</span>                    r.appInfo.uid, UserHandle.getAppId(si.callingId));</span><br><span class="line"><span class="number">2315</span>            bumpServiceExecutingLocked(r, execInFg, <span class="string">"start"</span>);</span><br><span class="line"><span class="number">2316</span>            <span class="keyword">if</span> (!oomAdjusted) &#123;</span><br><span class="line"><span class="number">2317</span>                oomAdjusted = <span class="keyword">true</span>;</span><br><span class="line"><span class="number">2318</span>                mAm.updateOomAdjLocked(r.app, <span class="keyword">true</span>);</span><br><span class="line"><span class="number">2319</span>            &#125;</span><br><span class="line"><span class="number">2320</span>            <span class="keyword">if</span> (r.fgRequired &amp;&amp; !r.fgWaiting) &#123;</span><br><span class="line"><span class="number">2321</span>                <span class="keyword">if</span> (!r.isForeground) &#123;</span><br><span class="line"><span class="number">2322</span>                    <span class="keyword">if</span> (DEBUG_BACKGROUND_CHECK) &#123;</span><br><span class="line"><span class="number">2323</span>                        Slog.i(TAG, <span class="string">"Launched service must call startForeground() within timeout: "</span> + r);</span><br><span class="line"><span class="number">2324</span>                    &#125;</span><br><span class="line"><span class="number">2325</span>                    scheduleServiceForegroundTransitionTimeoutLocked(r);</span><br><span class="line"><span class="number">2326</span>                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="number">2327</span>                    <span class="keyword">if</span> (DEBUG_BACKGROUND_CHECK) &#123;</span><br><span class="line"><span class="number">2328</span>                        Slog.i(TAG, <span class="string">"Service already foreground; no new timeout: "</span> + r);</span><br><span class="line"><span class="number">2329</span>                    &#125;</span><br><span class="line"><span class="number">2330</span>                    r.fgRequired = <span class="keyword">false</span>;</span><br><span class="line"><span class="number">2331</span>                &#125;</span><br><span class="line"><span class="number">2332</span>            &#125;</span><br><span class="line"><span class="number">2333</span>            <span class="keyword">int</span> flags = <span class="number">0</span>;</span><br><span class="line"><span class="number">2334</span>            <span class="keyword">if</span> (si.deliveryCount &gt; <span class="number">1</span>) &#123;</span><br><span class="line"><span class="number">2335</span>                flags |= Service.START_FLAG_RETRY;</span><br><span class="line"><span class="number">2336</span>            &#125;</span><br><span class="line"><span class="number">2337</span>            <span class="keyword">if</span> (si.doneExecutingCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">2338</span>                flags |= Service.START_FLAG_REDELIVERY;</span><br><span class="line"><span class="number">2339</span>            &#125;</span><br><span class="line"><span class="number">2340</span>            args.add(<span class="keyword">new</span> ServiceStartArgs(si.taskRemoved, si.id, flags, si.intent));</span><br><span class="line"><span class="number">2341</span>        &#125;</span><br><span class="line"><span class="number">2342</span></span><br><span class="line"><span class="number">2343</span>        ParceledListSlice&lt;ServiceStartArgs&gt; slice = <span class="keyword">new</span> ParceledListSlice&lt;&gt;(args);</span><br><span class="line"><span class="number">2344</span>        slice.setInlineCountLimit(<span class="number">4</span>);</span><br><span class="line"><span class="number">2345</span>        Exception caughtException = <span class="keyword">null</span>;</span><br><span class="line"><span class="number">2346</span>        <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="number">2347</span>            r.app.thread.scheduleServiceArgs(r, slice);</span><br><span class="line"><span class="number">2348</span>        &#125; <span class="keyword">catch</span> (TransactionTooLargeException e) &#123;</span><br><span class="line"><span class="number">2349</span>            <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"Transaction too large for "</span> + args.size()</span><br><span class="line"><span class="number">2350</span>                    + <span class="string">" args, first: "</span> + args.get(<span class="number">0</span>).args);</span><br><span class="line"><span class="number">2351</span>            Slog.w(TAG, <span class="string">"Failed delivering service starts"</span>, e);</span><br><span class="line"><span class="number">2352</span>            caughtException = e;</span><br><span class="line"><span class="number">2353</span>        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line"><span class="number">2354</span>            <span class="comment">// Remote process gone...  we'll let the normal cleanup take care of this.</span></span><br><span class="line"><span class="number">2355</span>            <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"Crashed while sending args: "</span> + r);</span><br><span class="line"><span class="number">2356</span>            Slog.w(TAG, <span class="string">"Failed delivering service starts"</span>, e);</span><br><span class="line"><span class="number">2357</span>            caughtException = e;</span><br><span class="line"><span class="number">2358</span>        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"><span class="number">2359</span>            Slog.w(TAG, <span class="string">"Unexpected exception"</span>, e);</span><br><span class="line"><span class="number">2360</span>            caughtException = e;</span><br><span class="line"><span class="number">2361</span>        &#125;</span><br><span class="line"><span class="number">2362</span></span><br><span class="line"><span class="number">2363</span>        <span class="keyword">if</span> (caughtException != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">2364</span>            <span class="comment">// Keep nesting count correct</span></span><br><span class="line"><span class="number">2365</span>            <span class="keyword">final</span> <span class="keyword">boolean</span> inDestroying = mDestroyingServices.contains(r);</span><br><span class="line"><span class="number">2366</span>            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; args.size(); i++) &#123;</span><br><span class="line"><span class="number">2367</span>                serviceDoneExecutingLocked(r, inDestroying, inDestroying);</span><br><span class="line"><span class="number">2368</span>            &#125;</span><br><span class="line"><span class="number">2369</span>            <span class="keyword">if</span> (caughtException <span class="keyword">instanceof</span> TransactionTooLargeException) &#123;</span><br><span class="line"><span class="number">2370</span>                <span class="keyword">throw</span> (TransactionTooLargeException)caughtException;</span><br><span class="line"><span class="number">2371</span>            &#125;</span><br><span class="line"><span class="number">2372</span>        &#125;</span><br><span class="line"><span class="number">2373</span>    &#125;</span><br></pre></td></tr></table></figure></p>
<p>看到有这么一句r.app.thread.scheduleServiceArgs(r, slice);<br>于是回到ActivityThread中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">scheduleServiceArgs</span><span class="params">(IBinder token, <span class="keyword">boolean</span> taskRemoved, <span class="keyword">int</span> startId,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="keyword">int</span> flags ,Intent args)</span> </span>&#123;</span><br><span class="line">ServiceArgsData s = <span class="keyword">new</span> ServiceArgsData();</span><br><span class="line">s.token = token;</span><br><span class="line">s.taskRemoved = taskRemoved;</span><br><span class="line">s.startId = startId;</span><br><span class="line">s.flags = flags;</span><br><span class="line">s.args = args;</span><br><span class="line"></span><br><span class="line">sendMessage(H.SERVICE_ARGS, s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>还是去H中找对应的处理case：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> SERVICE_ARGS:</span><br><span class="line">Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, (<span class="string">"serviceStart: "</span> + String.valueOf(msg.obj)));</span><br><span class="line">handleServiceArgs((ServiceArgsData)msg.obj);</span><br><span class="line">Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line"><span class="keyword">break</span>;</span><br></pre></td></tr></table></figure></p>
<p>接着去看handleServiceArgs：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleServiceArgs</span><span class="params">(ServiceArgsData data)</span> </span>&#123;</span><br><span class="line">Service s = mServices.get(data.token);</span><br><span class="line"><span class="keyword">if</span> (s != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (data.args != <span class="keyword">null</span>) &#123;</span><br><span class="line">data.args.setExtrasClassLoader(s.getClassLoader());</span><br><span class="line">data.args.prepareToEnterProcess();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">int</span> res;</span><br><span class="line"><span class="keyword">if</span> (!data.taskRemoved) &#123;</span><br><span class="line">res = s.onStartCommand(data.args, data.flags, data.startId);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">s.onTaskRemoved(data.args);</span><br><span class="line">res = Service.START_TASK_REMOVED_COMPLETE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">QueuedWork.waitToFinish();</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">ActivityManagerNative.getDefault().serviceDoneExecuting(</span><br><span class="line">data.token, SERVICE_DONE_EXECUTING_START, data.startId, res);</span><br><span class="line">&#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line"><span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">&#125;</span><br><span class="line">ensureJitEnabled();</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"><span class="keyword">if</span> (!mInstrumentation.onException(s, e)) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line"><span class="string">"Unable to start service "</span> + s</span><br><span class="line">+ <span class="string">" with "</span> + data.args + <span class="string">": "</span> + e.toString(), e);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>s.onStartCommand中s就是上面创建的service对象。那么onStartCommand方法就是在这里调用的。至此service启动过程完毕。下面画图看下这个流程：<br><img src="http://opq81riyh.bkt.clouddn.com/startservice.png" alt=""></p>
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/源码解析/" rel="tag"># 源码解析</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/01/19/RemoteViews一-仿qq音乐自定义通知栏实现快捷切换歌曲/" rel="next" title="RemoteViews一 仿qq音乐自定义通知栏实现快捷切换歌曲">
                <i class="fa fa-chevron-left"></i> RemoteViews一 仿qq音乐自定义通知栏实现快捷切换歌曲
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/01/25/基于8-0源码解析：bindService-启动过程/" rel="prev" title="基于8.0源码解析：bindService 启动过程">
                基于8.0源码解析：bindService 启动过程 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="http://opq81riyh.bkt.clouddn.com/666.jpg" alt="吴晓龙">
            
              <p class="site-author-name" itemprop="name">吴晓龙</p>
              <p class="site-description motion-element" itemprop="description">耐得住寂寞 守得住繁华</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">23</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">12</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">13</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/lantier743865" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-globe"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://weibo.com/3166661920/profile?topnav=1&wvr=6" target="_blank" title="微博">
                      
                        <i class="fa fa-fw fa-globe"></i>微博</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://juejin.im/user/58c9e40b61ff4b006c808011" target="_blank" title="掘金">
                      
                        <i class="fa fa-fw fa-globe"></i>掘金</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.jianshu.com/u/218df555dee7" target="_blank" title="简书">
                      
                        <i class="fa fa-fw fa-globe"></i>简书</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#基于8-0源码解析：startService-启动过程"><span class="nav-number">1.</span> <span class="nav-text">基于8.0源码解析：startService 启动过程</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">吴晓龙</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
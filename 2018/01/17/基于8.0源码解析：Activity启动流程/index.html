<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="源码解析,">





  <link rel="alternate" href="/atom.xml" title="吴晓龙" type="application/atom+xml">






<meta name="description" content="基于8.0源码解析：Activity启动流程标签（空格分隔）： 未分类  调用startActivity，会执行Activity中的startActivity1234@Overridepublic void startActivity(Intent intent) &amp;#123;this.startActivity(intent, null);&amp;#125; 然后调用它的重载方法12345678910">
<meta name="keywords" content="源码解析">
<meta property="og:type" content="article">
<meta property="og:title" content="Activity启动流程">
<meta property="og:url" content="http://yoursite.com/2018/01/17/基于8.0源码解析：Activity启动流程/index.html">
<meta property="og:site_name" content="吴晓龙">
<meta property="og:description" content="基于8.0源码解析：Activity启动流程标签（空格分隔）： 未分类  调用startActivity，会执行Activity中的startActivity1234@Overridepublic void startActivity(Intent intent) &amp;#123;this.startActivity(intent, null);&amp;#125; 然后调用它的重载方法12345678910">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2018-01-25T03:47:56.404Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Activity启动流程">
<meta name="twitter:description" content="基于8.0源码解析：Activity启动流程标签（空格分隔）： 未分类  调用startActivity，会执行Activity中的startActivity1234@Overridepublic void startActivity(Intent intent) &amp;#123;this.startActivity(intent, null);&amp;#125; 然后调用它的重载方法12345678910">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/01/17/基于8.0源码解析：Activity启动流程/">





  <title>Activity启动流程 | 吴晓龙</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">吴晓龙</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">爱吃哈密瓜的程序员</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-search">
          <a href="/search" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            搜索
          </a>
        </li>
      
        
        <li class="menu-item menu-item-schedule">
          <a href="/schedule" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            日程表
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            站点地图
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/commonweal" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            公益404
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/17/基于8.0源码解析：Activity启动流程/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="吴晓龙">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://opq81riyh.bkt.clouddn.com/666.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="吴晓龙">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Activity启动流程</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-17T20:18:45+08:00">
                2018-01-17
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/源码解析/" itemprop="url" rel="index">
                    <span itemprop="name">源码解析</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="基于8-0源码解析：Activity启动流程"><a href="#基于8-0源码解析：Activity启动流程" class="headerlink" title="基于8.0源码解析：Activity启动流程"></a>基于8.0源码解析：Activity启动流程</h1><p>标签（空格分隔）： 未分类</p>
<hr>
<p>调用startActivity，会执行Activity中的startActivity<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivity</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.startActivity(intent, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后调用它的重载方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivity</span><span class="params">(Intent intent, @Nullable Bundle options)</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (options != <span class="keyword">null</span>) &#123;</span><br><span class="line">startActivityForResult(intent, -<span class="number">1</span>, options);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// Note we want to go through this call for compatibility with</span></span><br><span class="line"><span class="comment">// applications that may have overridden the method.</span></span><br><span class="line">startActivityForResult(intent, -<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>最后会调用startActivityForResult<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivityForResult</span><span class="params">(@RequiresPermission Intent intent, <span class="keyword">int</span> requestCode,</span></span></span><br><span class="line"><span class="function"><span class="params">@Nullable Bundle options)</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (mParent == <span class="keyword">null</span>) &#123;</span><br><span class="line">options = transferSpringboardActivityOptions(options);</span><br><span class="line">Instrumentation.ActivityResult ar =</span><br><span class="line">mInstrumentation.execStartActivity(</span><br><span class="line"><span class="keyword">this</span>, mMainThread.getApplicationThread(), mToken, <span class="keyword">this</span>,</span><br><span class="line">intent, requestCode, options);</span><br><span class="line"><span class="keyword">if</span> (ar != <span class="keyword">null</span>) &#123;</span><br><span class="line">mMainThread.sendActivityResult(</span><br><span class="line">mToken, mEmbeddedID, requestCode, ar.getResultCode(),</span><br><span class="line">ar.getResultData());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (requestCode &gt;= <span class="number">0</span>) &#123;</span><br><span class="line"><span class="comment">// If this start is requesting a result, we can avoid making</span></span><br><span class="line"><span class="comment">// the activity visible until the result is received.  Setting</span></span><br><span class="line"><span class="comment">// this code during onCreate(Bundle savedInstanceState) or onResume() will keep the</span></span><br><span class="line"><span class="comment">// activity hidden during this time, to avoid flickering.</span></span><br><span class="line"><span class="comment">// This can only be done when a result is requested because</span></span><br><span class="line"><span class="comment">// that guarantees we will get information back when the</span></span><br><span class="line"><span class="comment">// activity is finished, no matter what happens to it.</span></span><br><span class="line">mStartedActivity = <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cancelInputsAndStartExitTransition(options);</span><br><span class="line"><span class="comment">// TODO Consider clearing/flushing other event sources and events for child windows.</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (options != <span class="keyword">null</span>) &#123;</span><br><span class="line">mParent.startActivityFromChild(<span class="keyword">this</span>, intent, requestCode, options);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// Note we want to go through this method for compatibility with</span></span><br><span class="line"><span class="comment">// existing applications that may have overridden it.</span></span><br><span class="line">mParent.startActivityFromChild(<span class="keyword">this</span>, intent, requestCode);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后会调用mInstrumentation的execStartActivity<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mInstrumentation.execStartActivity(</span><br><span class="line"><span class="keyword">this</span>, mMainThread.getApplicationThread(), mToken, <span class="keyword">this</span>,</span><br><span class="line">intent, requestCode, options);</span><br></pre></td></tr></table></figure></p>
<p>mInstrumentation是android系统中启动activity的一个实际操作类，也就是说activity在应用进程端的启动实际上就是instrumentation执行的。实际上activity的启动分为应用进程端的启动和systemserver服务端的启动。多个应用进程相互配合最终完成了activity在系统中的启动，而在应用进程端的启动实际的操作类就是intrumentation来执行的。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ActivityResult <span class="title">execStartActivity</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">Context who, IBinder contextThread, IBinder token, Activity target,</span></span></span><br><span class="line"><span class="function"><span class="params">Intent intent, <span class="keyword">int</span> requestCode, Bundle options)</span> </span>&#123;</span><br><span class="line">IApplicationThread whoThread = (IApplicationThread) contextThread;</span><br><span class="line">Uri referrer = target != <span class="keyword">null</span> ? target.onProvideReferrer() : <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">if</span> (referrer != <span class="keyword">null</span>) &#123;</span><br><span class="line">intent.putExtra(Intent.EXTRA_REFERRER, referrer);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (mActivityMonitors != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="keyword">synchronized</span> (mSync) &#123;</span><br><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> N = mActivityMonitors.size();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line"><span class="keyword">final</span> ActivityMonitor am = mActivityMonitors.get(i);</span><br><span class="line"><span class="keyword">if</span> (am.match(who, <span class="keyword">null</span>, intent)) &#123;</span><br><span class="line">am.mHits++;</span><br><span class="line"><span class="keyword">if</span> (am.isBlocking()) &#123;</span><br><span class="line"><span class="keyword">return</span> requestCode &gt;= <span class="number">0</span> ? am.getResult() : <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">intent.migrateExtraStreamToClipData();</span><br><span class="line">intent.prepareToLeaveProcess(who);</span><br><span class="line"><span class="keyword">int</span> result = ActivityManagerNative.getDefault()</span><br><span class="line">.startActivity(whoThread, who.getBasePackageName(), intent,</span><br><span class="line">intent.resolveTypeIfNeeded(who.getContentResolver()),</span><br><span class="line">token, target != <span class="keyword">null</span> ? target.mEmbeddedID : <span class="keyword">null</span>,</span><br><span class="line">requestCode, <span class="number">0</span>, <span class="keyword">null</span>, options);</span><br><span class="line">checkStartActivityResult(result, intent);</span><br><span class="line">&#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Failure from system"</span>, e);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>于是发现了这个方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> result = ActivityManagerNative.getDefault()</span><br><span class="line">.startActivity(whoThread, who.getBasePackageName(), intent,</span><br><span class="line">intent.resolveTypeIfNeeded(who.getContentResolver()),</span><br><span class="line">token, target, requestCode, <span class="number">0</span>, <span class="keyword">null</span>, options);</span><br></pre></td></tr></table></figure></p>
<p>ActivityManagerNative.getDefault() 是什么？<br>到ActivityManagerNative中看一眼<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> IActivityManager <span class="title">getDefault</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> gDefault.get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>gDefault.get()又是什么？先看gDefault<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Singleton&lt;IActivityManager&gt; gDefault = <span class="keyword">new</span> Singleton&lt;IActivityManager&gt;() &#123;</span><br><span class="line"><span class="function"><span class="keyword">protected</span> IActivityManager <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">IBinder b = ServiceManager.getService(<span class="string">"activity"</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</span><br><span class="line">Log.v(<span class="string">"ActivityManager"</span>, <span class="string">"default service binder = "</span> + b);</span><br><span class="line">&#125;</span><br><span class="line">IActivityManager am = asInterface(b);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</span><br><span class="line">Log.v(<span class="string">"ActivityManager"</span>, <span class="string">"default service = "</span> + am);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> am;</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以发现启动了IActivityManager am = asInterface(b);<br>然后看asInterface(b)的实现：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> IActivityManager <span class="title">asInterface</span><span class="params">(IBinder obj)</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (obj == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line">IActivityManager in =</span><br><span class="line">(IActivityManager)obj.queryLocalInterface(descriptor);</span><br><span class="line"><span class="keyword">if</span> (in != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> in;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> ActivityManagerProxy(obj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>最后直击返回了ActivityManagerProxy。二ActivityManagerProxy继承自IActivityManager，IActivityManager extends IInterface。<br>应用进程与systemserver进程属于两个不同的进程，进程之间需要通讯，android系统采取了自身设计的binder机制，这里的activityManagerProxy和ActivityManagerNative都是继承IAcitivityManager，而Systemserver进程中的ActivityManagerServise对象则继承于ActivityManagerNative<br>Binder –&gt; ActivityManagerNative/ActivityManagerProxy –&gt;ActivityManagerService<br>这样ActivityManagerNative和ActivityManagerProxy相当于一个binder的客户端，而ActivityManagerService相当于Binder的服务端。这样当ActivityManagerNative调用接口方法的时候底层通过Binder driver就会将请求数据与请求传递给server端，并在server端进行具体的接口逻辑。binder机制是单向的，异步的。<br>继续看<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> result = ActivityManagerNative.getDefault()</span><br><span class="line">.startActivity(whoThread, who.getBasePackageName(), intent,</span><br><span class="line">intent.resolveTypeIfNeeded(who.getContentResolver()),</span><br><span class="line">token, target, requestCode, <span class="number">0</span>, <span class="keyword">null</span>, options);</span><br></pre></td></tr></table></figure></p>
<p>可以看到涉及到了binder数据传输机制，说明会调用systemserver进程<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(IApplicationThread caller, String callingPackage, Intent intent,</span></span></span><br><span class="line"><span class="function"><span class="params">String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle options)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">Parcel data = Parcel.obtain();</span><br><span class="line">Parcel reply = Parcel.obtain();</span><br><span class="line">data.writeInterfaceToken(IActivityManager.descriptor);</span><br><span class="line">data.writeStrongBinder(caller != <span class="keyword">null</span> ? caller.asBinder() : <span class="keyword">null</span>);</span><br><span class="line">data.writeString(callingPackage);</span><br><span class="line">intent.writeToParcel(data, <span class="number">0</span>);</span><br><span class="line">data.writeString(resolvedType);</span><br><span class="line">data.writeStrongBinder(resultTo);</span><br><span class="line">data.writeString(resultWho);</span><br><span class="line">data.writeInt(requestCode);</span><br><span class="line">data.writeInt(startFlags);</span><br><span class="line"><span class="keyword">if</span> (profilerInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">data.writeInt(<span class="number">1</span>);</span><br><span class="line">profilerInfo.writeToParcel(data, Parcelable.PARCELABLE_WRITE_RETURN_VALUE);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">data.writeInt(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (options != <span class="keyword">null</span>) &#123;</span><br><span class="line">data.writeInt(<span class="number">1</span>);</span><br><span class="line">options.writeToParcel(data, <span class="number">0</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">data.writeInt(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line">mRemote.transact(START_ACTIVITY_TRANSACTION, data, reply, <span class="number">0</span>);</span><br><span class="line">reply.readException();</span><br><span class="line"><span class="keyword">int</span> result = reply.readInt();</span><br><span class="line">reply.recycle();</span><br><span class="line">data.recycle();</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ActivityManagerService中查看startActivity<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(IApplicationThread caller, String callingPackage,</span></span></span><br><span class="line"><span class="function"><span class="params">Intent intent, String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle bOptions)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> startActivityAsUser(caller, callingPackage, intent, resolvedType, resultTo,</span><br><span class="line">resultWho, requestCode, startFlags, profilerInfo, bOptions,</span><br><span class="line">UserHandle.getCallingUserId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>又调用了startActivityAsUser<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityAsUser</span><span class="params">(IApplicationThread caller, String callingPackage,</span></span></span><br><span class="line"><span class="function"><span class="params">Intent intent, String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle bOptions, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">enforceNotIsolatedCaller(<span class="string">"startActivity"</span>);</span><br><span class="line">userId = mUserController.handleIncomingUser(Binder.getCallingPid(), Binder.getCallingUid(),</span><br><span class="line">userId, <span class="keyword">false</span>, ALLOW_FULL_ONLY, <span class="string">"startActivity"</span>, <span class="keyword">null</span>);</span><br><span class="line"><span class="comment">// <span class="doctag">TODO:</span> Switch to user app stacks here.</span></span><br><span class="line"><span class="keyword">return</span> mActivityStarter.startActivityMayWait(caller, -<span class="number">1</span>, callingPackage, intent,</span><br><span class="line">resolvedType, <span class="keyword">null</span>, <span class="keyword">null</span>, resultTo, resultWho, requestCode, startFlags,</span><br><span class="line">profilerInfo, <span class="keyword">null</span>, <span class="keyword">null</span>, bOptions, <span class="keyword">false</span>, userId, <span class="keyword">null</span>, <span class="keyword">null</span>,</span><br><span class="line"><span class="string">"startActivityAsUser"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后调用到了ActivityStarter的startActivityMayWait方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityMayWait</span><span class="params">(IApplicationThread caller, <span class="keyword">int</span> callingUid,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">669</span>            String callingPackage, Intent intent, String resolvedType,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">670</span>            IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">671</span>            IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> startFlags,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">672</span>            ProfilerInfo profilerInfo, WaitResult outResult,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">673</span>            Configuration globalConfig, Bundle bOptions, <span class="keyword">boolean</span> ignoreTargetSecurity, <span class="keyword">int</span> userId,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">674</span>            IActivityContainer iContainer, TaskRecord inTask, String reason)</span> </span>&#123;</span><br><span class="line"><span class="number">675</span>        <span class="comment">// Refuse possible leaked file descriptors</span></span><br><span class="line"><span class="number">676</span>        <span class="keyword">if</span> (intent != <span class="keyword">null</span> &amp;&amp; intent.hasFileDescriptors()) &#123;</span><br><span class="line"><span class="number">677</span>            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"File descriptors passed in Intent"</span>);</span><br><span class="line"><span class="number">678</span>        &#125;</span><br><span class="line"><span class="number">679</span>        mSupervisor.mActivityMetricsLogger.notifyActivityLaunching();</span><br><span class="line"><span class="number">680</span>        <span class="keyword">boolean</span> componentSpecified = intent.getComponent() != <span class="keyword">null</span>;</span><br><span class="line"><span class="number">681</span></span><br><span class="line"><span class="number">682</span>        <span class="comment">// Save a copy in case ephemeral needs it</span></span><br><span class="line"><span class="number">683</span>        <span class="keyword">final</span> Intent ephemeralIntent = <span class="keyword">new</span> Intent(intent);</span><br><span class="line"><span class="number">684</span>        <span class="comment">// Don't modify the client's object!</span></span><br><span class="line"><span class="number">685</span>        intent = <span class="keyword">new</span> Intent(intent);</span><br><span class="line"><span class="number">686</span>        <span class="keyword">if</span> (componentSpecified</span><br><span class="line"><span class="number">687</span>                &amp;&amp; intent.getData() != <span class="keyword">null</span></span><br><span class="line"><span class="number">688</span>                &amp;&amp; Intent.ACTION_VIEW.equals(intent.getAction())</span><br><span class="line"><span class="number">689</span>                &amp;&amp; mService.getPackageManagerInternalLocked()</span><br><span class="line"><span class="number">690</span>                        .isInstantAppInstallerComponent(intent.getComponent())) &#123;</span><br><span class="line"><span class="number">691</span>            <span class="comment">// intercept intents targeted directly to the ephemeral installer the</span></span><br><span class="line"><span class="number">692</span>            <span class="comment">// ephemeral installer should never be started with a raw URL; instead</span></span><br><span class="line"><span class="number">693</span>            <span class="comment">// adjust the intent so it looks like a "normal" instant app launch</span></span><br><span class="line"><span class="number">694</span>            intent.setComponent(<span class="keyword">null</span> <span class="comment">/*component*/</span>);</span><br><span class="line"><span class="number">695</span>            componentSpecified = <span class="keyword">false</span>;</span><br><span class="line"><span class="number">696</span>        &#125;</span><br><span class="line"><span class="number">697</span></span><br><span class="line"><span class="number">698</span>        ResolveInfo rInfo = mSupervisor.resolveIntent(intent, resolvedType, userId);</span><br><span class="line"><span class="number">699</span>        <span class="keyword">if</span> (rInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">700</span>            UserInfo userInfo = mSupervisor.getUserInfo(userId);</span><br><span class="line"><span class="number">701</span>            <span class="keyword">if</span> (userInfo != <span class="keyword">null</span> &amp;&amp; userInfo.isManagedProfile()) &#123;</span><br><span class="line"><span class="number">702</span>                <span class="comment">// Special case for managed profiles, if attempting to launch non-cryto aware</span></span><br><span class="line"><span class="number">703</span>                <span class="comment">// app in a locked managed profile from an unlocked parent allow it to resolve</span></span><br><span class="line"><span class="number">704</span>                <span class="comment">// as user will be sent via confirm credentials to unlock the profile.</span></span><br><span class="line"><span class="number">705</span>                UserManager userManager = UserManager.get(mService.mContext);</span><br><span class="line"><span class="number">706</span>                <span class="keyword">boolean</span> profileLockedAndParentUnlockingOrUnlocked = <span class="keyword">false</span>;</span><br><span class="line"><span class="number">707</span>                <span class="keyword">long</span> token = Binder.clearCallingIdentity();</span><br><span class="line"><span class="number">708</span>                <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="number">709</span>                    UserInfo parent = userManager.getProfileParent(userId);</span><br><span class="line"><span class="number">710</span>                    profileLockedAndParentUnlockingOrUnlocked = (parent != <span class="keyword">null</span>)</span><br><span class="line"><span class="number">711</span>                            &amp;&amp; userManager.isUserUnlockingOrUnlocked(parent.id)</span><br><span class="line"><span class="number">712</span>                            &amp;&amp; !userManager.isUserUnlockingOrUnlocked(userId);</span><br><span class="line"><span class="number">713</span>                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line"><span class="number">714</span>                    Binder.restoreCallingIdentity(token);</span><br><span class="line"><span class="number">715</span>                &#125;</span><br><span class="line"><span class="number">716</span>                <span class="keyword">if</span> (profileLockedAndParentUnlockingOrUnlocked) &#123;</span><br><span class="line"><span class="number">717</span>                    rInfo = mSupervisor.resolveIntent(intent, resolvedType, userId,</span><br><span class="line"><span class="number">718</span>                            PackageManager.MATCH_DIRECT_BOOT_AWARE</span><br><span class="line"><span class="number">719</span>                                    | PackageManager.MATCH_DIRECT_BOOT_UNAWARE);</span><br><span class="line"><span class="number">720</span>                &#125;</span><br><span class="line"><span class="number">721</span>            &#125;</span><br><span class="line"><span class="number">722</span>        &#125;</span><br><span class="line"><span class="number">723</span>        <span class="comment">// Collect information about the target of the Intent.</span></span><br><span class="line"><span class="number">724</span>        ActivityInfo aInfo = mSupervisor.resolveActivity(intent, rInfo, startFlags, profilerInfo);</span><br><span class="line"><span class="number">725</span></span><br><span class="line"><span class="number">726</span>        ActivityOptions options = ActivityOptions.fromBundle(bOptions);</span><br><span class="line"><span class="number">727</span>        ActivityStackSupervisor.ActivityContainer container =</span><br><span class="line"><span class="number">728</span>                (ActivityStackSupervisor.ActivityContainer)iContainer;</span><br><span class="line"><span class="number">729</span>        <span class="keyword">synchronized</span> (mService) &#123;</span><br><span class="line"><span class="number">730</span>            <span class="keyword">if</span> (container != <span class="keyword">null</span> &amp;&amp; container.mParentActivity != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line"><span class="number">731</span>                    container.mParentActivity.state != RESUMED) &#123;</span><br><span class="line"><span class="number">732</span>                <span class="comment">// Cannot start a child activity if the parent is not resumed.</span></span><br><span class="line"><span class="number">733</span>                <span class="keyword">return</span> ActivityManager.START_CANCELED;</span><br><span class="line"><span class="number">734</span>            &#125;</span><br><span class="line"><span class="number">735</span>            <span class="keyword">final</span> <span class="keyword">int</span> realCallingPid = Binder.getCallingPid();</span><br><span class="line"><span class="number">736</span>            <span class="keyword">final</span> <span class="keyword">int</span> realCallingUid = Binder.getCallingUid();</span><br><span class="line"><span class="number">737</span>            <span class="keyword">int</span> callingPid;</span><br><span class="line"><span class="number">738</span>            <span class="keyword">if</span> (callingUid &gt;= <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">739</span>                callingPid = -<span class="number">1</span>;</span><br><span class="line"><span class="number">740</span>            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (caller == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">741</span>                callingPid = realCallingPid;</span><br><span class="line"><span class="number">742</span>                callingUid = realCallingUid;</span><br><span class="line"><span class="number">743</span>            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="number">744</span>                callingPid = callingUid = -<span class="number">1</span>;</span><br><span class="line"><span class="number">745</span>            &#125;</span><br><span class="line"><span class="number">746</span></span><br><span class="line"><span class="number">747</span>            <span class="keyword">final</span> ActivityStack stack;</span><br><span class="line"><span class="number">748</span>            <span class="keyword">if</span> (container == <span class="keyword">null</span> || container.mStack.isOnHomeDisplay()) &#123;</span><br><span class="line"><span class="number">749</span>                stack = mSupervisor.mFocusedStack;</span><br><span class="line"><span class="number">750</span>            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="number">751</span>                stack = container.mStack;</span><br><span class="line"><span class="number">752</span>            &#125;</span><br><span class="line"><span class="number">753</span>            stack.mConfigWillChange = globalConfig != <span class="keyword">null</span></span><br><span class="line"><span class="number">754</span>                    &amp;&amp; mService.getGlobalConfiguration().diff(globalConfig) != <span class="number">0</span>;</span><br><span class="line"><span class="number">755</span>            <span class="keyword">if</span> (DEBUG_CONFIGURATION) Slog.v(TAG_CONFIGURATION,</span><br><span class="line"><span class="number">756</span>                    <span class="string">"Starting activity when config will change = "</span> + stack.mConfigWillChange);</span><br><span class="line"><span class="number">757</span></span><br><span class="line"><span class="number">758</span>            <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</span><br><span class="line"><span class="number">759</span></span><br><span class="line"><span class="number">760</span>            <span class="keyword">if</span> (aInfo != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line"><span class="number">761</span>                    (aInfo.applicationInfo.privateFlags</span><br><span class="line"><span class="number">762</span>                            &amp; ApplicationInfo.PRIVATE_FLAG_CANT_SAVE_STATE) != <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">763</span>                <span class="comment">// This may be a heavy-weight process!  Check to see if we already</span></span><br><span class="line"><span class="number">764</span>                <span class="comment">// have another, different heavy-weight process running.</span></span><br><span class="line"><span class="number">765</span>                <span class="keyword">if</span> (aInfo.processName.equals(aInfo.applicationInfo.packageName)) &#123;</span><br><span class="line"><span class="number">766</span>                    <span class="keyword">final</span> ProcessRecord heavy = mService.mHeavyWeightProcess;</span><br><span class="line"><span class="number">767</span>                    <span class="keyword">if</span> (heavy != <span class="keyword">null</span> &amp;&amp; (heavy.info.uid != aInfo.applicationInfo.uid</span><br><span class="line"><span class="number">768</span>                            || !heavy.processName.equals(aInfo.processName))) &#123;</span><br><span class="line"><span class="number">769</span>                        <span class="keyword">int</span> appCallingUid = callingUid;</span><br><span class="line"><span class="number">770</span>                        <span class="keyword">if</span> (caller != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">771</span>                            ProcessRecord callerApp = mService.getRecordForAppLocked(caller);</span><br><span class="line"><span class="number">772</span>                            <span class="keyword">if</span> (callerApp != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">773</span>                                appCallingUid = callerApp.info.uid;</span><br><span class="line"><span class="number">774</span>                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="number">775</span>                                Slog.w(TAG, <span class="string">"Unable to find app for caller "</span> + caller</span><br><span class="line"><span class="number">776</span>                                        + <span class="string">" (pid="</span> + callingPid + <span class="string">") when starting: "</span></span><br><span class="line"><span class="number">777</span>                                        + intent.toString());</span><br><span class="line"><span class="number">778</span>                                ActivityOptions.abort(options);</span><br><span class="line"><span class="number">779</span>                                <span class="keyword">return</span> ActivityManager.START_PERMISSION_DENIED;</span><br><span class="line"><span class="number">780</span>                            &#125;</span><br><span class="line"><span class="number">781</span>                        &#125;</span><br><span class="line"><span class="number">782</span></span><br><span class="line"><span class="number">783</span>                        IIntentSender target = mService.getIntentSenderLocked(</span><br><span class="line"><span class="number">784</span>                                ActivityManager.INTENT_SENDER_ACTIVITY, <span class="string">"android"</span>,</span><br><span class="line"><span class="number">785</span>                                appCallingUid, userId, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="number">0</span>, <span class="keyword">new</span> Intent[] &#123; intent &#125;,</span><br><span class="line"><span class="number">786</span>                                <span class="keyword">new</span> String[] &#123; resolvedType &#125;, PendingIntent.FLAG_CANCEL_CURRENT</span><br><span class="line"><span class="number">787</span>                                        | PendingIntent.FLAG_ONE_SHOT, <span class="keyword">null</span>);</span><br><span class="line"><span class="number">788</span></span><br><span class="line"><span class="number">789</span>                        Intent newIntent = <span class="keyword">new</span> Intent();</span><br><span class="line"><span class="number">790</span>                        <span class="keyword">if</span> (requestCode &gt;= <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">791</span>                            <span class="comment">// Caller is requesting a result.</span></span><br><span class="line"><span class="number">792</span>                            newIntent.putExtra(HeavyWeightSwitcherActivity.KEY_HAS_RESULT, <span class="keyword">true</span>);</span><br><span class="line"><span class="number">793</span>                        &#125;</span><br><span class="line"><span class="number">794</span>                        newIntent.putExtra(HeavyWeightSwitcherActivity.KEY_INTENT,</span><br><span class="line"><span class="number">795</span>                                <span class="keyword">new</span> IntentSender(target));</span><br><span class="line"><span class="number">796</span>                        <span class="keyword">if</span> (heavy.activities.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">797</span>                            ActivityRecord hist = heavy.activities.get(<span class="number">0</span>);</span><br><span class="line"><span class="number">798</span>                            newIntent.putExtra(HeavyWeightSwitcherActivity.KEY_CUR_APP,</span><br><span class="line"><span class="number">799</span>                                    hist.packageName);</span><br><span class="line"><span class="number">800</span>                            newIntent.putExtra(HeavyWeightSwitcherActivity.KEY_CUR_TASK,</span><br><span class="line"><span class="number">801</span>                                    hist.getTask().taskId);</span><br><span class="line"><span class="number">802</span>                        &#125;</span><br><span class="line"><span class="number">803</span>                        newIntent.putExtra(HeavyWeightSwitcherActivity.KEY_NEW_APP,</span><br><span class="line"><span class="number">804</span>                                aInfo.packageName);</span><br><span class="line"><span class="number">805</span>                        newIntent.setFlags(intent.getFlags());</span><br><span class="line"><span class="number">806</span>                        newIntent.setClassName(<span class="string">"android"</span>,</span><br><span class="line"><span class="number">807</span>                                HeavyWeightSwitcherActivity.class.getName());</span><br><span class="line"><span class="number">808</span>                        intent = newIntent;</span><br><span class="line"><span class="number">809</span>                        resolvedType = <span class="keyword">null</span>;</span><br><span class="line"><span class="number">810</span>                        caller = <span class="keyword">null</span>;</span><br><span class="line"><span class="number">811</span>                        callingUid = Binder.getCallingUid();</span><br><span class="line"><span class="number">812</span>                        callingPid = Binder.getCallingPid();</span><br><span class="line"><span class="number">813</span>                        componentSpecified = <span class="keyword">true</span>;</span><br><span class="line"><span class="number">814</span>                        rInfo = mSupervisor.resolveIntent(intent, <span class="keyword">null</span> <span class="comment">/*resolvedType*/</span>, userId);</span><br><span class="line"><span class="number">815</span>                        aInfo = rInfo != <span class="keyword">null</span> ? rInfo.activityInfo : <span class="keyword">null</span>;</span><br><span class="line"><span class="number">816</span>                        <span class="keyword">if</span> (aInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">817</span>                            aInfo = mService.getActivityInfoForUser(aInfo, userId);</span><br><span class="line"><span class="number">818</span>                        &#125;</span><br><span class="line"><span class="number">819</span>                    &#125;</span><br><span class="line"><span class="number">820</span>                &#125;</span><br><span class="line"><span class="number">821</span>            &#125;</span><br><span class="line"><span class="number">822</span></span><br><span class="line"><span class="number">823</span>            <span class="keyword">final</span> ActivityRecord[] outRecord = <span class="keyword">new</span> ActivityRecord[<span class="number">1</span>];</span><br><span class="line"><span class="number">824</span>            <span class="keyword">int</span> res = startActivityLocked(caller, intent, ephemeralIntent, resolvedType,</span><br><span class="line"><span class="number">825</span>                    aInfo, rInfo, voiceSession, voiceInteractor,</span><br><span class="line"><span class="number">826</span>                    resultTo, resultWho, requestCode, callingPid,</span><br><span class="line"><span class="number">827</span>                    callingUid, callingPackage, realCallingPid, realCallingUid, startFlags,</span><br><span class="line"><span class="number">828</span>                    options, ignoreTargetSecurity, componentSpecified, outRecord, container,</span><br><span class="line"><span class="number">829</span>                    inTask, reason);</span><br><span class="line"><span class="number">830</span></span><br><span class="line"><span class="number">831</span>            Binder.restoreCallingIdentity(origId);</span><br><span class="line"><span class="number">832</span></span><br><span class="line"><span class="number">833</span>            <span class="keyword">if</span> (stack.mConfigWillChange) &#123;</span><br><span class="line"><span class="number">834</span>                <span class="comment">// If the caller also wants to switch to a new configuration,</span></span><br><span class="line"><span class="number">835</span>                <span class="comment">// do so now.  This allows a clean switch, as we are waiting</span></span><br><span class="line"><span class="number">836</span>                <span class="comment">// for the current activity to pause (so we will not destroy</span></span><br><span class="line"><span class="number">837</span>                <span class="comment">// it), and have not yet started the next activity.</span></span><br><span class="line"><span class="number">838</span>                mService.enforceCallingPermission(android.Manifest.permission.CHANGE_CONFIGURATION,</span><br><span class="line"><span class="number">839</span>                        <span class="string">"updateConfiguration()"</span>);</span><br><span class="line"><span class="number">840</span>                stack.mConfigWillChange = <span class="keyword">false</span>;</span><br><span class="line"><span class="number">841</span>                <span class="keyword">if</span> (DEBUG_CONFIGURATION) Slog.v(TAG_CONFIGURATION,</span><br><span class="line"><span class="number">842</span>                        <span class="string">"Updating to new configuration after starting activity."</span>);</span><br><span class="line"><span class="number">843</span>                mService.updateConfigurationLocked(globalConfig, <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line"><span class="number">844</span>            &#125;</span><br><span class="line"><span class="number">845</span></span><br><span class="line"><span class="number">846</span>            <span class="keyword">if</span> (outResult != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">847</span>                outResult.result = res;</span><br><span class="line"><span class="number">848</span>                <span class="keyword">if</span> (res == ActivityManager.START_SUCCESS) &#123;</span><br><span class="line"><span class="number">849</span>                    mSupervisor.mWaitingActivityLaunched.add(outResult);</span><br><span class="line"><span class="number">850</span>                    <span class="keyword">do</span> &#123;</span><br><span class="line"><span class="number">851</span>                        <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="number">852</span>                            mService.wait();</span><br><span class="line"><span class="number">853</span>                        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line"><span class="number">854</span>                        &#125;</span><br><span class="line"><span class="number">855</span>                    &#125; <span class="keyword">while</span> (outResult.result != START_TASK_TO_FRONT</span><br><span class="line"><span class="number">856</span>                            &amp;&amp; !outResult.timeout &amp;&amp; outResult.who == <span class="keyword">null</span>);</span><br><span class="line"><span class="number">857</span>                    <span class="keyword">if</span> (outResult.result == START_TASK_TO_FRONT) &#123;</span><br><span class="line"><span class="number">858</span>                        res = START_TASK_TO_FRONT;</span><br><span class="line"><span class="number">859</span>                    &#125;</span><br><span class="line"><span class="number">860</span>                &#125;</span><br><span class="line"><span class="number">861</span>                <span class="keyword">if</span> (res == START_TASK_TO_FRONT) &#123;</span><br><span class="line"><span class="number">862</span>                    <span class="keyword">final</span> ActivityRecord r = outRecord[<span class="number">0</span>];</span><br><span class="line"><span class="number">863</span></span><br><span class="line"><span class="number">864</span>                    <span class="comment">// ActivityRecord may represent a different activity, but it should not be in</span></span><br><span class="line"><span class="number">865</span>                    <span class="comment">// the resumed state.</span></span><br><span class="line"><span class="number">866</span>                    <span class="keyword">if</span> (r.nowVisible &amp;&amp; r.state == RESUMED) &#123;</span><br><span class="line"><span class="number">867</span>                        outResult.timeout = <span class="keyword">false</span>;</span><br><span class="line"><span class="number">868</span>                        outResult.who = r.realActivity;</span><br><span class="line"><span class="number">869</span>                        outResult.totalTime = <span class="number">0</span>;</span><br><span class="line"><span class="number">870</span>                        outResult.thisTime = <span class="number">0</span>;</span><br><span class="line"><span class="number">871</span>                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="number">872</span>                        outResult.thisTime = SystemClock.uptimeMillis();</span><br><span class="line"><span class="number">873</span>                        mSupervisor.waitActivityVisible(r.realActivity, outResult);</span><br><span class="line"><span class="number">874</span>                        <span class="comment">// Note: the timeout variable is not currently not ever set.</span></span><br><span class="line"><span class="number">875</span>                        <span class="keyword">do</span> &#123;</span><br><span class="line"><span class="number">876</span>                            <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="number">877</span>                                mService.wait();</span><br><span class="line"><span class="number">878</span>                            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line"><span class="number">879</span>                            &#125;</span><br><span class="line"><span class="number">880</span>                        &#125; <span class="keyword">while</span> (!outResult.timeout &amp;&amp; outResult.who == <span class="keyword">null</span>);</span><br><span class="line"><span class="number">881</span>                    &#125;</span><br><span class="line"><span class="number">882</span>                &#125;</span><br><span class="line"><span class="number">883</span>            &#125;</span><br><span class="line"><span class="number">884</span></span><br><span class="line"><span class="number">885</span>            mSupervisor.mActivityMetricsLogger.notifyActivityLaunched(res, outRecord[<span class="number">0</span>]);</span><br><span class="line"><span class="number">886</span>            <span class="keyword">return</span> res;</span><br><span class="line"><span class="number">887</span>        &#125;</span><br><span class="line"><span class="number">888</span>    &#125;</span><br></pre></td></tr></table></figure></p>
<p>然后调用startActivityLocked<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">startActivityLocked</span><span class="params">(IApplicationThread caller, Intent intent, Intent ephemeralIntent,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">257</span>            String resolvedType, ActivityInfo aInfo, ResolveInfo rInfo,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">258</span>            IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">259</span>            IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> callingPid, <span class="keyword">int</span> callingUid,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">260</span>            String callingPackage, <span class="keyword">int</span> realCallingPid, <span class="keyword">int</span> realCallingUid, <span class="keyword">int</span> startFlags,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">261</span>            ActivityOptions options, <span class="keyword">boolean</span> ignoreTargetSecurity, <span class="keyword">boolean</span> componentSpecified,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">262</span>            ActivityRecord[] outActivity, ActivityStackSupervisor.ActivityContainer container,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">263</span>            TaskRecord inTask, String reason)</span> </span>&#123;</span><br><span class="line"><span class="number">264</span></span><br><span class="line"><span class="number">265</span>        <span class="keyword">if</span> (TextUtils.isEmpty(reason)) &#123;</span><br><span class="line"><span class="number">266</span>            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Need to specify a reason."</span>);</span><br><span class="line"><span class="number">267</span>        &#125;</span><br><span class="line"><span class="number">268</span>        mLastStartReason = reason;</span><br><span class="line"><span class="number">269</span>        mLastStartActivityTimeMs = System.currentTimeMillis();</span><br><span class="line"><span class="number">270</span>        mLastStartActivityRecord[<span class="number">0</span>] = <span class="keyword">null</span>;</span><br><span class="line"><span class="number">271</span></span><br><span class="line"><span class="number">272</span>        mLastStartActivityResult = startActivity(caller, intent, ephemeralIntent, resolvedType,</span><br><span class="line"><span class="number">273</span>                aInfo, rInfo, voiceSession, voiceInteractor, resultTo, resultWho, requestCode,</span><br><span class="line"><span class="number">274</span>                callingPid, callingUid, callingPackage, realCallingPid, realCallingUid, startFlags,</span><br><span class="line"><span class="number">275</span>                options, ignoreTargetSecurity, componentSpecified, mLastStartActivityRecord,</span><br><span class="line"><span class="number">276</span>                container, inTask);</span><br><span class="line"><span class="number">277</span></span><br><span class="line"><span class="number">278</span>        <span class="keyword">if</span> (outActivity != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">279</span>            <span class="comment">// mLastStartActivityRecord[0] is set in the call to startActivity above.</span></span><br><span class="line"><span class="number">280</span>            outActivity[<span class="number">0</span>] = mLastStartActivityRecord[<span class="number">0</span>];</span><br><span class="line"><span class="number">281</span>        &#125;</span><br><span class="line"><span class="number">282</span>        <span class="keyword">return</span> mLastStartActivityResult;</span><br><span class="line"><span class="number">283</span>    &#125;</span><br></pre></td></tr></table></figure></p>
<p>然后调用 startActivity<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(<span class="keyword">final</span> ActivityRecord r, ActivityRecord sourceRecord,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">996</span>            IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">997</span>            <span class="keyword">int</span> startFlags, <span class="keyword">boolean</span> doResume, ActivityOptions options, TaskRecord inTask,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">998</span>            ActivityRecord[] outActivity)</span> </span>&#123;</span><br><span class="line"><span class="number">999</span>        <span class="keyword">int</span> result = START_CANCELED;</span><br><span class="line"><span class="number">1000</span>        <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="number">1001</span>            mService.mWindowManager.deferSurfaceLayout();</span><br><span class="line"><span class="number">1002</span>            result = startActivityUnchecked(r, sourceRecord, voiceSession, voiceInteractor,</span><br><span class="line"><span class="number">1003</span>                    startFlags, doResume, options, inTask, outActivity);</span><br><span class="line"><span class="number">1004</span>        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line"><span class="number">1005</span>            <span class="comment">// If we are not able to proceed, disassociate the activity from the task. Leaving an</span></span><br><span class="line"><span class="number">1006</span>            <span class="comment">// activity in an incomplete state can lead to issues, such as performing operations</span></span><br><span class="line"><span class="number">1007</span>            <span class="comment">// without a window container.</span></span><br><span class="line"><span class="number">1008</span>            <span class="keyword">if</span> (!ActivityManager.isStartResultSuccessful(result)</span><br><span class="line"><span class="number">1009</span>                    &amp;&amp; mStartActivity.getTask() != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">1010</span>                mStartActivity.getTask().removeActivity(mStartActivity);</span><br><span class="line"><span class="number">1011</span>            &#125;</span><br><span class="line"><span class="number">1012</span>            mService.mWindowManager.continueSurfaceLayout();</span><br><span class="line"><span class="number">1013</span>        &#125;</span><br><span class="line"><span class="number">1014</span></span><br><span class="line"><span class="number">1015</span>        postStartActivityProcessing(r, result, mSupervisor.getLastStack().mStackId,  mSourceRecord,</span><br><span class="line"><span class="number">1016</span>                mTargetStack);</span><br><span class="line"><span class="number">1017</span></span><br><span class="line"><span class="number">1018</span>        <span class="keyword">return</span> result;</span><br><span class="line"><span class="number">1019</span>    &#125;</span><br></pre></td></tr></table></figure></p>
<p>其中又调用了<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">result = startActivityUnchecked(r, sourceRecord, voiceSession, voiceInteractor,</span><br><span class="line"><span class="number">1003</span>                    startFlags, doResume, options, inTask, outActivity);</span><br></pre></td></tr></table></figure></p>
<p>最后调用到<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (mDoResume) &#123;</span><br><span class="line"><span class="number">1159</span>                mSupervisor.resumeFocusedStackTopActivityLocked();</span><br><span class="line"><span class="number">1160</span>            &#125;</span><br></pre></td></tr></table></figure></p>
<p>查看这个方法，最后发现其中调用了<br>mFocusedStack.resumeTopActivityUncheckedLocked(null, null);</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">boolean resumeFocusedStackTopActivityLocked(</span><br><span class="line">2060            ActivityStack targetStack, ActivityRecord target, ActivityOptions targetOptions) &#123;</span><br><span class="line">2061        if (targetStack != null &amp;&amp; isFocusedStack(targetStack)) &#123;</span><br><span class="line">2062            return targetStack.resumeTopActivityUncheckedLocked(target, targetOptions);</span><br><span class="line">2063        &#125;</span><br><span class="line">2064        final ActivityRecord r = mFocusedStack.topRunningActivityLocked();</span><br><span class="line">2065        if (r == null || r.state != RESUMED) &#123;</span><br><span class="line">2066            mFocusedStack.resumeTopActivityUncheckedLocked(null, null);</span><br><span class="line">2067        &#125; else if (r.state == RESUMED) &#123;</span><br><span class="line">2068            // Kick off any lingering app transitions form the MoveTaskToFront operation.</span><br><span class="line">2069            mFocusedStack.executeAppTransition(targetOptions);</span><br><span class="line">2070        &#125;</span><br><span class="line">2071        return false;</span><br><span class="line">2072    &#125;</span><br></pre></td></tr></table></figure>
<p>查看其中的方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">resumeTopActivityUncheckedLocked</span><span class="params">(ActivityRecord prev, ActivityOptions options)</span> </span>&#123;</span><br><span class="line"><span class="number">2206</span>        <span class="keyword">if</span> (mStackSupervisor.inResumeTopActivity) &#123;</span><br><span class="line"><span class="number">2207</span>            <span class="comment">// Don't even start recursing.</span></span><br><span class="line"><span class="number">2208</span>            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"><span class="number">2209</span>        &#125;</span><br><span class="line"><span class="number">2210</span></span><br><span class="line"><span class="number">2211</span>        <span class="keyword">boolean</span> result = <span class="keyword">false</span>;</span><br><span class="line"><span class="number">2212</span>        <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="number">2213</span>            <span class="comment">// Protect against recursion.</span></span><br><span class="line"><span class="number">2214</span>            mStackSupervisor.inResumeTopActivity = <span class="keyword">true</span>;</span><br><span class="line"><span class="number">2215</span>            result = resumeTopActivityInnerLocked(prev, options);</span><br><span class="line"><span class="number">2216</span>        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line"><span class="number">2217</span>            mStackSupervisor.inResumeTopActivity = <span class="keyword">false</span>;</span><br><span class="line"><span class="number">2218</span>        &#125;</span><br><span class="line"><span class="number">2219</span>        <span class="comment">// When resuming the top activity, it may be necessary to pause the top activity (for</span></span><br><span class="line"><span class="number">2220</span>        <span class="comment">// example, returning to the lock screen. We suppress the normal pause logic in</span></span><br><span class="line"><span class="number">2221</span>        <span class="comment">// &#123;@link #resumeTopActivityUncheckedLocked&#125;, since the top activity is resumed at the end.</span></span><br><span class="line"><span class="number">2222</span>        <span class="comment">// We call the &#123;@link ActivityStackSupervisor#checkReadyForSleepLocked&#125; again here to ensure</span></span><br><span class="line"><span class="number">2223</span>        <span class="comment">// any necessary pause logic occurs.</span></span><br><span class="line"><span class="number">2224</span>        mStackSupervisor.checkReadyForSleepLocked();</span><br><span class="line"><span class="number">2225</span></span><br><span class="line"><span class="number">2226</span>        <span class="keyword">return</span> result;</span><br><span class="line"><span class="number">2227</span>    &#125;</span><br></pre></td></tr></table></figure></p>
<p>继续跟mStackSupervisor.checkReadyForSleepLocked();<br>发现其中调用了 startPausingLocked(false, true, null, false);<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">checkReadyForSleepLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="number">1173</span>        <span class="keyword">if</span> (mResumedActivity != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">1174</span>            <span class="comment">// Still have something resumed; can't sleep until it is paused.</span></span><br><span class="line"><span class="number">1175</span>            <span class="keyword">if</span> (DEBUG_PAUSE) Slog.v(TAG_PAUSE, <span class="string">"Sleep needs to pause "</span> + mResumedActivity);</span><br><span class="line"><span class="number">1176</span>            <span class="keyword">if</span> (DEBUG_USER_LEAVING) Slog.v(TAG_USER_LEAVING,</span><br><span class="line"><span class="number">1177</span>                    <span class="string">"Sleep =&gt; pause with userLeaving=false"</span>);</span><br><span class="line"><span class="number">1178</span></span><br><span class="line"><span class="number">1179</span>            <span class="comment">// If we are in the middle of resuming the top activity in</span></span><br><span class="line"><span class="number">1180</span>            <span class="comment">// &#123;@link #resumeTopActivityUncheckedLocked&#125;, mResumedActivity will be set but not</span></span><br><span class="line"><span class="number">1181</span>            <span class="comment">// resumed yet. We must not proceed pausing the activity here. This method will be</span></span><br><span class="line"><span class="number">1182</span>            <span class="comment">// called again if necessary as part of</span></span><br><span class="line"><span class="number">1183</span>            <span class="comment">// &#123;@link ActivityStackSupervisor#checkReadyForSleepLocked&#125;.</span></span><br><span class="line"><span class="number">1184</span>            <span class="keyword">if</span> (mStackSupervisor.inResumeTopActivity) &#123;</span><br><span class="line"><span class="number">1185</span>                <span class="keyword">if</span> (DEBUG_PAUSE) Slog.v(TAG_PAUSE, <span class="string">"In the middle of resuming top activity "</span></span><br><span class="line"><span class="number">1186</span>                        + mResumedActivity);</span><br><span class="line"><span class="number">1187</span>                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"><span class="number">1188</span>            &#125;</span><br><span class="line"><span class="number">1189</span></span><br><span class="line"><span class="number">1190</span>            startPausingLocked(<span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line"><span class="number">1191</span>            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"><span class="number">1192</span>        &#125;</span><br><span class="line"><span class="number">1193</span>        <span class="keyword">if</span> (mPausingActivity != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">1194</span>            <span class="comment">// Still waiting for something to pause; can't sleep yet.</span></span><br><span class="line"><span class="number">1195</span>            <span class="keyword">if</span> (DEBUG_PAUSE) Slog.v(TAG_PAUSE, <span class="string">"Sleep still waiting to pause "</span> + mPausingActivity);</span><br><span class="line"><span class="number">1196</span>            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"><span class="number">1197</span>        &#125;</span><br><span class="line"><span class="number">1198</span></span><br><span class="line"><span class="number">1199</span>        <span class="keyword">if</span> (hasVisibleBehindActivity()) &#123;</span><br><span class="line"><span class="number">1200</span>            <span class="comment">// Stop visible behind activity before going to sleep.</span></span><br><span class="line"><span class="number">1201</span>            <span class="keyword">final</span> ActivityRecord r = getVisibleBehindActivity();</span><br><span class="line"><span class="number">1202</span>            mStackSupervisor.mStoppingActivities.add(r);</span><br><span class="line"><span class="number">1203</span>            <span class="keyword">if</span> (DEBUG_STATES) Slog.v(TAG_STATES, <span class="string">"Sleep still waiting to stop visible behind "</span> + r);</span><br><span class="line"><span class="number">1204</span>            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"><span class="number">1205</span>        &#125;</span><br><span class="line"><span class="number">1206</span></span><br><span class="line"><span class="number">1207</span>        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"><span class="number">1208</span>    &#125;</span><br></pre></td></tr></table></figure></p>
<p>然后去 startPausingLocked(false, true, null, false)中看：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line">final boolean startPausingLocked(boolean userLeaving, boolean uiSleeping,</span><br><span class="line">1255            ActivityRecord resuming, boolean pauseImmediately) &#123;</span><br><span class="line">1256        if (mPausingActivity != null) &#123;</span><br><span class="line">1257            Slog.wtf(TAG, &quot;Going to pause when pause is already pending for &quot; + mPausingActivity</span><br><span class="line">1258                    + &quot; state=&quot; + mPausingActivity.state);</span><br><span class="line">1259            if (!mService.isSleepingLocked()) &#123;</span><br><span class="line">1260                // Avoid recursion among check for sleep and complete pause during sleeping.</span><br><span class="line">1261                // Because activity will be paused immediately after resume, just let pause</span><br><span class="line">1262                // be completed by the order of activity paused from clients.</span><br><span class="line">1263                completePauseLocked(false, resuming);</span><br><span class="line">1264            &#125;</span><br><span class="line">1265        &#125;</span><br><span class="line">1266        ActivityRecord prev = mResumedActivity;</span><br><span class="line">1267</span><br><span class="line">1268        if (prev == null) &#123;</span><br><span class="line">1269            if (resuming == null) &#123;</span><br><span class="line">1270                Slog.wtf(TAG, &quot;Trying to pause when nothing is resumed&quot;);</span><br><span class="line">1271                mStackSupervisor.resumeFocusedStackTopActivityLocked();</span><br><span class="line">1272            &#125;</span><br><span class="line">1273            return false;</span><br><span class="line">1274        &#125;</span><br><span class="line">1275</span><br><span class="line">1276        if (mActivityContainer.mParentActivity == null) &#123;</span><br><span class="line">1277            // Top level stack, not a child. Look for child stacks.</span><br><span class="line">1278            mStackSupervisor.pauseChildStacks(prev, userLeaving, uiSleeping, resuming,</span><br><span class="line">1279                    pauseImmediately);</span><br><span class="line">1280        &#125;</span><br><span class="line">1281</span><br><span class="line">1282        if (DEBUG_STATES) Slog.v(TAG_STATES, &quot;Moving to PAUSING: &quot; + prev);</span><br><span class="line">1283        else if (DEBUG_PAUSE) Slog.v(TAG_PAUSE, &quot;Start pausing: &quot; + prev);</span><br><span class="line">1284        mResumedActivity = null;</span><br><span class="line">1285        mPausingActivity = prev;</span><br><span class="line">1286        mLastPausedActivity = prev;</span><br><span class="line">1287        mLastNoHistoryActivity = (prev.intent.getFlags() &amp; Intent.FLAG_ACTIVITY_NO_HISTORY) != 0</span><br><span class="line">1288                || (prev.info.flags &amp; ActivityInfo.FLAG_NO_HISTORY) != 0 ? prev : null;</span><br><span class="line">1289        prev.state = ActivityState.PAUSING;</span><br><span class="line">1290        prev.getTask().touchActiveTime();</span><br><span class="line">1291        clearLaunchTime(prev);</span><br><span class="line">1292        final ActivityRecord next = mStackSupervisor.topRunningActivityLocked();</span><br><span class="line">1293        if (mService.mHasRecents</span><br><span class="line">1294                &amp;&amp; (next == null || next.noDisplay || next.getTask() != prev.getTask()</span><br><span class="line">1295                || uiSleeping)) &#123;</span><br><span class="line">1296            prev.mUpdateTaskThumbnailWhenHidden = true;</span><br><span class="line">1297        &#125;</span><br><span class="line">1298        stopFullyDrawnTraceIfNeeded();</span><br><span class="line">1299</span><br><span class="line">1300        mService.updateCpuStats();</span><br><span class="line">1301</span><br><span class="line">1302        if (prev.app != null &amp;&amp; prev.app.thread != null) &#123;</span><br><span class="line">1303            if (DEBUG_PAUSE) Slog.v(TAG_PAUSE, &quot;Enqueueing pending pause: &quot; + prev);</span><br><span class="line">1304            try &#123;</span><br><span class="line">1305                EventLog.writeEvent(EventLogTags.AM_PAUSE_ACTIVITY,</span><br><span class="line">1306                        prev.userId, System.identityHashCode(prev),</span><br><span class="line">1307                        prev.shortComponentName);</span><br><span class="line">1308                mService.updateUsageStats(prev, false);</span><br><span class="line">1309                prev.app.thread.schedulePauseActivity(prev.appToken, prev.finishing,</span><br><span class="line">1310                        userLeaving, prev.configChangeFlags, pauseImmediately);</span><br><span class="line">1311            &#125; catch (Exception e) &#123;</span><br><span class="line">1312                // Ignore exception, if process died other code will cleanup.</span><br><span class="line">1313                Slog.w(TAG, &quot;Exception thrown during pause&quot;, e);</span><br><span class="line">1314                mPausingActivity = null;</span><br><span class="line">1315                mLastPausedActivity = null;</span><br><span class="line">1316                mLastNoHistoryActivity = null;</span><br><span class="line">1317            &#125;</span><br><span class="line">1318        &#125; else &#123;</span><br><span class="line">1319            mPausingActivity = null;</span><br><span class="line">1320            mLastPausedActivity = null;</span><br><span class="line">1321            mLastNoHistoryActivity = null;</span><br><span class="line">1322        &#125;</span><br><span class="line">1323</span><br><span class="line">1324        // If we are not going to sleep, we want to ensure the device is</span><br><span class="line">1325        // awake until the next activity is started.</span><br><span class="line">1326        if (!uiSleeping &amp;&amp; !mService.isSleepingOrShuttingDownLocked()) &#123;</span><br><span class="line">1327            mStackSupervisor.acquireLaunchWakelock();</span><br><span class="line">1328        &#125;</span><br><span class="line">1329</span><br><span class="line">1330        if (mPausingActivity != null) &#123;</span><br><span class="line">1331            // Have the window manager pause its key dispatching until the new</span><br><span class="line">1332            // activity has started.  If we&apos;re pausing the activity just because</span><br><span class="line">1333            // the screen is being turned off and the UI is sleeping, don&apos;t interrupt</span><br><span class="line">1334            // key dispatch; the same activity will pick it up again on wakeup.</span><br><span class="line">1335            if (!uiSleeping) &#123;</span><br><span class="line">1336                prev.pauseKeyDispatchingLocked();</span><br><span class="line">1337            &#125; else if (DEBUG_PAUSE) &#123;</span><br><span class="line">1338                 Slog.v(TAG_PAUSE, &quot;Key dispatch not paused for screen off&quot;);</span><br><span class="line">1339            &#125;</span><br><span class="line">1340</span><br><span class="line">1341            if (pauseImmediately) &#123;</span><br><span class="line">1342                // If the caller said they don&apos;t want to wait for the pause, then complete</span><br><span class="line">1343                // the pause now.</span><br><span class="line">1344                completePauseLocked(false, resuming);</span><br><span class="line">1345                return false;</span><br><span class="line">1346</span><br><span class="line">1347            &#125; else &#123;</span><br><span class="line">1348                schedulePauseTimeout(prev);</span><br><span class="line">1349                return true;</span><br><span class="line">1350            &#125;</span><br><span class="line">1351</span><br><span class="line">1352        &#125; else &#123;</span><br><span class="line">1353            // This activity failed to schedule the</span><br><span class="line">1354            // pause, so just treat it as being paused now.</span><br><span class="line">1355            if (DEBUG_PAUSE) Slog.v(TAG_PAUSE, &quot;Activity not running, resuming next.&quot;);</span><br><span class="line">1356            if (resuming == null) &#123;</span><br><span class="line">1357                mStackSupervisor.resumeFocusedStackTopActivityLocked();</span><br><span class="line">1358            &#125;</span><br><span class="line">1359            return false;</span><br><span class="line">1360        &#125;</span><br><span class="line">1361    &#125;</span><br></pre></td></tr></table></figure></p>
<p>这个方法就是让系统中的栈中的activity执行onPause犯法。<br>其中 prev.app.thread.schedulePauseActivity(prev.appToken, prev.finishing,userLeaving,prev.configChangeFlags,pauseImmediately);<br>这里的thread是一个IApplicationThread类型的对象，而在ActivityThread中也有一个ApplicationThread类，其继承了IApplicationTHread，并且都是Binder对象。<br>那么这里的IApplication是一个Binder的client端，而ActivityThread中的APplictionThread中的ApplicationThread中是的Binder对象的server端。所以这里的thrad。schedulePauseActivity实际上调用的就是ApplicationThread的SchedulePauseActivity方法。</p>
<p>回到AcitivityThread中：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">schedulePauseActivity</span><span class="params">(IBinder token, <span class="keyword">boolean</span> finished,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="keyword">boolean</span> userLeaving, <span class="keyword">int</span> configChanges, <span class="keyword">boolean</span> dontReport)</span> </span>&#123;</span><br><span class="line"><span class="keyword">int</span> seq = getLifecycleSeq();</span><br><span class="line"><span class="keyword">if</span> (DEBUG_ORDER) Slog.d(TAG, <span class="string">"pauseActivity "</span> + ActivityThread.<span class="keyword">this</span></span><br><span class="line">+ <span class="string">" operation received seq: "</span> + seq);</span><br><span class="line">sendMessage(</span><br><span class="line">finished ? H.PAUSE_ACTIVITY_FINISHING : H.PAUSE_ACTIVITY,</span><br><span class="line">token,</span><br><span class="line">(userLeaving ? USER_LEAVING : <span class="number">0</span>) | (dontReport ? DONT_REPORT : <span class="number">0</span>),</span><br><span class="line">configChanges,</span><br><span class="line">seq);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其中sendMessage是继承自Handler的H发送了PAUSE_ACTIVITY_FINISHING的msg<br>，于是去H中的handleMessage中找对应的方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> PAUSE_ACTIVITY_FINISHING: &#123;</span><br><span class="line">Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"activityPause"</span>);</span><br><span class="line">SomeArgs args = (SomeArgs) msg.obj;</span><br><span class="line">handlePauseActivity((IBinder) args.arg1, <span class="keyword">true</span>, (args.argi1 &amp; USER_LEAVING) != <span class="number">0</span>,</span><br><span class="line">args.argi2, (args.argi1 &amp; DONT_REPORT) != <span class="number">0</span>, args.argi3);</span><br><span class="line">Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">&#125; <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure></p>
<p>其中调用了handlePauseActivity方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handlePauseActivity</span><span class="params">(IBinder token, <span class="keyword">boolean</span> finished,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="keyword">boolean</span> userLeaving, <span class="keyword">int</span> configChanges, <span class="keyword">boolean</span> dontReport, <span class="keyword">int</span> seq)</span> </span>&#123;</span><br><span class="line">ActivityClientRecord r = mActivities.get(token);</span><br><span class="line"><span class="keyword">if</span> (DEBUG_ORDER) Slog.d(TAG, <span class="string">"handlePauseActivity "</span> + r + <span class="string">", seq: "</span> + seq);</span><br><span class="line"><span class="keyword">if</span> (!checkAndUpdateLifecycleSeq(seq, r, <span class="string">"pauseActivity"</span>)) &#123;</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="comment">//Slog.v(TAG, "userLeaving=" + userLeaving + " handling pause of " + r);</span></span><br><span class="line"><span class="keyword">if</span> (userLeaving) &#123;</span><br><span class="line">performUserLeavingActivity(r);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">r.activity.mConfigChangeFlags |= configChanges;</span><br><span class="line">performPauseActivity(token, finished, r.isPreHoneycomb(), <span class="string">"handlePauseActivity"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Make sure any pending writes are now committed.</span></span><br><span class="line"><span class="keyword">if</span> (r.isPreHoneycomb()) &#123;</span><br><span class="line">QueuedWork.waitToFinish();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Tell the activity manager we have paused.</span></span><br><span class="line"><span class="keyword">if</span> (!dontReport) &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">ActivityManagerNative.getDefault().activityPaused(token);</span><br><span class="line">&#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line"><span class="keyword">throw</span> ex.rethrowFromSystemServer();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">mSomeActivitiesChanged = <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>看到其中调用了performPauseActivity(token, finished, r.isPreHoneycomb(), “handlePauseActivity”)方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> Bundle <span class="title">performPauseActivity</span><span class="params">(IBinder token, <span class="keyword">boolean</span> finished,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="keyword">boolean</span> saveState, String reason)</span> </span>&#123;</span><br><span class="line">ActivityClientRecord r = mActivities.get(token);</span><br><span class="line"><span class="keyword">return</span> r != <span class="keyword">null</span> ? performPauseActivity(r, finished, saveState, reason) : <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这其中又调用了performPauseActivity的重载方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> Bundle <span class="title">performPauseActivity</span><span class="params">(ActivityClientRecord r, <span class="keyword">boolean</span> finished,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="keyword">boolean</span> saveState, String reason)</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (r.paused) &#123;</span><br><span class="line"><span class="keyword">if</span> (r.activity.mFinished) &#123;</span><br><span class="line"><span class="comment">// If we are finishing, we won't call onResume() in certain cases.</span></span><br><span class="line"><span class="comment">// So here we likewise don't want to call onPause() if the activity</span></span><br><span class="line"><span class="comment">// isn't resumed.</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line">RuntimeException e = <span class="keyword">new</span> RuntimeException(</span><br><span class="line"><span class="string">"Performing pause of activity that is not resumed: "</span></span><br><span class="line">+ r.intent.getComponent().toShortString());</span><br><span class="line">Slog.e(TAG, e.getMessage(), e);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (finished) &#123;</span><br><span class="line">r.activity.mFinished = <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Next have the activity save its current state and managed dialogs...</span></span><br><span class="line"><span class="keyword">if</span> (!r.activity.mFinished &amp;&amp; saveState) &#123;</span><br><span class="line">callCallActivityOnSaveInstanceState(r);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">performPauseActivityIfNeeded(r, reason);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Notify any outstanding on paused listeners</span></span><br><span class="line">ArrayList&lt;OnActivityPausedListener&gt; listeners;</span><br><span class="line"><span class="keyword">synchronized</span> (mOnPauseListeners) &#123;</span><br><span class="line">listeners = mOnPauseListeners.remove(r.activity);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">int</span> size = (listeners != <span class="keyword">null</span> ? listeners.size() : <span class="number">0</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">listeners.get(i).onPaused(r.activity);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> !r.activity.mFinished &amp;&amp; saveState ? r.state : <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>方法中又调用了 performPauseActivityIfNeeded(r, reason)方法，<br>我们到这个方法中看一眼：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performPauseActivityIfNeeded</span><span class="params">(ActivityClientRecord r, String reason)</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (r.paused) &#123;</span><br><span class="line"><span class="comment">// You are already paused silly...</span></span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">r.activity.mCalled = <span class="keyword">false</span>;</span><br><span class="line">mInstrumentation.callActivityOnPause(r.activity);</span><br><span class="line">EventLog.writeEvent(LOG_AM_ON_PAUSE_CALLED, UserHandle.myUserId(),</span><br><span class="line">r.activity.getComponentName().getClassName(), reason);</span><br><span class="line"><span class="keyword">if</span> (!r.activity.mCalled) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> SuperNotCalledException(<span class="string">"Activity "</span> + safeToComponentShortString(r.intent)</span><br><span class="line">+ <span class="string">" did not call through to super.onPause()"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (SuperNotCalledException e) &#123;</span><br><span class="line"><span class="keyword">throw</span> e;</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"><span class="keyword">if</span> (!mInstrumentation.onException(r.activity, e)) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Unable to pause activity "</span></span><br><span class="line">+ safeToComponentShortString(r.intent) + <span class="string">": "</span> + e.toString(), e);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">r.paused = <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>终于看到了mInstrumentation.callActivityOnPause(r.activity);<br>然后我们去mInstrumentation中去找对应的方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callActivityOnPause</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">activity.performPause();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们看到是调用了 activity.performPause()，于是我们回到activity中看一眼：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">performPause</span><span class="params">()</span> </span>&#123;</span><br><span class="line">mDoReportFullyDrawn = <span class="keyword">false</span>;</span><br><span class="line">mFragments.dispatchPause();</span><br><span class="line">mCalled = <span class="keyword">false</span>;</span><br><span class="line">onPause();</span><br><span class="line">mResumed = <span class="keyword">false</span>;</span><br><span class="line"><span class="keyword">if</span> (!mCalled &amp;&amp; getApplicationInfo().targetSdkVersion</span><br><span class="line">&gt;= android.os.Build.VERSION_CODES.GINGERBREAD) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> SuperNotCalledException(</span><br><span class="line"><span class="string">"Activity "</span> + mComponent.toShortString() +</span><br><span class="line"><span class="string">" did not call through to super.onPause()"</span>);</span><br><span class="line">&#125;</span><br><span class="line">mResumed = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>终于看到了onPause()方法，那么就是在这里调用了onPause()方法，让栈顶的activity处于onpause。<br>也就是说我们在启动一个activty的时候最先被执行的是栈顶的activity的onpause方法；<br>handlePauseActivity最后又掉用了ActivityManagerNative.getDefault().activityPaused(token)，这是应用进程告诉服务进程，栈顶的activity已经弯沉onpause方法，通过binder机制，这个方法最终会调用到ActivityManagerServise的activityPaused方法执行。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="number">7246</span>    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">activityPaused</span><span class="params">(IBinder token)</span> </span>&#123;</span><br><span class="line"><span class="number">7247</span>        <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</span><br><span class="line"><span class="number">7248</span>        <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line"><span class="number">7249</span>            ActivityStack stack = ActivityRecord.getStackLocked(token);</span><br><span class="line"><span class="number">7250</span>            <span class="keyword">if</span> (stack != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">7251</span>                stack.activityPausedLocked(token, <span class="keyword">false</span>);</span><br><span class="line"><span class="number">7252</span>            &#125;</span><br><span class="line"><span class="number">7253</span>        &#125;</span><br><span class="line"><span class="number">7254</span>        Binder.restoreCallingIdentity(origId);</span><br><span class="line"><span class="number">7255</span>    &#125;</span><br><span class="line"><span class="number">7256</span></span><br></pre></td></tr></table></figure></p>
<p>该方法内部调用了activityPausedLocked方法，<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">activityPausedLocked</span><span class="params">(IBinder token, <span class="keyword">boolean</span> timeout)</span> </span>&#123;</span><br><span class="line"><span class="number">1364</span>        <span class="keyword">if</span> (DEBUG_PAUSE) Slog.v(TAG_PAUSE,</span><br><span class="line"><span class="number">1365</span>            <span class="string">"Activity paused: token="</span> + token + <span class="string">", timeout="</span> + timeout);</span><br><span class="line"><span class="number">1366</span></span><br><span class="line"><span class="number">1367</span>        <span class="keyword">final</span> ActivityRecord r = isInStackLocked(token);</span><br><span class="line"><span class="number">1368</span>        <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">1369</span>            mHandler.removeMessages(PAUSE_TIMEOUT_MSG, r);</span><br><span class="line"><span class="number">1370</span>            <span class="keyword">if</span> (mPausingActivity == r) &#123;</span><br><span class="line"><span class="number">1371</span>                <span class="keyword">if</span> (DEBUG_STATES) Slog.v(TAG_STATES, <span class="string">"Moving to PAUSED: "</span> + r</span><br><span class="line"><span class="number">1372</span>                        + (timeout ? <span class="string">" (due to timeout)"</span> : <span class="string">" (pause complete)"</span>));</span><br><span class="line"><span class="number">1373</span>                mService.mWindowManager.deferSurfaceLayout();</span><br><span class="line"><span class="number">1374</span>                <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="number">1375</span>                    completePauseLocked(<span class="keyword">true</span> <span class="comment">/* resumeNext */</span>, <span class="keyword">null</span> <span class="comment">/* resumingActivity */</span>);</span><br><span class="line"><span class="number">1376</span>                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line"><span class="number">1377</span>                    mService.mWindowManager.continueSurfaceLayout();</span><br><span class="line"><span class="number">1378</span>                &#125;</span><br><span class="line"><span class="number">1379</span>                <span class="keyword">return</span>;</span><br><span class="line"><span class="number">1380</span>            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="number">1381</span>                EventLog.writeEvent(EventLogTags.AM_FAILED_TO_PAUSE,</span><br><span class="line"><span class="number">1382</span>                        r.userId, System.identityHashCode(r), r.shortComponentName,</span><br><span class="line"><span class="number">1383</span>                        mPausingActivity != <span class="keyword">null</span></span><br><span class="line"><span class="number">1384</span>                            ? mPausingActivity.shortComponentName : <span class="string">"(none)"</span>);</span><br><span class="line"><span class="number">1385</span>                <span class="keyword">if</span> (r.state == ActivityState.PAUSING) &#123;</span><br><span class="line"><span class="number">1386</span>                    r.state = ActivityState.PAUSED;</span><br><span class="line"><span class="number">1387</span>                    <span class="keyword">if</span> (r.finishing) &#123;</span><br><span class="line"><span class="number">1388</span>                        <span class="keyword">if</span> (DEBUG_PAUSE) Slog.v(TAG,</span><br><span class="line"><span class="number">1389</span>                                <span class="string">"Executing finish of failed to pause activity: "</span> + r);</span><br><span class="line"><span class="number">1390</span>                        finishCurrentActivityLocked(r, FINISH_AFTER_VISIBLE, <span class="keyword">false</span>);</span><br><span class="line"><span class="number">1391</span>                    &#125;</span><br><span class="line"><span class="number">1392</span>                &#125;</span><br><span class="line"><span class="number">1393</span>            &#125;</span><br><span class="line"><span class="number">1394</span>        &#125;</span><br><span class="line"><span class="number">1395</span>        mStackSupervisor.ensureActivitiesVisibleLocked(<span class="keyword">null</span>, <span class="number">0</span>, !PRESERVE_WINDOWS);</span><br><span class="line"><span class="number">1396</span>    &#125;</span><br></pre></td></tr></table></figure></p>
<p>然后执行了 completePauseLocked(true /<em> resumeNext </em>/, null /<em> resumingActivity </em>/);<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">completePauseLocked</span><span class="params">(<span class="keyword">boolean</span> resumeNext, ActivityRecord resuming)</span> </span>&#123;</span><br><span class="line"><span class="number">1399</span>        ActivityRecord prev = mPausingActivity;</span><br><span class="line"><span class="number">1400</span>        <span class="keyword">if</span> (DEBUG_PAUSE) Slog.v(TAG_PAUSE, <span class="string">"Complete pause: "</span> + prev);</span><br><span class="line"><span class="number">1401</span></span><br><span class="line"><span class="number">1402</span>        <span class="keyword">if</span> (prev != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">1403</span>            <span class="keyword">final</span> <span class="keyword">boolean</span> wasStopping = prev.state == STOPPING;</span><br><span class="line"><span class="number">1404</span>            prev.state = ActivityState.PAUSED;</span><br><span class="line"><span class="number">1405</span>            <span class="keyword">if</span> (prev.finishing) &#123;</span><br><span class="line"><span class="number">1406</span>                <span class="keyword">if</span> (DEBUG_PAUSE) Slog.v(TAG_PAUSE, <span class="string">"Executing finish of activity: "</span> + prev);</span><br><span class="line"><span class="number">1407</span>                prev = finishCurrentActivityLocked(prev, FINISH_AFTER_VISIBLE, <span class="keyword">false</span>);</span><br><span class="line"><span class="number">1408</span>            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (prev.app != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">1409</span>                <span class="keyword">if</span> (DEBUG_PAUSE) Slog.v(TAG_PAUSE, <span class="string">"Enqueue pending stop if needed: "</span> + prev</span><br><span class="line"><span class="number">1410</span>                        + <span class="string">" wasStopping="</span> + wasStopping + <span class="string">" visible="</span> + prev.visible);</span><br><span class="line"><span class="number">1411</span>                <span class="keyword">if</span> (mStackSupervisor.mActivitiesWaitingForVisibleActivity.remove(prev)) &#123;</span><br><span class="line"><span class="number">1412</span>                    <span class="keyword">if</span> (DEBUG_SWITCH || DEBUG_PAUSE) Slog.v(TAG_PAUSE,</span><br><span class="line"><span class="number">1413</span>                            <span class="string">"Complete pause, no longer waiting: "</span> + prev);</span><br><span class="line"><span class="number">1414</span>                &#125;</span><br><span class="line"><span class="number">1415</span>                <span class="keyword">if</span> (prev.deferRelaunchUntilPaused) &#123;</span><br><span class="line"><span class="number">1416</span>                    <span class="comment">// Complete the deferred relaunch that was waiting for pause to complete.</span></span><br><span class="line"><span class="number">1417</span>                    <span class="keyword">if</span> (DEBUG_PAUSE) Slog.v(TAG_PAUSE, <span class="string">"Re-launching after pause: "</span> + prev);</span><br><span class="line"><span class="number">1418</span>                    prev.relaunchActivityLocked(<span class="keyword">false</span> <span class="comment">/* andResume */</span>,</span><br><span class="line"><span class="number">1419</span>                            prev.preserveWindowOnDeferredRelaunch);</span><br><span class="line"><span class="number">1420</span>                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (wasStopping) &#123;</span><br><span class="line"><span class="number">1421</span>                    <span class="comment">// We are also stopping, the stop request must have gone soon after the pause.</span></span><br><span class="line"><span class="number">1422</span>                    <span class="comment">// We can't clobber it, because the stop confirmation will not be handled.</span></span><br><span class="line"><span class="number">1423</span>                    <span class="comment">// We don't need to schedule another stop, we only need to let it happen.</span></span><br><span class="line"><span class="number">1424</span>                    prev.state = STOPPING;</span><br><span class="line"><span class="number">1425</span>                &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((!prev.visible &amp;&amp; !hasVisibleBehindActivity())</span><br><span class="line"><span class="number">1426</span>                        || mService.isSleepingOrShuttingDownLocked()) &#123;</span><br><span class="line"><span class="number">1427</span>                    <span class="comment">// Clear out any deferred client hide we might currently have.</span></span><br><span class="line"><span class="number">1428</span>                    prev.setDeferHidingClient(<span class="keyword">false</span>);</span><br><span class="line"><span class="number">1429</span>                    <span class="comment">// If we were visible then resumeTopActivities will release resources before</span></span><br><span class="line"><span class="number">1430</span>                    <span class="comment">// stopping.</span></span><br><span class="line"><span class="number">1431</span>                    addToStopping(prev, <span class="keyword">true</span> <span class="comment">/* scheduleIdle */</span>, <span class="keyword">false</span> <span class="comment">/* idleDelayed */</span>);</span><br><span class="line"><span class="number">1432</span>                &#125;</span><br><span class="line"><span class="number">1433</span>            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="number">1434</span>                <span class="keyword">if</span> (DEBUG_PAUSE) Slog.v(TAG_PAUSE, <span class="string">"App died during pause, not stopping: "</span> + prev);</span><br><span class="line"><span class="number">1435</span>                prev = <span class="keyword">null</span>;</span><br><span class="line"><span class="number">1436</span>            &#125;</span><br><span class="line"><span class="number">1437</span>            <span class="comment">// It is possible the activity was freezing the screen before it was paused.</span></span><br><span class="line"><span class="number">1438</span>            <span class="comment">// In that case go ahead and remove the freeze this activity has on the screen</span></span><br><span class="line"><span class="number">1439</span>            <span class="comment">// since it is no longer visible.</span></span><br><span class="line"><span class="number">1440</span>            <span class="keyword">if</span> (prev != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">1441</span>                prev.stopFreezingScreenLocked(<span class="keyword">true</span> <span class="comment">/*force*/</span>);</span><br><span class="line"><span class="number">1442</span>            &#125;</span><br><span class="line"><span class="number">1443</span>            mPausingActivity = <span class="keyword">null</span>;</span><br><span class="line"><span class="number">1444</span>        &#125;</span><br><span class="line"><span class="number">1445</span></span><br><span class="line"><span class="number">1446</span>        <span class="keyword">if</span> (resumeNext) &#123;</span><br><span class="line"><span class="number">1447</span>            <span class="keyword">final</span> ActivityStack topStack = mStackSupervisor.getFocusedStack();</span><br><span class="line"><span class="number">1448</span>            <span class="keyword">if</span> (!mService.isSleepingOrShuttingDownLocked()) &#123;</span><br><span class="line"><span class="number">1449</span>                mStackSupervisor.resumeFocusedStackTopActivityLocked(topStack, prev, <span class="keyword">null</span>);</span><br><span class="line"><span class="number">1450</span>            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="number">1451</span>                mStackSupervisor.checkReadyForSleepLocked();</span><br><span class="line"><span class="number">1452</span>                ActivityRecord top = topStack.topRunningActivityLocked();</span><br><span class="line"><span class="number">1453</span>                <span class="keyword">if</span> (top == <span class="keyword">null</span> || (prev != <span class="keyword">null</span> &amp;&amp; top != prev)) &#123;</span><br><span class="line"><span class="number">1454</span>                    <span class="comment">// If there are no more activities available to run, do resume anyway to start</span></span><br><span class="line"><span class="number">1455</span>                    <span class="comment">// something. Also if the top activity on the stack is not the just paused</span></span><br><span class="line"><span class="number">1456</span>                    <span class="comment">// activity, we need to go ahead and resume it to ensure we complete an</span></span><br><span class="line"><span class="number">1457</span>                    <span class="comment">// in-flight app switch.</span></span><br><span class="line"><span class="number">1458</span>                    mStackSupervisor.resumeFocusedStackTopActivityLocked();</span><br><span class="line"><span class="number">1459</span>                &#125;</span><br><span class="line"><span class="number">1460</span>            &#125;</span><br><span class="line"><span class="number">1461</span>        &#125;</span><br><span class="line"><span class="number">1462</span></span><br><span class="line"><span class="number">1463</span>        <span class="keyword">if</span> (prev != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">1464</span>            prev.resumeKeyDispatchingLocked();</span><br><span class="line"><span class="number">1465</span></span><br><span class="line"><span class="number">1466</span>            <span class="keyword">if</span> (prev.app != <span class="keyword">null</span> &amp;&amp; prev.cpuTimeAtResume &gt; <span class="number">0</span></span><br><span class="line"><span class="number">1467</span>                    &amp;&amp; mService.mBatteryStatsService.isOnBattery()) &#123;</span><br><span class="line"><span class="number">1468</span>                <span class="keyword">long</span> diff = mService.mProcessCpuTracker.getCpuTimeForPid(prev.app.pid)</span><br><span class="line"><span class="number">1469</span>                        - prev.cpuTimeAtResume;</span><br><span class="line"><span class="number">1470</span>                <span class="keyword">if</span> (diff &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">1471</span>                    BatteryStatsImpl bsi = mService.mBatteryStatsService.getActiveStatistics();</span><br><span class="line"><span class="number">1472</span>                    <span class="keyword">synchronized</span> (bsi) &#123;</span><br><span class="line"><span class="number">1473</span>                        BatteryStatsImpl.Uid.Proc ps =</span><br><span class="line"><span class="number">1474</span>                                bsi.getProcessStatsLocked(prev.info.applicationInfo.uid,</span><br><span class="line"><span class="number">1475</span>                                        prev.info.packageName);</span><br><span class="line"><span class="number">1476</span>                        <span class="keyword">if</span> (ps != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">1477</span>                            ps.addForegroundTimeLocked(diff);</span><br><span class="line"><span class="number">1478</span>                        &#125;</span><br><span class="line"><span class="number">1479</span>                    &#125;</span><br><span class="line"><span class="number">1480</span>                &#125;</span><br><span class="line"><span class="number">1481</span>            &#125;</span><br><span class="line"><span class="number">1482</span>            prev.cpuTimeAtResume = <span class="number">0</span>; <span class="comment">// reset it</span></span><br><span class="line"><span class="number">1483</span>        &#125;</span><br><span class="line"><span class="number">1484</span></span><br><span class="line"><span class="number">1485</span>        <span class="comment">// Notify when the task stack has changed, but only if visibilities changed (not just</span></span><br><span class="line"><span class="number">1486</span>        <span class="comment">// focus). Also if there is an active pinned stack - we always want to notify it about</span></span><br><span class="line"><span class="number">1487</span>        <span class="comment">// task stack changes, because its positioning may depend on it.</span></span><br><span class="line"><span class="number">1488</span>        <span class="keyword">if</span> (mStackSupervisor.mAppVisibilitiesChangedSinceLastPause</span><br><span class="line"><span class="number">1489</span>                || mService.mStackSupervisor.getStack(PINNED_STACK_ID) != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">1490</span>            mService.mTaskChangeNotificationController.notifyTaskStackChanged();</span><br><span class="line"><span class="number">1491</span>            mStackSupervisor.mAppVisibilitiesChangedSinceLastPause = <span class="keyword">false</span>;</span><br><span class="line"><span class="number">1492</span>        &#125;</span><br><span class="line"><span class="number">1493</span></span><br><span class="line"><span class="number">1494</span>        mStackSupervisor.ensureActivitiesVisibleLocked(resuming, <span class="number">0</span>, !PRESERVE_WINDOWS);</span><br><span class="line"><span class="number">1495</span>    &#125;</span><br></pre></td></tr></table></figure></p>
<p>这里面又调用了 mStackSupervisor.resumeFocusedStackTopActivityLocked(topStack, prev, null);<br>然后对应方法又调用<br>targetStack.resumeTopActivityUncheckedLocked(target, targetOptions);<br>对应的方法又去调用 result = resumeTopActivityInnerLocked(prev, options);</p>
<p>这个方法最后调用了 mStackSupervisor.startSpecificActivityLocked(next, true, false);<br>（这几个和前面类似，只是代码片段太多，估计贴出来你们都晕头转向了，所以省略吧）<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">startSpecificActivityLocked</span><span class="params">(ActivityRecord r,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">1553</span>            <span class="keyword">boolean</span> andResume, <span class="keyword">boolean</span> checkConfig)</span> </span>&#123;</span><br><span class="line"><span class="number">1554</span>        <span class="comment">// Is this activity's application already running?</span></span><br><span class="line"><span class="number">1555</span>        ProcessRecord app = mService.getProcessRecordLocked(r.processName,</span><br><span class="line"><span class="number">1556</span>                r.info.applicationInfo.uid, <span class="keyword">true</span>);</span><br><span class="line"><span class="number">1557</span></span><br><span class="line"><span class="number">1558</span>        r.getStack().setLaunchTime(r);</span><br><span class="line"><span class="number">1559</span></span><br><span class="line"><span class="number">1560</span>        <span class="keyword">if</span> (app != <span class="keyword">null</span> &amp;&amp; app.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">1561</span>            <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="number">1562</span>                <span class="keyword">if</span> ((r.info.flags&amp;ActivityInfo.FLAG_MULTIPROCESS) == <span class="number">0</span></span><br><span class="line"><span class="number">1563</span>                        || !<span class="string">"android"</span>.equals(r.info.packageName)) &#123;</span><br><span class="line"><span class="number">1564</span>                    <span class="comment">// Don't add this if it is a platform component that is marked</span></span><br><span class="line"><span class="number">1565</span>                    <span class="comment">// to run in multiple processes, because this is actually</span></span><br><span class="line"><span class="number">1566</span>                    <span class="comment">// part of the framework so doesn't make sense to track as a</span></span><br><span class="line"><span class="number">1567</span>                    <span class="comment">// separate apk in the process.</span></span><br><span class="line"><span class="number">1568</span>                    app.addPackage(r.info.packageName, r.info.applicationInfo.versionCode,</span><br><span class="line"><span class="number">1569</span>                            mService.mProcessStats);</span><br><span class="line"><span class="number">1570</span>                &#125;</span><br><span class="line"><span class="number">1571</span>                realStartActivityLocked(r, app, andResume, checkConfig);</span><br><span class="line"><span class="number">1572</span>                <span class="keyword">return</span>;</span><br><span class="line"><span class="number">1573</span>            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line"><span class="number">1574</span>                Slog.w(TAG, <span class="string">"Exception when starting activity "</span></span><br><span class="line"><span class="number">1575</span>                        + r.intent.getComponent().flattenToShortString(), e);</span><br><span class="line"><span class="number">1576</span>            &#125;</span><br><span class="line"><span class="number">1577</span></span><br><span class="line"><span class="number">1578</span>            <span class="comment">// If a dead object exception was thrown -- fall through to</span></span><br><span class="line"><span class="number">1579</span>            <span class="comment">// restart the application.</span></span><br><span class="line"><span class="number">1580</span>        &#125;</span><br><span class="line"><span class="number">1581</span></span><br><span class="line"><span class="number">1582</span>        mService.startProcessLocked(r.processName, r.info.applicationInfo, <span class="keyword">true</span>, <span class="number">0</span>,</span><br><span class="line"><span class="number">1583</span>                <span class="string">"activity"</span>, r.intent.getComponent(), <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line"><span class="number">1584</span>    &#125;</span><br></pre></td></tr></table></figure></p>
<p>这里判断activity所需的进程是否已经启动，若启动的话<br>调用realStartActivityLocked(r, app, andResume, checkConfig);<br>看一下这个方法，否则调用 mService.startProcessLocked(r.processName, r.info.applicationInfo, true, 0,<br>1583                “activity”, r.intent.getComponent(), false, false, true)：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">realStartActivityLocked</span><span class="params">(ActivityRecord r, ProcessRecord app,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">1326</span>            <span class="keyword">boolean</span> andResume, <span class="keyword">boolean</span> checkConfig)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line"><span class="number">1327</span></span><br><span class="line"><span class="number">1328</span>        <span class="keyword">if</span> (!allPausedActivitiesComplete()) &#123;</span><br><span class="line"><span class="number">1329</span>            <span class="comment">// While there are activities pausing we skipping starting any new activities until</span></span><br><span class="line"><span class="number">1330</span>            <span class="comment">// pauses are complete. <span class="doctag">NOTE:</span> that we also do this for activities that are starting in</span></span><br><span class="line"><span class="number">1331</span>            <span class="comment">// the paused state because they will first be resumed then paused on the client side.</span></span><br><span class="line"><span class="number">1332</span>            <span class="keyword">if</span> (DEBUG_SWITCH || DEBUG_PAUSE || DEBUG_STATES) Slog.v(TAG_PAUSE,</span><br><span class="line"><span class="number">1333</span>                    <span class="string">"realStartActivityLocked: Skipping start of r="</span> + r</span><br><span class="line"><span class="number">1334</span>                    + <span class="string">" some activities pausing..."</span>);</span><br><span class="line"><span class="number">1335</span>            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"><span class="number">1336</span>        &#125;</span><br><span class="line"><span class="number">1337</span></span><br><span class="line"><span class="number">1338</span>        r.startFreezingScreenLocked(app, <span class="number">0</span>);</span><br><span class="line"><span class="number">1339</span>        <span class="keyword">if</span> (r.getStack().checkKeyguardVisibility(r, <span class="keyword">true</span> <span class="comment">/* shouldBeVisible */</span>, <span class="keyword">true</span> <span class="comment">/* isTop */</span>)) &#123;</span><br><span class="line"><span class="number">1340</span>            <span class="comment">// We only set the visibility to true if the activity is allowed to be visible based on</span></span><br><span class="line"><span class="number">1341</span>            <span class="comment">// keyguard state. This avoids setting this into motion in window manager that is later</span></span><br><span class="line"><span class="number">1342</span>            <span class="comment">// cancelled due to later calls to ensure visible activities that set visibility back to</span></span><br><span class="line"><span class="number">1343</span>            <span class="comment">// false.</span></span><br><span class="line"><span class="number">1344</span>            r.setVisibility(<span class="keyword">true</span>);</span><br><span class="line"><span class="number">1345</span>        &#125;</span><br><span class="line"><span class="number">1346</span></span><br><span class="line"><span class="number">1347</span>        <span class="comment">// schedule launch ticks to collect information about slow apps.</span></span><br><span class="line"><span class="number">1348</span>        r.startLaunchTickingLocked();</span><br><span class="line"><span class="number">1349</span></span><br><span class="line"><span class="number">1350</span>        <span class="comment">// Have the window manager re-evaluate the orientation of the screen based on the new</span></span><br><span class="line"><span class="number">1351</span>        <span class="comment">// activity order.  Note that as a result of this, it can call back into the activity</span></span><br><span class="line"><span class="number">1352</span>        <span class="comment">// manager with a new orientation.  We don't care about that, because the activity is not</span></span><br><span class="line"><span class="number">1353</span>        <span class="comment">// currently running so we are just restarting it anyway.</span></span><br><span class="line"><span class="number">1354</span>        <span class="keyword">if</span> (checkConfig) &#123;</span><br><span class="line"><span class="number">1355</span>            <span class="keyword">final</span> <span class="keyword">int</span> displayId = r.getDisplayId();</span><br><span class="line"><span class="number">1356</span>            <span class="keyword">final</span> Configuration config = mWindowManager.updateOrientationFromAppTokens(</span><br><span class="line"><span class="number">1357</span>                    getDisplayOverrideConfiguration(displayId),</span><br><span class="line"><span class="number">1358</span>                    r.mayFreezeScreenLocked(app) ? r.appToken : <span class="keyword">null</span>, displayId);</span><br><span class="line"><span class="number">1359</span>            <span class="comment">// Deferring resume here because we're going to launch new activity shortly.</span></span><br><span class="line"><span class="number">1360</span>            <span class="comment">// We don't want to perform a redundant launch of the same record while ensuring</span></span><br><span class="line"><span class="number">1361</span>            <span class="comment">// configurations and trying to resume top activity of focused stack.</span></span><br><span class="line"><span class="number">1362</span>            mService.updateDisplayOverrideConfigurationLocked(config, r, <span class="keyword">true</span> <span class="comment">/* deferResume */</span>,</span><br><span class="line"><span class="number">1363</span>                    displayId);</span><br><span class="line"><span class="number">1364</span>        &#125;</span><br><span class="line"><span class="number">1365</span></span><br><span class="line"><span class="number">1366</span>        <span class="keyword">if</span> (mKeyguardController.isKeyguardLocked()) &#123;</span><br><span class="line"><span class="number">1367</span>            r.notifyUnknownVisibilityLaunched();</span><br><span class="line"><span class="number">1368</span>        &#125;</span><br><span class="line"><span class="number">1369</span>        <span class="keyword">final</span> <span class="keyword">int</span> applicationInfoUid =</span><br><span class="line"><span class="number">1370</span>                (r.info.applicationInfo != <span class="keyword">null</span>) ? r.info.applicationInfo.uid : -<span class="number">1</span>;</span><br><span class="line"><span class="number">1371</span>        <span class="keyword">if</span> ((r.userId != app.userId) || (r.appInfo.uid != applicationInfoUid)) &#123;</span><br><span class="line"><span class="number">1372</span>            Slog.wtf(TAG,</span><br><span class="line"><span class="number">1373</span>                    <span class="string">"User ID for activity changing for "</span> + r</span><br><span class="line"><span class="number">1374</span>                            + <span class="string">" appInfo.uid="</span> + r.appInfo.uid</span><br><span class="line"><span class="number">1375</span>                            + <span class="string">" info.ai.uid="</span> + applicationInfoUid</span><br><span class="line"><span class="number">1376</span>                            + <span class="string">" old="</span> + r.app + <span class="string">" new="</span> + app);</span><br><span class="line"><span class="number">1377</span>        &#125;</span><br><span class="line"><span class="number">1378</span></span><br><span class="line"><span class="number">1379</span>        r.app = app;</span><br><span class="line"><span class="number">1380</span>        app.waitingToKill = <span class="keyword">null</span>;</span><br><span class="line"><span class="number">1381</span>        r.launchCount++;</span><br><span class="line"><span class="number">1382</span>        r.lastLaunchTime = SystemClock.uptimeMillis();</span><br><span class="line"><span class="number">1383</span></span><br><span class="line"><span class="number">1384</span>        <span class="keyword">if</span> (DEBUG_ALL) Slog.v(TAG, <span class="string">"Launching: "</span> + r);</span><br><span class="line"><span class="number">1385</span></span><br><span class="line"><span class="number">1386</span>        <span class="keyword">int</span> idx = app.activities.indexOf(r);</span><br><span class="line"><span class="number">1387</span>        <span class="keyword">if</span> (idx &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">1388</span>            app.activities.add(r);</span><br><span class="line"><span class="number">1389</span>        &#125;</span><br><span class="line"><span class="number">1390</span>        mService.updateLruProcessLocked(app, <span class="keyword">true</span>, <span class="keyword">null</span>);</span><br><span class="line"><span class="number">1391</span>        mService.updateOomAdjLocked();</span><br><span class="line"><span class="number">1392</span></span><br><span class="line"><span class="number">1393</span>        <span class="keyword">final</span> TaskRecord task = r.getTask();</span><br><span class="line"><span class="number">1394</span>        <span class="keyword">if</span> (task.mLockTaskAuth == LOCK_TASK_AUTH_LAUNCHABLE ||</span><br><span class="line"><span class="number">1395</span>                task.mLockTaskAuth == LOCK_TASK_AUTH_LAUNCHABLE_PRIV) &#123;</span><br><span class="line"><span class="number">1396</span>            setLockTaskModeLocked(task, LOCK_TASK_MODE_LOCKED, <span class="string">"mLockTaskAuth==LAUNCHABLE"</span>, <span class="keyword">false</span>);</span><br><span class="line"><span class="number">1397</span>        &#125;</span><br><span class="line"><span class="number">1398</span></span><br><span class="line"><span class="number">1399</span>        <span class="keyword">final</span> ActivityStack stack = task.getStack();</span><br><span class="line"><span class="number">1400</span>        <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="number">1401</span>            <span class="keyword">if</span> (app.thread == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">1402</span>                <span class="keyword">throw</span> <span class="keyword">new</span> RemoteException();</span><br><span class="line"><span class="number">1403</span>            &#125;</span><br><span class="line"><span class="number">1404</span>            List&lt;ResultInfo&gt; results = <span class="keyword">null</span>;</span><br><span class="line"><span class="number">1405</span>            List&lt;ReferrerIntent&gt; newIntents = <span class="keyword">null</span>;</span><br><span class="line"><span class="number">1406</span>            <span class="keyword">if</span> (andResume) &#123;</span><br><span class="line"><span class="number">1407</span>                <span class="comment">// We don't need to deliver new intents and/or set results if activity is going</span></span><br><span class="line"><span class="number">1408</span>                <span class="comment">// to pause immediately after launch.</span></span><br><span class="line"><span class="number">1409</span>                results = r.results;</span><br><span class="line"><span class="number">1410</span>                newIntents = r.newIntents;</span><br><span class="line"><span class="number">1411</span>            &#125;</span><br><span class="line"><span class="number">1412</span>            <span class="keyword">if</span> (DEBUG_SWITCH) Slog.v(TAG_SWITCH,</span><br><span class="line"><span class="number">1413</span>                    <span class="string">"Launching: "</span> + r + <span class="string">" icicle="</span> + r.icicle + <span class="string">" with results="</span> + results</span><br><span class="line"><span class="number">1414</span>                    + <span class="string">" newIntents="</span> + newIntents + <span class="string">" andResume="</span> + andResume);</span><br><span class="line"><span class="number">1415</span>            EventLog.writeEvent(EventLogTags.AM_RESTART_ACTIVITY, r.userId,</span><br><span class="line"><span class="number">1416</span>                    System.identityHashCode(r), task.taskId, r.shortComponentName);</span><br><span class="line"><span class="number">1417</span>            <span class="keyword">if</span> (r.isHomeActivity()) &#123;</span><br><span class="line"><span class="number">1418</span>                <span class="comment">// Home process is the root process of the task.</span></span><br><span class="line"><span class="number">1419</span>                mService.mHomeProcess = task.mActivities.get(<span class="number">0</span>).app;</span><br><span class="line"><span class="number">1420</span>            &#125;</span><br><span class="line"><span class="number">1421</span>            mService.notifyPackageUse(r.intent.getComponent().getPackageName(),</span><br><span class="line"><span class="number">1422</span>                                      PackageManager.NOTIFY_PACKAGE_USE_ACTIVITY);</span><br><span class="line"><span class="number">1423</span>            r.sleeping = <span class="keyword">false</span>;</span><br><span class="line"><span class="number">1424</span>            r.forceNewConfig = <span class="keyword">false</span>;</span><br><span class="line"><span class="number">1425</span>            mService.showUnsupportedZoomDialogIfNeededLocked(r);</span><br><span class="line"><span class="number">1426</span>            mService.showAskCompatModeDialogLocked(r);</span><br><span class="line"><span class="number">1427</span>            r.compat = mService.compatibilityInfoForPackageLocked(r.info.applicationInfo);</span><br><span class="line"><span class="number">1428</span>            ProfilerInfo profilerInfo = <span class="keyword">null</span>;</span><br><span class="line"><span class="number">1429</span>            <span class="keyword">if</span> (mService.mProfileApp != <span class="keyword">null</span> &amp;&amp; mService.mProfileApp.equals(app.processName)) &#123;</span><br><span class="line"><span class="number">1430</span>                <span class="keyword">if</span> (mService.mProfileProc == <span class="keyword">null</span> || mService.mProfileProc == app) &#123;</span><br><span class="line"><span class="number">1431</span>                    mService.mProfileProc = app;</span><br><span class="line"><span class="number">1432</span>                    <span class="keyword">final</span> String profileFile = mService.mProfileFile;</span><br><span class="line"><span class="number">1433</span>                    <span class="keyword">if</span> (profileFile != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">1434</span>                        ParcelFileDescriptor profileFd = mService.mProfileFd;</span><br><span class="line"><span class="number">1435</span>                        <span class="keyword">if</span> (profileFd != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">1436</span>                            <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="number">1437</span>                                profileFd = profileFd.dup();</span><br><span class="line"><span class="number">1438</span>                            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line"><span class="number">1439</span>                                <span class="keyword">if</span> (profileFd != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">1440</span>                                    <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="number">1441</span>                                        profileFd.close();</span><br><span class="line"><span class="number">1442</span>                                    &#125; <span class="keyword">catch</span> (IOException o) &#123;</span><br><span class="line"><span class="number">1443</span>                                    &#125;</span><br><span class="line"><span class="number">1444</span>                                    profileFd = <span class="keyword">null</span>;</span><br><span class="line"><span class="number">1445</span>                                &#125;</span><br><span class="line"><span class="number">1446</span>                            &#125;</span><br><span class="line"><span class="number">1447</span>                        &#125;</span><br><span class="line"><span class="number">1448</span></span><br><span class="line"><span class="number">1449</span>                        profilerInfo = <span class="keyword">new</span> ProfilerInfo(profileFile, profileFd,</span><br><span class="line"><span class="number">1450</span>                                mService.mSamplingInterval, mService.mAutoStopProfiler,</span><br><span class="line"><span class="number">1451</span>                                mService.mStreamingOutput);</span><br><span class="line"><span class="number">1452</span>                    &#125;</span><br><span class="line"><span class="number">1453</span>                &#125;</span><br><span class="line"><span class="number">1454</span>            &#125;</span><br><span class="line"><span class="number">1455</span></span><br><span class="line"><span class="number">1456</span>            app.hasShownUi = <span class="keyword">true</span>;</span><br><span class="line"><span class="number">1457</span>            app.pendingUiClean = <span class="keyword">true</span>;</span><br><span class="line"><span class="number">1458</span>            app.forceProcessStateUpTo(mService.mTopProcessState);</span><br><span class="line"><span class="number">1459</span>            <span class="comment">// Because we could be starting an Activity in the system process this may not go across</span></span><br><span class="line"><span class="number">1460</span>            <span class="comment">// a Binder interface which would create a new Configuration. Consequently we have to</span></span><br><span class="line"><span class="number">1461</span>            <span class="comment">// always create a new Configuration here.</span></span><br><span class="line"><span class="number">1462</span></span><br><span class="line"><span class="number">1463</span>            <span class="keyword">final</span> MergedConfiguration mergedConfiguration = <span class="keyword">new</span> MergedConfiguration(</span><br><span class="line"><span class="number">1464</span>                    mService.getGlobalConfiguration(), r.getMergedOverrideConfiguration());</span><br><span class="line"><span class="number">1465</span>            r.setLastReportedConfiguration(mergedConfiguration);</span><br><span class="line"><span class="number">1466</span></span><br><span class="line"><span class="number">1467</span>            app.thread.scheduleLaunchActivity(<span class="keyword">new</span> Intent(r.intent), r.appToken,</span><br><span class="line"><span class="number">1468</span>                    System.identityHashCode(r), r.info,</span><br><span class="line"><span class="number">1469</span>                    <span class="comment">// <span class="doctag">TODO:</span> Have this take the merged configuration instead of separate global and</span></span><br><span class="line"><span class="number">1470</span>                    <span class="comment">// override configs.</span></span><br><span class="line"><span class="number">1471</span>                    mergedConfiguration.getGlobalConfiguration(),</span><br><span class="line"><span class="number">1472</span>                    mergedConfiguration.getOverrideConfiguration(), r.compat,</span><br><span class="line"><span class="number">1473</span>                    r.launchedFromPackage, task.voiceInteractor, app.repProcState, r.icicle,</span><br><span class="line"><span class="number">1474</span>                    r.persistentState, results, newIntents, !andResume,</span><br><span class="line"><span class="number">1475</span>                    mService.isNextTransitionForward(), profilerInfo);</span><br><span class="line"><span class="number">1476</span></span><br><span class="line"><span class="number">1477</span>            <span class="keyword">if</span> ((app.info.privateFlags&amp;ApplicationInfo.PRIVATE_FLAG_CANT_SAVE_STATE) != <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">1478</span>                <span class="comment">// This may be a heavy-weight process!  Note that the package</span></span><br><span class="line"><span class="number">1479</span>                <span class="comment">// manager will ensure that only activity can run in the main</span></span><br><span class="line"><span class="number">1480</span>                <span class="comment">// process of the .apk, which is the only thing that will be</span></span><br><span class="line"><span class="number">1481</span>                <span class="comment">// considered heavy-weight.</span></span><br><span class="line"><span class="number">1482</span>                <span class="keyword">if</span> (app.processName.equals(app.info.packageName)) &#123;</span><br><span class="line"><span class="number">1483</span>                    <span class="keyword">if</span> (mService.mHeavyWeightProcess != <span class="keyword">null</span></span><br><span class="line"><span class="number">1484</span>                            &amp;&amp; mService.mHeavyWeightProcess != app) &#123;</span><br><span class="line"><span class="number">1485</span>                        Slog.w(TAG, <span class="string">"Starting new heavy weight process "</span> + app</span><br><span class="line"><span class="number">1486</span>                                + <span class="string">" when already running "</span></span><br><span class="line"><span class="number">1487</span>                                + mService.mHeavyWeightProcess);</span><br><span class="line"><span class="number">1488</span>                    &#125;</span><br><span class="line"><span class="number">1489</span>                    mService.mHeavyWeightProcess = app;</span><br><span class="line"><span class="number">1490</span>                    Message msg = mService.mHandler.obtainMessage(</span><br><span class="line"><span class="number">1491</span>                            ActivityManagerService.POST_HEAVY_NOTIFICATION_MSG);</span><br><span class="line"><span class="number">1492</span>                    msg.obj = r;</span><br><span class="line"><span class="number">1493</span>                    mService.mHandler.sendMessage(msg);</span><br><span class="line"><span class="number">1494</span>                &#125;</span><br><span class="line"><span class="number">1495</span>            &#125;</span><br><span class="line"><span class="number">1496</span></span><br><span class="line"><span class="number">1497</span>        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line"><span class="number">1498</span>            <span class="keyword">if</span> (r.launchFailed) &#123;</span><br><span class="line"><span class="number">1499</span>                <span class="comment">// This is the second time we failed -- finish activity</span></span><br><span class="line"><span class="number">1500</span>                <span class="comment">// and give up.</span></span><br><span class="line"><span class="number">1501</span>                Slog.e(TAG, <span class="string">"Second failure launching "</span></span><br><span class="line"><span class="number">1502</span>                      + r.intent.getComponent().flattenToShortString()</span><br><span class="line"><span class="number">1503</span>                      + <span class="string">", giving up"</span>, e);</span><br><span class="line"><span class="number">1504</span>                mService.appDiedLocked(app);</span><br><span class="line"><span class="number">1505</span>                stack.requestFinishActivityLocked(r.appToken, Activity.RESULT_CANCELED, <span class="keyword">null</span>,</span><br><span class="line"><span class="number">1506</span>                        <span class="string">"2nd-crash"</span>, <span class="keyword">false</span>);</span><br><span class="line"><span class="number">1507</span>                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"><span class="number">1508</span>            &#125;</span><br><span class="line"><span class="number">1509</span></span><br><span class="line"><span class="number">1510</span>            <span class="comment">// This is the first time we failed -- restart process and</span></span><br><span class="line"><span class="number">1511</span>            <span class="comment">// retry.</span></span><br><span class="line"><span class="number">1512</span>            r.launchFailed = <span class="keyword">true</span>;</span><br><span class="line"><span class="number">1513</span>            app.activities.remove(r);</span><br><span class="line"><span class="number">1514</span>            <span class="keyword">throw</span> e;</span><br><span class="line"><span class="number">1515</span>        &#125;</span><br><span class="line"><span class="number">1516</span></span><br><span class="line"><span class="number">1517</span>        r.launchFailed = <span class="keyword">false</span>;</span><br><span class="line"><span class="number">1518</span>        <span class="keyword">if</span> (stack.updateLRUListLocked(r)) &#123;</span><br><span class="line"><span class="number">1519</span>            Slog.w(TAG, <span class="string">"Activity "</span> + r + <span class="string">" being launched, but already in LRU list"</span>);</span><br><span class="line"><span class="number">1520</span>        &#125;</span><br><span class="line"><span class="number">1521</span></span><br><span class="line"><span class="number">1522</span>        <span class="keyword">if</span> (andResume) &#123;</span><br><span class="line"><span class="number">1523</span>            <span class="comment">// As part of the process of launching, ActivityThread also performs</span></span><br><span class="line"><span class="number">1524</span>            <span class="comment">// a resume.</span></span><br><span class="line"><span class="number">1525</span>            stack.minimalResumeActivityLocked(r);</span><br><span class="line"><span class="number">1526</span>        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="number">1527</span>            <span class="comment">// This activity is not starting in the resumed state... which should look like we asked</span></span><br><span class="line"><span class="number">1528</span>            <span class="comment">// it to pause+stop (but remain visible), and it has done so and reported back the</span></span><br><span class="line"><span class="number">1529</span>            <span class="comment">// current icicle and other state.</span></span><br><span class="line"><span class="number">1530</span>            <span class="keyword">if</span> (DEBUG_STATES) Slog.v(TAG_STATES,</span><br><span class="line"><span class="number">1531</span>                    <span class="string">"Moving to PAUSED: "</span> + r + <span class="string">" (starting in paused state)"</span>);</span><br><span class="line"><span class="number">1532</span>            r.state = PAUSED;</span><br><span class="line"><span class="number">1533</span>        &#125;</span><br><span class="line"><span class="number">1534</span></span><br><span class="line"><span class="number">1535</span>        <span class="comment">// Launch the new version setup screen if needed.  We do this -after-</span></span><br><span class="line"><span class="number">1536</span>        <span class="comment">// launching the initial activity (that is, home), so that it can have</span></span><br><span class="line"><span class="number">1537</span>        <span class="comment">// a chance to initialize itself while in the background, making the</span></span><br><span class="line"><span class="number">1538</span>        <span class="comment">// switch back to it faster and look better.</span></span><br><span class="line"><span class="number">1539</span>        <span class="keyword">if</span> (isFocusedStack(stack)) &#123;</span><br><span class="line"><span class="number">1540</span>            mService.startSetupActivityLocked();</span><br><span class="line"><span class="number">1541</span>        &#125;</span><br><span class="line"><span class="number">1542</span></span><br><span class="line"><span class="number">1543</span>        <span class="comment">// Update any services we are bound to that might care about whether</span></span><br><span class="line"><span class="number">1544</span>        <span class="comment">// their client may have activities.</span></span><br><span class="line"><span class="number">1545</span>        <span class="keyword">if</span> (r.app != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">1546</span>            mService.mServices.updateServiceConnectionActivitiesLocked(r.app);</span><br><span class="line"><span class="number">1547</span>        &#125;</span><br><span class="line"><span class="number">1548</span></span><br><span class="line"><span class="number">1549</span>        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"><span class="number">1550</span>    &#125;</span><br></pre></td></tr></table></figure></p>
<p>在这其中调用了<strong>app.thread.scheduleLaunchActivity</strong></p>
<p>而当activity所需要的进程未启动则会调用 startProcessLocked(<br>3752                app, hostingType, hostingNameStr, abiOverride, entryPoint, entryPointArgs);<br>然后这个方法又调用了<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">startResult = Process.start(entryPoint,</span><br><span class="line"><span class="number">3926</span>                        app.processName, uid, uid, gids, debugFlags, mountExternal,</span><br><span class="line"><span class="number">3927</span>                        app.info.targetSdkVersion, seInfo, requiredAbi, instructionSet,</span><br><span class="line"><span class="number">3928</span>                        app.info.dataDir, invokeWith, entryPointArgs);</span><br></pre></td></tr></table></figure></p>
<p>然后就到了ZygoteProcess中的start方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> Process.<span class="function">ProcessStartResult <span class="title">start</span><span class="params">(<span class="keyword">final</span> String processClass,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">196</span>                                                  <span class="keyword">final</span> String niceName,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">197</span>                                                  <span class="keyword">int</span> uid, <span class="keyword">int</span> gid, <span class="keyword">int</span>[] gids,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">198</span>                                                  <span class="keyword">int</span> debugFlags, <span class="keyword">int</span> mountExternal,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">199</span>                                                  <span class="keyword">int</span> targetSdkVersion,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">200</span>                                                  String seInfo,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">201</span>                                                  String abi,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">202</span>                                                  String instructionSet,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">203</span>                                                  String appDataDir,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">204</span>                                                  String invokeWith,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">205</span>                                                  String[] zygoteArgs)</span> </span>&#123;</span><br><span class="line"><span class="number">206</span>        <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="number">207</span>            <span class="keyword">return</span> startViaZygote(processClass, niceName, uid, gid, gids,</span><br><span class="line"><span class="number">208</span>                    debugFlags, mountExternal, targetSdkVersion, seInfo,</span><br><span class="line"><span class="number">209</span>                    abi, instructionSet, appDataDir, invokeWith, zygoteArgs);</span><br><span class="line"><span class="number">210</span>        &#125; <span class="keyword">catch</span> (ZygoteStartFailedEx ex) &#123;</span><br><span class="line"><span class="number">211</span>            Log.e(LOG_TAG,</span><br><span class="line"><span class="number">212</span>                    <span class="string">"Starting VM process through Zygote failed"</span>);</span><br><span class="line"><span class="number">213</span>            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line"><span class="number">214</span>                    <span class="string">"Starting VM process through Zygote failed"</span>, ex);</span><br><span class="line"><span class="number">215</span>        &#125;</span><br><span class="line"><span class="number">216</span>    &#125;</span><br></pre></td></tr></table></figure></p>
<p>对应方法太长于是就截取最关键的代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">synchronized</span>(mLock) &#123;</span><br><span class="line"><span class="number">431</span>            <span class="keyword">return</span> zygoteSendArgsAndGetResult(openZygoteSocketIfNeeded(abi), argsForZygote);</span><br><span class="line"><span class="number">432</span>        &#125;</span><br></pre></td></tr></table></figure></p>
<p>这最终调用了zygote并通过socket通信的方式让那个zygote进程fork出一个新的进程，并根据我们刚刚传递的“android.app.ActivityTHread”字符串，发射出该对象并执行activitythread的main方法。<br>应用进程被产创建之后，首先执行的是ActivityThead的main方法。<br>main方法中<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ActivityThread thread = <span class="keyword">new</span> ActivityThread();</span><br><span class="line">thread.attach(<span class="keyword">false</span>);</span><br></pre></td></tr></table></figure></p>
<p>attach方法又调用了<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> IActivityManager mgr = ActivityManagerNative.getDefault();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">mgr.attachApplication(mAppThread);</span><br><span class="line">&#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line"><span class="keyword">throw</span> ex.rethrowFromSystemServer();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>于是又回到了ActivityManagerService中<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="number">7021</span>    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">attachApplication</span><span class="params">(IApplicationThread thread)</span> </span>&#123;</span><br><span class="line"><span class="number">7022</span>        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line"><span class="number">7023</span>            <span class="keyword">int</span> callingPid = Binder.getCallingPid();</span><br><span class="line"><span class="number">7024</span>            <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</span><br><span class="line"><span class="number">7025</span>            attachApplicationLocked(thread, callingPid);</span><br><span class="line"><span class="number">7026</span>            Binder.restoreCallingIdentity(origId);</span><br><span class="line"><span class="number">7027</span>        &#125;</span><br><span class="line"><span class="number">7028</span>    &#125;</span><br><span class="line"><span class="number">7029</span></span><br></pre></td></tr></table></figure></p>
<p>最终调用到<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">app.thread.scheduleLaunchActivity(<span class="keyword">new</span> Intent(r.intent), r.appToken,</span><br><span class="line"><span class="number">1468</span>                    System.identityHashCode(r), r.info,</span><br><span class="line"><span class="number">1469</span>                    <span class="comment">// <span class="doctag">TODO:</span> Have this take the merged configuration instead of separate global and</span></span><br><span class="line"><span class="number">1470</span>                    <span class="comment">// override configs.</span></span><br><span class="line"><span class="number">1471</span>                    mergedConfiguration.getGlobalConfiguration(),</span><br><span class="line"><span class="number">1472</span>                    mergedConfiguration.getOverrideConfiguration(), r.compat,</span><br><span class="line"><span class="number">1473</span>                    r.launchedFromPackage, task.voiceInteractor, app.repProcState, r.icicle,</span><br><span class="line"><span class="number">1474</span>                    r.persistentState, results, newIntents, !andResume,</span><br><span class="line"><span class="number">1475</span>                    mService.isNextTransitionForward(), profilerInfo);</span><br></pre></td></tr></table></figure></p>
<p>与onPause类似，这里也是通过IApplicationThread的方法实现的，这里调用的scheduleLaunchActivity方法最终调用的是ActivityThread中的 <strong>scheduleLaunchActivity方法</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">scheduleLaunchActivity</span><span class="params">(Intent intent, IBinder token, <span class="keyword">int</span> ident,</span></span></span><br><span class="line"><span class="function"><span class="params">ActivityInfo info, Configuration curConfig, Configuration overrideConfig,</span></span></span><br><span class="line"><span class="function"><span class="params">CompatibilityInfo compatInfo, String referrer, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="keyword">int</span> procState, Bundle state, PersistableBundle persistentState,</span></span></span><br><span class="line"><span class="function"><span class="params">List&lt;ResultInfo&gt; pendingResults, List&lt;ReferrerIntent&gt; pendingNewIntents,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="keyword">boolean</span> notResumed, <span class="keyword">boolean</span> isForward, ProfilerInfo profilerInfo)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">updateProcessState(procState, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">ActivityClientRecord r = <span class="keyword">new</span> ActivityClientRecord();</span><br><span class="line"></span><br><span class="line">r.token = token;</span><br><span class="line">r.ident = ident;</span><br><span class="line">r.intent = intent;</span><br><span class="line">r.referrer = referrer;</span><br><span class="line">r.voiceInteractor = voiceInteractor;</span><br><span class="line">r.activityInfo = info;</span><br><span class="line">r.compatInfo = compatInfo;</span><br><span class="line">r.state = state;</span><br><span class="line">r.persistentState = persistentState;</span><br><span class="line"></span><br><span class="line">r.pendingResults = pendingResults;</span><br><span class="line">r.pendingIntents = pendingNewIntents;</span><br><span class="line"></span><br><span class="line">r.startsNotResumed = notResumed;</span><br><span class="line">r.isForward = isForward;</span><br><span class="line"></span><br><span class="line">r.profilerInfo = profilerInfo;</span><br><span class="line"></span><br><span class="line">r.overrideConfig = overrideConfig;</span><br><span class="line">updatePendingConfiguration(curConfig);</span><br><span class="line"></span><br><span class="line">sendMessage(H.LAUNCH_ACTIVITY, r);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>同样的到了H中的handleMessage：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> LAUNCH_ACTIVITY: &#123;</span><br><span class="line">Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"activityStart"</span>);</span><br><span class="line"><span class="keyword">final</span> ActivityClientRecord r = (ActivityClientRecord) msg.obj;</span><br><span class="line"></span><br><span class="line">r.packageInfo = getPackageInfoNoCheck(</span><br><span class="line">r.activityInfo.applicationInfo, r.compatInfo);</span><br><span class="line">handleLaunchActivity(r, <span class="keyword">null</span>, <span class="string">"LAUNCH_ACTIVITY"</span>);</span><br><span class="line">Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">&#125; <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure></p>
<p>然后我们去看handleLaunchActivity，其中又调用了<br>Activity a = performLaunchActivity(r, customIntent);</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Activity <span class="title">performLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> </span>&#123;</span><br><span class="line"><span class="comment">// System.out.println("##### [" + System.currentTimeMillis() + "] ActivityThread.performLaunchActivity(" + r + ")");</span></span><br><span class="line"></span><br><span class="line">ActivityInfo aInfo = r.activityInfo;</span><br><span class="line"><span class="keyword">if</span> (r.packageInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">r.packageInfo = getPackageInfo(aInfo.applicationInfo, r.compatInfo,</span><br><span class="line">Context.CONTEXT_INCLUDE_CODE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ComponentName component = r.intent.getComponent();</span><br><span class="line"><span class="keyword">if</span> (component == <span class="keyword">null</span>) &#123;</span><br><span class="line">component = r.intent.resolveActivity(</span><br><span class="line">mInitialApplication.getPackageManager());</span><br><span class="line">r.intent.setComponent(component);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (r.activityInfo.targetActivity != <span class="keyword">null</span>) &#123;</span><br><span class="line">component = <span class="keyword">new</span> ComponentName(r.activityInfo.packageName,</span><br><span class="line">r.activityInfo.targetActivity);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Activity activity = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">java.lang.ClassLoader cl = r.packageInfo.getClassLoader();</span><br><span class="line">activity = mInstrumentation.newActivity(</span><br><span class="line">cl, component.getClassName(), r.intent);</span><br><span class="line">StrictMode.incrementExpectedActivityCount(activity.getClass());</span><br><span class="line">r.intent.setExtrasClassLoader(cl);</span><br><span class="line">r.intent.prepareToEnterProcess();</span><br><span class="line"><span class="keyword">if</span> (r.state != <span class="keyword">null</span>) &#123;</span><br><span class="line">r.state.setClassLoader(cl);</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"><span class="keyword">if</span> (!mInstrumentation.onException(activity, e)) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line"><span class="string">"Unable to instantiate activity "</span> + component</span><br><span class="line">+ <span class="string">": "</span> + e.toString(), e);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">Application app = r.packageInfo.makeApplication(<span class="keyword">false</span>, mInstrumentation);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (localLOGV) Slog.v(TAG, <span class="string">"Performing launch of "</span> + r);</span><br><span class="line"><span class="keyword">if</span> (localLOGV) Slog.v(</span><br><span class="line">TAG, r + <span class="string">": app="</span> + app</span><br><span class="line">+ <span class="string">", appName="</span> + app.getPackageName()</span><br><span class="line">+ <span class="string">", pkg="</span> + r.packageInfo.getPackageName()</span><br><span class="line">+ <span class="string">", comp="</span> + r.intent.getComponent().toShortString()</span><br><span class="line">+ <span class="string">", dir="</span> + r.packageInfo.getAppDir());</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (activity != <span class="keyword">null</span>) &#123;</span><br><span class="line">Context appContext = createBaseContextForActivity(r, activity);</span><br><span class="line">CharSequence title = r.activityInfo.loadLabel(appContext.getPackageManager());</span><br><span class="line">Configuration config = <span class="keyword">new</span> Configuration(mCompatConfiguration);</span><br><span class="line"><span class="keyword">if</span> (r.overrideConfig != <span class="keyword">null</span>) &#123;</span><br><span class="line">config.updateFrom(r.overrideConfig);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (DEBUG_CONFIGURATION) Slog.v(TAG, <span class="string">"Launching activity "</span></span><br><span class="line">+ r.activityInfo.name + <span class="string">" with config "</span> + config);</span><br><span class="line">Window window = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">if</span> (r.mPendingRemoveWindow != <span class="keyword">null</span> &amp;&amp; r.mPreserveWindow) &#123;</span><br><span class="line">window = r.mPendingRemoveWindow;</span><br><span class="line">r.mPendingRemoveWindow = <span class="keyword">null</span>;</span><br><span class="line">r.mPendingRemoveWindowManager = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line">activity.attach(appContext, <span class="keyword">this</span>, getInstrumentation(), r.token,</span><br><span class="line">r.ident, app, r.intent, r.activityInfo, title, r.parent,</span><br><span class="line">r.embeddedID, r.lastNonConfigurationInstances, config,</span><br><span class="line">r.referrer, r.voiceInteractor, window);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (customIntent != <span class="keyword">null</span>) &#123;</span><br><span class="line">activity.mIntent = customIntent;</span><br><span class="line">&#125;</span><br><span class="line">r.lastNonConfigurationInstances = <span class="keyword">null</span>;</span><br><span class="line">activity.mStartedActivity = <span class="keyword">false</span>;</span><br><span class="line"><span class="keyword">int</span> theme = r.activityInfo.getThemeResource();</span><br><span class="line"><span class="keyword">if</span> (theme != <span class="number">0</span>) &#123;</span><br><span class="line">activity.setTheme(theme);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">activity.mCalled = <span class="keyword">false</span>;</span><br><span class="line"><span class="keyword">if</span> (r.isPersistable()) &#123;</span><br><span class="line">mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">mInstrumentation.callActivityOnCreate(activity, r.state);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (!activity.mCalled) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> SuperNotCalledException(</span><br><span class="line"><span class="string">"Activity "</span> + r.intent.getComponent().toShortString() +</span><br><span class="line"><span class="string">" did not call through to super.onCreate()"</span>);</span><br><span class="line">&#125;</span><br><span class="line">r.activity = activity;</span><br><span class="line">r.stopped = <span class="keyword">true</span>;</span><br><span class="line"><span class="keyword">if</span> (!r.activity.mFinished) &#123;</span><br><span class="line">activity.performStart();</span><br><span class="line">r.stopped = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (!r.activity.mFinished) &#123;</span><br><span class="line"><span class="keyword">if</span> (r.isPersistable()) &#123;</span><br><span class="line"><span class="keyword">if</span> (r.state != <span class="keyword">null</span> || r.persistentState != <span class="keyword">null</span>) &#123;</span><br><span class="line">mInstrumentation.callActivityOnRestoreInstanceState(activity, r.state,</span><br><span class="line">r.persistentState);</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (r.state != <span class="keyword">null</span>) &#123;</span><br><span class="line">mInstrumentation.callActivityOnRestoreInstanceState(activity, r.state);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (!r.activity.mFinished) &#123;</span><br><span class="line">activity.mCalled = <span class="keyword">false</span>;</span><br><span class="line"><span class="keyword">if</span> (r.isPersistable()) &#123;</span><br><span class="line">mInstrumentation.callActivityOnPostCreate(activity, r.state,</span><br><span class="line">r.persistentState);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">mInstrumentation.callActivityOnPostCreate(activity, r.state);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (!activity.mCalled) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> SuperNotCalledException(</span><br><span class="line"><span class="string">"Activity "</span> + r.intent.getComponent().toShortString() +</span><br><span class="line"><span class="string">" did not call through to super.onPostCreate()"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">r.paused = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">mActivities.put(r.token, r);</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">catch</span> (SuperNotCalledException e) &#123;</span><br><span class="line"><span class="keyword">throw</span> e;</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"><span class="keyword">if</span> (!mInstrumentation.onException(activity, e)) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line"><span class="string">"Unable to start activity "</span> + component</span><br><span class="line">+ <span class="string">": "</span> + e.toString(), e);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> activity;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>mInstrumentation.newActivity通过反射方法创建了Activity，<br>最后调用了mInstrumentation.callActivityOnCreate方法<br>然后我们去Instrumentation中看：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callActivityOnCreate</span><span class="params">(Activity activity, Bundle icicle)</span> </span>&#123;</span><br><span class="line">prePerformCreate(activity);</span><br><span class="line">activity.performCreate(icicle);</span><br><span class="line">postPerformCreate(activity);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们去看Activity中的activity.performCreate(icicle);<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">performCreate</span><span class="params">(Bundle icicle)</span> </span>&#123;</span><br><span class="line">restoreHasCurrentPermissionRequest(icicle);</span><br><span class="line">onCreate(icicle);</span><br><span class="line">mActivityTransitionState.readState(icicle);</span><br><span class="line">performCreateCommon();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>好吧，总算看到了Activity的onCreate方法，<br>再去ActivityThread的performLaunchActivty中在调用了callActivityOnCreate方法后又调用了activity.performStart();方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!r.activity.mFinished) &#123;</span><br><span class="line">activity.performStart();</span><br><span class="line">r.stopped = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>去Activity类中看一眼对应的方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">performStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">mActivityTransitionState.setEnterActivityOptions(<span class="keyword">this</span>, getActivityOptions());</span><br><span class="line">mFragments.noteStateNotSaved();</span><br><span class="line">mCalled = <span class="keyword">false</span>;</span><br><span class="line">mFragments.execPendingActions();</span><br><span class="line">mInstrumentation.callActivityOnStart(<span class="keyword">this</span>);</span><br><span class="line"><span class="keyword">if</span> (!mCalled) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> SuperNotCalledException(</span><br><span class="line"><span class="string">"Activity "</span> + mComponent.toShortString() +</span><br><span class="line"><span class="string">" did not call through to super.onStart()"</span>);</span><br><span class="line">&#125;</span><br><span class="line">mFragments.dispatchStart();</span><br><span class="line">mFragments.reportLoaderStart();</span><br><span class="line"></span><br><span class="line"><span class="comment">// This property is set for all builds except final release</span></span><br><span class="line"><span class="keyword">boolean</span> isDlwarningEnabled = SystemProperties.getInt(<span class="string">"ro.bionic.ld.warning"</span>, <span class="number">0</span>) == <span class="number">1</span>;</span><br><span class="line"><span class="keyword">boolean</span> isAppDebuggable =</span><br><span class="line">(mApplication.getApplicationInfo().flags &amp; ApplicationInfo.FLAG_DEBUGGABLE) != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (isAppDebuggable || isDlwarningEnabled) &#123;</span><br><span class="line">String dlwarning = getDlWarning();</span><br><span class="line"><span class="keyword">if</span> (dlwarning != <span class="keyword">null</span>) &#123;</span><br><span class="line">String appName = getApplicationInfo().loadLabel(getPackageManager())</span><br><span class="line">.toString();</span><br><span class="line">String warning = <span class="string">"Detected problems with app native libraries\n"</span> +</span><br><span class="line"><span class="string">"(please consult log for detail):\n"</span> + dlwarning;</span><br><span class="line"><span class="keyword">if</span> (isAppDebuggable) &#123;</span><br><span class="line"><span class="keyword">new</span> AlertDialog.Builder(<span class="keyword">this</span>).</span><br><span class="line">setTitle(appName).</span><br><span class="line">setMessage(warning).</span><br><span class="line">setPositiveButton(android.R.string.ok, <span class="keyword">null</span>).</span><br><span class="line">setCancelable(<span class="keyword">false</span>).</span><br><span class="line">show();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">Toast.makeText(<span class="keyword">this</span>, appName + <span class="string">"\n"</span> + warning, Toast.LENGTH_LONG).show();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mActivityTransitionState.enterReady(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>看到了mInstrumentation.callActivityOnStart(this);<br>看一眼这个方法做了什么：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callActivityOnStart</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">activity.onStart();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>尼玛，这么久终于等到onstart方法了。<br>然后我们再回到ActivityThread中的handleLaunchActivty中看到PerformLaynchActivty方法之后调用了<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">handleResumeActivity(r.token, <span class="keyword">false</span>, r.isForward,</span><br><span class="line">!r.activity.mFinished &amp;&amp; !r.startsNotResumed, r.lastProcessedSeq, reason);</span><br></pre></td></tr></table></figure></p>
<p>然后就是调用r = performResumeActivity(token, clearHide, reason);<br>然后再调用 r.activity.performResume();<br>这个方法在Activity中，于是又跑到activty类中：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">performResume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">performRestart();</span><br><span class="line"></span><br><span class="line">mFragments.execPendingActions();</span><br><span class="line"></span><br><span class="line">mLastNonConfigurationInstances = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">mCalled = <span class="keyword">false</span>;</span><br><span class="line"><span class="comment">// mResumed is set by the instrumentation</span></span><br><span class="line">mInstrumentation.callActivityOnResume(<span class="keyword">this</span>);</span><br><span class="line"><span class="keyword">if</span> (!mCalled) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> SuperNotCalledException(</span><br><span class="line"><span class="string">"Activity "</span> + mComponent.toShortString() +</span><br><span class="line"><span class="string">" did not call through to super.onResume()"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// invisible activities must be finished before onResume() completes</span></span><br><span class="line"><span class="keyword">if</span> (!mVisibleFromClient &amp;&amp; !mFinished) &#123;</span><br><span class="line">Log.w(TAG, <span class="string">"An activity without a UI must call finish() before onResume() completes"</span>);</span><br><span class="line"><span class="keyword">if</span> (getApplicationInfo().targetSdkVersion</span><br><span class="line">&gt; android.os.Build.VERSION_CODES.LOLLIPOP_MR1) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line"><span class="string">"Activity "</span> + mComponent.toShortString() +</span><br><span class="line"><span class="string">" did not call finish() prior to onResume() completing"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Now really resume, and install the current status bar and menu.</span></span><br><span class="line">mCalled = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">mFragments.dispatchResume();</span><br><span class="line">mFragments.execPendingActions();</span><br><span class="line"></span><br><span class="line">onPostResume();</span><br><span class="line"><span class="keyword">if</span> (!mCalled) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> SuperNotCalledException(</span><br><span class="line"><span class="string">"Activity "</span> + mComponent.toShortString() +</span><br><span class="line"><span class="string">" did not call through to super.onPostResume()"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>又看到了mInstrumentation.callActivityOnResume(this);</p>
<p>去Instrumentation中看对应的方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callActivityOnResume</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">activity.mResumed = <span class="keyword">true</span>;</span><br><span class="line">activity.onResume();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (mActivityMonitors != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="keyword">synchronized</span> (mSync) &#123;</span><br><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> N = mActivityMonitors.size();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line"><span class="keyword">final</span> ActivityMonitor am = mActivityMonitors.get(i);</span><br><span class="line">am.match(activity, activity, activity.getIntent());</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>看到了activity.onResume();</p>
<p>至此，一个activty的启动过程完成。<br>下面就是另一个activty的onstop过程：<br>在ActivityThread中的handleresumeActivty中：<br>有这样一段代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!r.onlyLocalRequest) &#123;</span><br><span class="line">r.nextIdle = mNewActivities;</span><br><span class="line">mNewActivities = r;</span><br><span class="line"><span class="keyword">if</span> (localLOGV) Slog.v(</span><br><span class="line">TAG, <span class="string">"Scheduling idle handler for "</span> + r);</span><br><span class="line">Looper.myQueue().addIdleHandler(<span class="keyword">new</span> Idler());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>先把这段代码贴出来：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">Idler</span> <span class="keyword">implements</span> <span class="title">MessageQueue</span>.<span class="title">IdleHandler</span> </span>&#123;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">queueIdle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">ActivityClientRecord a = mNewActivities;</span><br><span class="line"><span class="keyword">boolean</span> stopProfiling = <span class="keyword">false</span>;</span><br><span class="line"><span class="keyword">if</span> (mBoundApplication != <span class="keyword">null</span> &amp;&amp; mProfiler.profileFd != <span class="keyword">null</span></span><br><span class="line">&amp;&amp; mProfiler.autoStopProfiler) &#123;</span><br><span class="line">stopProfiling = <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (a != <span class="keyword">null</span>) &#123;</span><br><span class="line">mNewActivities = <span class="keyword">null</span>;</span><br><span class="line">IActivityManager am = ActivityManagerNative.getDefault();</span><br><span class="line">ActivityClientRecord prev;</span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (localLOGV) Slog.v(</span><br><span class="line">TAG, <span class="string">"Reporting idle of "</span> + a +</span><br><span class="line"><span class="string">" finished="</span> +</span><br><span class="line">(a.activity != <span class="keyword">null</span> &amp;&amp; a.activity.mFinished));</span><br><span class="line"><span class="keyword">if</span> (a.activity != <span class="keyword">null</span> &amp;&amp; !a.activity.mFinished) &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">am.activityIdle(a.token, a.createdConfig, stopProfiling);</span><br><span class="line">a.createdConfig = <span class="keyword">null</span>;</span><br><span class="line">&#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line"><span class="keyword">throw</span> ex.rethrowFromSystemServer();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">prev = a;</span><br><span class="line">a = a.nextIdle;</span><br><span class="line">prev.nextIdle = <span class="keyword">null</span>;</span><br><span class="line">&#125; <span class="keyword">while</span> (a != <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (stopProfiling) &#123;</span><br><span class="line">mProfiler.stopProfiling();</span><br><span class="line">&#125;</span><br><span class="line">ensureJitEnabled();</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>看到其中调用了am.activityIdle(a.token, a.createdConfig, stopProfiling);</p>
<p>按照Binder机制，这段代码执行在ActivityManagerService中，<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="number">7031</span>    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">activityIdle</span><span class="params">(IBinder token, Configuration config, <span class="keyword">boolean</span> stopProfiling)</span> </span>&#123;</span><br><span class="line"><span class="number">7032</span>        <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</span><br><span class="line"><span class="number">7033</span>        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line"><span class="number">7034</span>            ActivityStack stack = ActivityRecord.getStackLocked(token);</span><br><span class="line"><span class="number">7035</span>            <span class="keyword">if</span> (stack != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">7036</span>                ActivityRecord r =</span><br><span class="line"><span class="number">7037</span>                        mStackSupervisor.activityIdleInternalLocked(token, <span class="keyword">false</span> <span class="comment">/* fromTimeout */</span>,</span><br><span class="line"><span class="number">7038</span>                                <span class="keyword">false</span> <span class="comment">/* processPausingActivities */</span>, config);</span><br><span class="line"><span class="number">7039</span>                <span class="keyword">if</span> (stopProfiling) &#123;</span><br><span class="line"><span class="number">7040</span>                    <span class="keyword">if</span> ((mProfileProc == r.app) &amp;&amp; (mProfileFd != <span class="keyword">null</span>)) &#123;</span><br><span class="line"><span class="number">7041</span>                        <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="number">7042</span>                            mProfileFd.close();</span><br><span class="line"><span class="number">7043</span>                        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line"><span class="number">7044</span>                        &#125;</span><br><span class="line"><span class="number">7045</span>                        clearProfilerLocked();</span><br><span class="line"><span class="number">7046</span>                    &#125;</span><br><span class="line"><span class="number">7047</span>                &#125;</span><br><span class="line"><span class="number">7048</span>            &#125;</span><br><span class="line"><span class="number">7049</span>        &#125;</span><br><span class="line"><span class="number">7050</span>        Binder.restoreCallingIdentity(origId);</span><br><span class="line"><span class="number">7051</span>    &#125;</span><br></pre></td></tr></table></figure></p>
<p>这其中有一段代码：mStackSupervisor.activityIdleInternalLocked<br>先贴下这个方法的代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> ActivityRecord <span class="title">activityIdleInternalLocked</span><span class="params">(<span class="keyword">final</span> IBinder token, <span class="keyword">boolean</span> fromTimeout,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">1855</span>            <span class="keyword">boolean</span> processPausingActivities, Configuration config)</span> </span>&#123;</span><br><span class="line"><span class="number">1856</span>        <span class="keyword">if</span> (DEBUG_ALL) Slog.v(TAG, <span class="string">"Activity idle: "</span> + token);</span><br><span class="line"><span class="number">1857</span></span><br><span class="line"><span class="number">1858</span>        ArrayList&lt;ActivityRecord&gt; finishes = <span class="keyword">null</span>;</span><br><span class="line"><span class="number">1859</span>        ArrayList&lt;UserState&gt; startingUsers = <span class="keyword">null</span>;</span><br><span class="line"><span class="number">1860</span>        <span class="keyword">int</span> NS = <span class="number">0</span>;</span><br><span class="line"><span class="number">1861</span>        <span class="keyword">int</span> NF = <span class="number">0</span>;</span><br><span class="line"><span class="number">1862</span>        <span class="keyword">boolean</span> booting = <span class="keyword">false</span>;</span><br><span class="line"><span class="number">1863</span>        <span class="keyword">boolean</span> activityRemoved = <span class="keyword">false</span>;</span><br><span class="line"><span class="number">1864</span></span><br><span class="line"><span class="number">1865</span>        ActivityRecord r = ActivityRecord.forTokenLocked(token);</span><br><span class="line"><span class="number">1866</span>        <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">1867</span>            <span class="keyword">if</span> (DEBUG_IDLE) Slog.d(TAG_IDLE, <span class="string">"activityIdleInternalLocked: Callers="</span></span><br><span class="line"><span class="number">1868</span>                    + Debug.getCallers(<span class="number">4</span>));</span><br><span class="line"><span class="number">1869</span>            mHandler.removeMessages(IDLE_TIMEOUT_MSG, r);</span><br><span class="line"><span class="number">1870</span>            r.finishLaunchTickingLocked();</span><br><span class="line"><span class="number">1871</span>            <span class="keyword">if</span> (fromTimeout) &#123;</span><br><span class="line"><span class="number">1872</span>                reportActivityLaunchedLocked(fromTimeout, r, -<span class="number">1</span>, -<span class="number">1</span>);</span><br><span class="line"><span class="number">1873</span>            &#125;</span><br><span class="line"><span class="number">1874</span></span><br><span class="line"><span class="number">1875</span>            <span class="comment">// This is a hack to semi-deal with a race condition</span></span><br><span class="line"><span class="number">1876</span>            <span class="comment">// in the client where it can be constructed with a</span></span><br><span class="line"><span class="number">1877</span>            <span class="comment">// newer configuration from when we asked it to launch.</span></span><br><span class="line"><span class="number">1878</span>            <span class="comment">// We'll update with whatever configuration it now says</span></span><br><span class="line"><span class="number">1879</span>            <span class="comment">// it used to launch.</span></span><br><span class="line"><span class="number">1880</span>            <span class="keyword">if</span> (config != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">1881</span>                r.setLastReportedGlobalConfiguration(config);</span><br><span class="line"><span class="number">1882</span>            &#125;</span><br><span class="line"><span class="number">1883</span></span><br><span class="line"><span class="number">1884</span>            <span class="comment">// We are now idle.  If someone is waiting for a thumbnail from</span></span><br><span class="line"><span class="number">1885</span>            <span class="comment">// us, we can now deliver.</span></span><br><span class="line"><span class="number">1886</span>            r.idle = <span class="keyword">true</span>;</span><br><span class="line"><span class="number">1887</span></span><br><span class="line"><span class="number">1888</span>            <span class="comment">//Slog.i(TAG, "IDLE: mBooted=" + mBooted + ", fromTimeout=" + fromTimeout);</span></span><br><span class="line"><span class="number">1889</span>            <span class="keyword">if</span> (isFocusedStack(r.getStack()) || fromTimeout) &#123;</span><br><span class="line"><span class="number">1890</span>                booting = checkFinishBootingLocked();</span><br><span class="line"><span class="number">1891</span>            &#125;</span><br><span class="line"><span class="number">1892</span>        &#125;</span><br><span class="line"><span class="number">1893</span></span><br><span class="line"><span class="number">1894</span>        <span class="keyword">if</span> (allResumedActivitiesIdle()) &#123;</span><br><span class="line"><span class="number">1895</span>            <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">1896</span>                mService.scheduleAppGcsLocked();</span><br><span class="line"><span class="number">1897</span>            &#125;</span><br><span class="line"><span class="number">1898</span></span><br><span class="line"><span class="number">1899</span>            <span class="keyword">if</span> (mLaunchingActivity.isHeld()) &#123;</span><br><span class="line"><span class="number">1900</span>                mHandler.removeMessages(LAUNCH_TIMEOUT_MSG);</span><br><span class="line"><span class="number">1901</span>                <span class="keyword">if</span> (VALIDATE_WAKE_LOCK_CALLER &amp;&amp;</span><br><span class="line"><span class="number">1902</span>                        Binder.getCallingUid() != Process.myUid()) &#123;</span><br><span class="line"><span class="number">1903</span>                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Calling must be system uid"</span>);</span><br><span class="line"><span class="number">1904</span>                &#125;</span><br><span class="line"><span class="number">1905</span>                mLaunchingActivity.release();</span><br><span class="line"><span class="number">1906</span>            &#125;</span><br><span class="line"><span class="number">1907</span>            ensureActivitiesVisibleLocked(<span class="keyword">null</span>, <span class="number">0</span>, !PRESERVE_WINDOWS);</span><br><span class="line"><span class="number">1908</span>        &#125;</span><br><span class="line"><span class="number">1909</span></span><br><span class="line"><span class="number">1910</span>        <span class="comment">// Atomically retrieve all of the other things to do.</span></span><br><span class="line"><span class="number">1911</span>        <span class="keyword">final</span> ArrayList&lt;ActivityRecord&gt; stops = processStoppingActivitiesLocked(r,</span><br><span class="line"><span class="number">1912</span>                <span class="keyword">true</span> <span class="comment">/* remove */</span>, processPausingActivities);</span><br><span class="line"><span class="number">1913</span>        NS = stops != <span class="keyword">null</span> ? stops.size() : <span class="number">0</span>;</span><br><span class="line"><span class="number">1914</span>        <span class="keyword">if</span> ((NF = mFinishingActivities.size()) &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">1915</span>            finishes = <span class="keyword">new</span> ArrayList&lt;&gt;(mFinishingActivities);</span><br><span class="line"><span class="number">1916</span>            mFinishingActivities.clear();</span><br><span class="line"><span class="number">1917</span>        &#125;</span><br><span class="line"><span class="number">1918</span></span><br><span class="line"><span class="number">1919</span>        <span class="keyword">if</span> (mStartingUsers.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">1920</span>            startingUsers = <span class="keyword">new</span> ArrayList&lt;&gt;(mStartingUsers);</span><br><span class="line"><span class="number">1921</span>            mStartingUsers.clear();</span><br><span class="line"><span class="number">1922</span>        &#125;</span><br><span class="line"><span class="number">1923</span></span><br><span class="line"><span class="number">1924</span>        <span class="comment">// Stop any activities that are scheduled to do so but have been</span></span><br><span class="line"><span class="number">1925</span>        <span class="comment">// waiting for the next one to start.</span></span><br><span class="line"><span class="number">1926</span>        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NS; i++) &#123;</span><br><span class="line"><span class="number">1927</span>            r = stops.get(i);</span><br><span class="line"><span class="number">1928</span>            <span class="keyword">final</span> ActivityStack stack = r.getStack();</span><br><span class="line"><span class="number">1929</span>            <span class="keyword">if</span> (stack != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">1930</span>                <span class="keyword">if</span> (r.finishing) &#123;</span><br><span class="line"><span class="number">1931</span>                    stack.finishCurrentActivityLocked(r, ActivityStack.FINISH_IMMEDIATELY, <span class="keyword">false</span>);</span><br><span class="line"><span class="number">1932</span>                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="number">1933</span>                    stack.stopActivityLocked(r);</span><br><span class="line"><span class="number">1934</span>                &#125;</span><br><span class="line"><span class="number">1935</span>            &#125;</span><br><span class="line"><span class="number">1936</span>        &#125;</span><br><span class="line"><span class="number">1937</span></span><br><span class="line"><span class="number">1938</span>        <span class="comment">// Finish any activities that are scheduled to do so but have been</span></span><br><span class="line"><span class="number">1939</span>        <span class="comment">// waiting for the next one to start.</span></span><br><span class="line"><span class="number">1940</span>        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NF; i++) &#123;</span><br><span class="line"><span class="number">1941</span>            r = finishes.get(i);</span><br><span class="line"><span class="number">1942</span>            <span class="keyword">final</span> ActivityStack stack = r.getStack();</span><br><span class="line"><span class="number">1943</span>            <span class="keyword">if</span> (stack != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">1944</span>                activityRemoved |= stack.destroyActivityLocked(r, <span class="keyword">true</span>, <span class="string">"finish-idle"</span>);</span><br><span class="line"><span class="number">1945</span>            &#125;</span><br><span class="line"><span class="number">1946</span>        &#125;</span><br><span class="line"><span class="number">1947</span></span><br><span class="line"><span class="number">1948</span>        <span class="keyword">if</span> (!booting) &#123;</span><br><span class="line"><span class="number">1949</span>            <span class="comment">// Complete user switch</span></span><br><span class="line"><span class="number">1950</span>            <span class="keyword">if</span> (startingUsers != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">1951</span>                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; startingUsers.size(); i++) &#123;</span><br><span class="line"><span class="number">1952</span>                    mService.mUserController.finishUserSwitch(startingUsers.get(i));</span><br><span class="line"><span class="number">1953</span>                &#125;</span><br><span class="line"><span class="number">1954</span>            &#125;</span><br><span class="line"><span class="number">1955</span>        &#125;</span><br><span class="line"><span class="number">1956</span></span><br><span class="line"><span class="number">1957</span>        mService.trimApplications();</span><br><span class="line"><span class="number">1958</span>        <span class="comment">//dump();</span></span><br><span class="line"><span class="number">1959</span>        <span class="comment">//mWindowManager.dump();</span></span><br><span class="line"><span class="number">1960</span></span><br><span class="line"><span class="number">1961</span>        <span class="keyword">if</span> (activityRemoved) &#123;</span><br><span class="line"><span class="number">1962</span>            resumeFocusedStackTopActivityLocked();</span><br><span class="line"><span class="number">1963</span>        &#125;</span><br><span class="line"><span class="number">1964</span></span><br><span class="line"><span class="number">1965</span>        <span class="keyword">return</span> r;</span><br><span class="line"><span class="number">1966</span>    &#125;</span><br></pre></td></tr></table></figure></p>
<p>在这其中，又调用了 stack.stopActivityLocked(r);<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">stopActivityLocked</span><span class="params">(ActivityRecord r)</span> </span>&#123;</span><br><span class="line"><span class="number">3389</span>        <span class="keyword">if</span> (DEBUG_SWITCH) Slog.d(TAG_SWITCH, <span class="string">"Stopping: "</span> + r);</span><br><span class="line"><span class="number">3390</span>        <span class="keyword">if</span> ((r.intent.getFlags()&amp;Intent.FLAG_ACTIVITY_NO_HISTORY) != <span class="number">0</span></span><br><span class="line"><span class="number">3391</span>                || (r.info.flags&amp;ActivityInfo.FLAG_NO_HISTORY) != <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">3392</span>            <span class="keyword">if</span> (!r.finishing) &#123;</span><br><span class="line"><span class="number">3393</span>                <span class="keyword">if</span> (!mService.isSleepingLocked()) &#123;</span><br><span class="line"><span class="number">3394</span>                    <span class="keyword">if</span> (DEBUG_STATES) Slog.d(TAG_STATES, <span class="string">"no-history finish of "</span> + r);</span><br><span class="line"><span class="number">3395</span>                    <span class="keyword">if</span> (requestFinishActivityLocked(r.appToken, Activity.RESULT_CANCELED, <span class="keyword">null</span>,</span><br><span class="line"><span class="number">3396</span>                            <span class="string">"stop-no-history"</span>, <span class="keyword">false</span>)) &#123;</span><br><span class="line"><span class="number">3397</span>                        <span class="comment">// If &#123;@link requestFinishActivityLocked&#125; returns &#123;@code true&#125;,</span></span><br><span class="line"><span class="number">3398</span>                        <span class="comment">// &#123;@link adjustFocusedActivityStackLocked&#125; would have been already called.</span></span><br><span class="line"><span class="number">3399</span>                        r.resumeKeyDispatchingLocked();</span><br><span class="line"><span class="number">3400</span>                        <span class="keyword">return</span>;</span><br><span class="line"><span class="number">3401</span>                    &#125;</span><br><span class="line"><span class="number">3402</span>                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="number">3403</span>                    <span class="keyword">if</span> (DEBUG_STATES) Slog.d(TAG_STATES, <span class="string">"Not finishing noHistory "</span> + r</span><br><span class="line"><span class="number">3404</span>                            + <span class="string">" on stop because we're just sleeping"</span>);</span><br><span class="line"><span class="number">3405</span>                &#125;</span><br><span class="line"><span class="number">3406</span>            &#125;</span><br><span class="line"><span class="number">3407</span>        &#125;</span><br><span class="line"><span class="number">3408</span></span><br><span class="line"><span class="number">3409</span>        <span class="keyword">if</span> (r.app != <span class="keyword">null</span> &amp;&amp; r.app.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">3410</span>            adjustFocusedActivityStackLocked(r, <span class="string">"stopActivity"</span>);</span><br><span class="line"><span class="number">3411</span>            r.resumeKeyDispatchingLocked();</span><br><span class="line"><span class="number">3412</span>            <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="number">3413</span>                r.stopped = <span class="keyword">false</span>;</span><br><span class="line"><span class="number">3414</span>                <span class="keyword">if</span> (DEBUG_STATES) Slog.v(TAG_STATES,</span><br><span class="line"><span class="number">3415</span>                        <span class="string">"Moving to STOPPING: "</span> + r + <span class="string">" (stop requested)"</span>);</span><br><span class="line"><span class="number">3416</span>                r.state = STOPPING;</span><br><span class="line"><span class="number">3417</span>                <span class="keyword">if</span> (DEBUG_VISIBILITY) Slog.v(TAG_VISIBILITY,</span><br><span class="line"><span class="number">3418</span>                        <span class="string">"Stopping visible="</span> + r.visible + <span class="string">" for "</span> + r);</span><br><span class="line"><span class="number">3419</span>                <span class="keyword">if</span> (!r.visible) &#123;</span><br><span class="line"><span class="number">3420</span>                    r.setVisible(<span class="keyword">false</span>);</span><br><span class="line"><span class="number">3421</span>                &#125;</span><br><span class="line"><span class="number">3422</span>                EventLogTags.writeAmStopActivity(</span><br><span class="line"><span class="number">3423</span>                        r.userId, System.identityHashCode(r), r.shortComponentName);</span><br><span class="line"><span class="number">3424</span>                r.app.thread.scheduleStopActivity(r.appToken, r.visible, r.configChangeFlags);</span><br><span class="line"><span class="number">3425</span>                <span class="keyword">if</span> (mService.isSleepingOrShuttingDownLocked()) &#123;</span><br><span class="line"><span class="number">3426</span>                    r.setSleeping(<span class="keyword">true</span>);</span><br><span class="line"><span class="number">3427</span>                &#125;</span><br><span class="line"><span class="number">3428</span>                Message msg = mHandler.obtainMessage(STOP_TIMEOUT_MSG, r);</span><br><span class="line"><span class="number">3429</span>                mHandler.sendMessageDelayed(msg, STOP_TIMEOUT);</span><br><span class="line"><span class="number">3430</span>            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"><span class="number">3431</span>                <span class="comment">// Maybe just ignore exceptions here...  if the process</span></span><br><span class="line"><span class="number">3432</span>                <span class="comment">// has crashed, our death notification will clean things</span></span><br><span class="line"><span class="number">3433</span>                <span class="comment">// up.</span></span><br><span class="line"><span class="number">3434</span>                Slog.w(TAG, <span class="string">"Exception thrown during pause"</span>, e);</span><br><span class="line"><span class="number">3435</span>                <span class="comment">// Just in case, assume it to be stopped.</span></span><br><span class="line"><span class="number">3436</span>                r.stopped = <span class="keyword">true</span>;</span><br><span class="line"><span class="number">3437</span>                <span class="keyword">if</span> (DEBUG_STATES) Slog.v(TAG_STATES, <span class="string">"Stop failed; moving to STOPPED: "</span> + r);</span><br><span class="line"><span class="number">3438</span>                r.state = STOPPED;</span><br><span class="line"><span class="number">3439</span>                <span class="keyword">if</span> (r.deferRelaunchUntilPaused) &#123;</span><br><span class="line"><span class="number">3440</span>                    destroyActivityLocked(r, <span class="keyword">true</span>, <span class="string">"stop-except"</span>);</span><br><span class="line"><span class="number">3441</span>                &#125;</span><br><span class="line"><span class="number">3442</span>            &#125;</span><br><span class="line"><span class="number">3443</span>        &#125;</span><br><span class="line"><span class="number">3444</span>    &#125;</span><br></pre></td></tr></table></figure></p>
<p>r.app.thread.scheduleStopActivity这个熟悉吧，这个肯定又是去ActivityThread中，还是Binder机制，<br>于是又回到ActivityThread中：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">scheduleStopActivity</span><span class="params">(IBinder token, <span class="keyword">boolean</span> showWindow,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="keyword">int</span> configChanges)</span> </span>&#123;</span><br><span class="line"><span class="keyword">int</span> seq = getLifecycleSeq();</span><br><span class="line"><span class="keyword">if</span> (DEBUG_ORDER) Slog.d(TAG, <span class="string">"stopActivity "</span> + ActivityThread.<span class="keyword">this</span></span><br><span class="line">+ <span class="string">" operation received seq: "</span> + seq);</span><br><span class="line">sendMessage(</span><br><span class="line">showWindow ? H.STOP_ACTIVITY_SHOW : H.STOP_ACTIVITY_HIDE,</span><br><span class="line">token, <span class="number">0</span>, configChanges, seq);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>还是去H中看对应的case：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> STOP_ACTIVITY_SHOW: &#123;</span><br><span class="line">Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"activityStop"</span>);</span><br><span class="line">SomeArgs args = (SomeArgs) msg.obj;</span><br><span class="line">handleStopActivity((IBinder) args.arg1, <span class="keyword">true</span>, args.argi2, args.argi3);</span><br><span class="line">Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">&#125; <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure></p>
<p>再追踪，发现handleStopActivty中又调用了performStopActivityInner(r, info, show, true, “handleStopActivity”);<br>然后对应的有看到r.activity.performStop(false /<em>preserveWindow</em>/);<br>回到Activty中：<br>又调用了mInstrumentation.callActivityOnStop(this);<br>贴代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callActivityOnStop</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">activity.onStop();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>激动不，终于调用到了onstop方法。<br>值得注意的是在 r.activity.performStop();之前调用了callCallActivityOnSaveInstanceState(r);</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">callCallActivityOnSaveInstanceState</span><span class="params">(ActivityClientRecord r)</span> </span>&#123;</span><br><span class="line">r.state = <span class="keyword">new</span> Bundle();</span><br><span class="line">r.state.setAllowFds(<span class="keyword">false</span>);</span><br><span class="line"><span class="keyword">if</span> (r.isPersistable()) &#123;</span><br><span class="line">r.persistentState = <span class="keyword">new</span> PersistableBundle();</span><br><span class="line">mInstrumentation.callActivityOnSaveInstanceState(r.activity, r.state,</span><br><span class="line">r.persistentState);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">mInstrumentation.callActivityOnSaveInstanceState(r.activity, r.state);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后又调用到了mInstrumentation.callActivityOnSaveInstanceState<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callActivityOnSaveInstanceState</span><span class="params">(Activity activity, Bundle outState,</span></span></span><br><span class="line"><span class="function"><span class="params">PersistableBundle outPersistentState)</span> </span>&#123;</span><br><span class="line">activity.performSaveInstanceState(outState, outPersistentState);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>回到Activity中：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">performSaveInstanceState</span><span class="params">(Bundle outState)</span> </span>&#123;</span><br><span class="line">onSaveInstanceState(outState);</span><br><span class="line">saveManagedDialogs(outState);</span><br><span class="line">mActivityTransitionState.saveState(outState);</span><br><span class="line">storeHasCurrentPermissionRequest(outState);</span><br><span class="line"><span class="keyword">if</span> (DEBUG_LIFECYCLE) Slog.v(TAG, <span class="string">"onSaveInstanceState "</span> + <span class="keyword">this</span> + <span class="string">": "</span> + outState);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>onSaveInstanceState(outState);就是在这里被调起来的，<br>所以通常问onSaveInstanceState在什么时机被调起，就是onstop之前。<br>至此，所有的activity启动流程我们都分析完成了。<br>下面总结一下：</p>
<ol>
<li>Activity启动涉及到多个进程之间的通讯，这里主要是ActivityThead和ActivityManagerService之间的通讯</li>
<li>ActivityThread向ActivityManagerService进程间消息通过ActivityManagerNative，ActivityManagerService向ActivityThread进程间传递消息通过IApplicationThread</li>
<li>ActivityManagerService保存完信息之后会将系统栈顶的activity执行onPause操作，并且IApplication进程间通讯告诉应用程序执行当前栈顶Activity的onPause方法。</li>
<li>ActivityThead接收到SystemServer的消息后会统一交给自身定义的Handler对象处理；</li>
<li>ActivityManagerService将执行创建Activity的通知告知ActivityTHread，通过反射机制创建出Activity对象，并执行Activity的oncreate方法，onstart方法，onresume方法。</li>
<li>ActivityThread执行完成onresume方法后告知ActivityManagerServise onresume方法完成，执行栈顶的onstop方法。</li>
</ol>
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/源码解析/" rel="tag"># 源码解析</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/01/12/Android-项目构建过程/" rel="next" title="Android 项目构建过程">
                <i class="fa fa-chevron-left"></i> Android 项目构建过程
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/01/19/RemoteViews一-仿qq音乐自定义通知栏实现快捷切换歌曲/" rel="prev" title="RemoteViews一 仿qq音乐自定义通知栏实现快捷切换歌曲">
                RemoteViews一 仿qq音乐自定义通知栏实现快捷切换歌曲 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="http://opq81riyh.bkt.clouddn.com/666.jpg" alt="吴晓龙">
            
              <p class="site-author-name" itemprop="name">吴晓龙</p>
              <p class="site-description motion-element" itemprop="description">耐得住寂寞 守得住繁华</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">10</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/lantier743865" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-globe"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://weibo.com/3166661920/profile?topnav=1&wvr=6" target="_blank" title="微博">
                      
                        <i class="fa fa-fw fa-globe"></i>微博</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://juejin.im/user/58c9e40b61ff4b006c808011" target="_blank" title="掘金">
                      
                        <i class="fa fa-fw fa-globe"></i>掘金</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.jianshu.com/u/218df555dee7" target="_blank" title="简书">
                      
                        <i class="fa fa-fw fa-globe"></i>简书</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#基于8-0源码解析：Activity启动流程"><span class="nav-number">1.</span> <span class="nav-text">基于8.0源码解析：Activity启动流程</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">吴晓龙</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>